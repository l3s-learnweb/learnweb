<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
				xmlns:ui="jakarta.faces.facelets"
				xmlns:h="jakarta.faces.html"
				xmlns:f="jakarta.faces.core"
				xmlns:p="http://primefaces.org/ui"
				xmlns:o="http://omnifaces.org/ui"
				xmlns:lw="http://l3s.de/learnweb">

<ui:param name="pageTitle" value="#{msg.tedTranscriptTitle}"/>
<ui:param name="helpText" value="#{msg.tedTranscriptHelp}"/>

<ui:define name="metadata">
	<f:metadata>
		<f:viewParam name="resource_id" value ="#{tedTranscriptBean.resourceId}" required="true"/>
		<f:viewAction action="#{tedTranscriptBean.onLoad}"/>
		<o:viewParamValidationFailed sendError="400" message="#{null}"/>
	</f:metadata>
</ui:define>

<ui:define name="breadcrumb">
	<lw:breadcrumb-item link="ted_transcript.jsf" title="#{msg.tedTranscriptTitle}">
		<ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_first.xhtml"/>
	</lw:breadcrumb-item>
</ui:define>

<ui:define name="center_layout">
	<h:form styleClass="d-none">
		<p:remoteCommand name="commandSaveLog" actionListener="${resourceAnnotationBean.commandLogAnnotation(tedTranscriptBean.tedResource)}" immediate="true" process="@this" update="@none"/>
		<p:remoteCommand name="commandSaveResource" actionListener="${resourceAnnotationBean.commandSaveAnnotation(tedTranscriptBean.tedResource)}" immediate="true" process="@this"/>
		<p:remoteCommand name="commandSubmitResource" actionListener="${tedTranscriptBean.commandSubmitResource()}" immediate="true" process="@this" update=":transcript_column"/>
		<p:remoteCommand name="commandGetDefinition" actionListener="${resourceAnnotationBean.commandGetDefinition()}" immediate="true" process="@this" oncomplete="annotator.saveDefinition(xhr,status,args);" async="false"/>
	</h:form>

	<h:outputStylesheet name="bundle/pickr.min.css"/>
	<h:outputScript name="bundle/pickr.min.js" target="body"/>
	<h:outputScript name="bundle/jquery.contextMenu.min.js" target="body"/>
	<h:outputScript name="learnweb/js/lib/annotator.js" target="body"/>

	<div class="row">
		<h:panelGroup layout="block" id="embedded_column" styleClass="col-md">
			<div class="ratio ratio-4x3 sticky-md-top">
				<h:outputText value="${tedTranscriptBean.tedResource.embeddedCode}" escape="false"/>
			</div>
		</h:panelGroup>
		<h:panelGroup layout="block" id="transcript_column" styleClass="col-md">
			<h:form styleClass="p-2 bg-light">
				<p:outputLabel for="@next" styleClass="me-2" value="#{msg.select_transcript_lang}:"/>
				<p:selectOneMenu styleClass="me-2" value="#{tedTranscriptBean.transcriptLanguage}">
					<f:selectItems value="#{tedTranscriptBean.getLanguageList()}"/>
					<p:ajax listener="#{tedTranscriptBean.setTranscript}" update=":transcript" oncomplete="annotator.clearTagList();"/>
				</p:selectOneMenu>

				<p:commandButton styleClass="me-2" value="#{msg.save}" onclick="annotator.saveAnnotatedText();" rendered="#{tedTranscriptBean.tedResource.canEditResource(userBean.user)}" disabled="#{tedTranscriptBean.tedResource.readOnlyTranscript}"/>
				<p:tooltip for="@previous" value="#{msg.save_tooltip}" position="left"/>
				<p:commandButton value="#{msg.submit}" styleClass="me-2" onclick="annotator.submitTranscript();" rendered="#{tedTranscriptBean.tedResource.canEditResource(userBean.user)}" disabled="#{tedTranscriptBean.tedResource.readOnlyTranscript}"/>
				<p:tooltip for="@previous" value="#{msg.submit_tooltip}" position="left"/>

				<p:menuButton value="#{msg.options}" iconPos="right" rendered="#{tedTranscriptBean.tedResource.canEditResource(userBean.user)}">
					<p:menuitem value="#{msg.show_summary}" icon="fas fa-circle-chevron-left" onclick="annotator.openTagsDiv(1);"/>
					<p:menuitem value="#{msg.show_tags}" icon="fas fa-circle-chevron-left" onclick="annotator.openTagsDiv(0);"/>
					<p:menuitem value="#{msg.disable_editing}" icon="fas fa-pencil" rendered="#{!tedTranscriptBean.tedResource.readOnlyTranscript and userBean.moderator}" update=":transcript_column">
						<f:setPropertyActionListener value="true" target="#{tedTranscriptBean.tedResource.readOnlyTranscript}"/>
					</p:menuitem>
					<p:menuitem value="#{msg.enable_editing}" icon="fas fa-pencil" rendered="#{tedTranscriptBean.tedResource.readOnlyTranscript and userBean.moderator}" update=":transcript_column">
						<f:setPropertyActionListener value="false" target="#{tedTranscriptBean.tedResource.readOnlyTranscript}"/>
					</p:menuitem>
				</p:menuButton>
			</h:form>

			<div class="border border-dark my-2 p-2">
				<strong>#{msg['ted_transcript.owner_of_transcript']}: </strong><h:outputText value="#{tedTranscriptBean.tedResource.user.username}"/><br/>
				<strong>#{msg.note}:</strong> <h:outputText value="#{msg.transcript_warning}" rendered="${!tedTranscriptBean.tedResource.canEditResource(userBean.user)}"/>
				<h:outputText value="#{msg.transcript_submit_message}" rendered="#{tedTranscriptBean.tedResource.readOnlyTranscript}" styleClass="text-danger"/>
				<h:outputText value="#{msg.transcript_note}" rendered="${tedTranscriptBean.tedResource.canEditResource(userBean.user) and !tedTranscriptBean.tedResource.readOnlyTranscript}"/>
			</div>

			<h:panelGroup layout="block" id="transcript" styleClass="tran-selection my-3 p-3 border border-dark">
				<h:outputText value="#{tedTranscriptBean.tedResource.transcript}" escape="false"/>
			</h:panelGroup>
		</h:panelGroup>
	</div>

	<p:outputPanel styleClass="bg-light tran-tabs-overlay">
		<div class="d-flex justify-content-end my-1">
			<a onclick="annotator.closeTagsDiv(); return false;" href="">
				<i class="fas fa-times me-1" aria-hidden="true"></i>
			</a>
		</div>
		<h:form>
			<p:tabView widgetVar="transcriptTabView" styleClass="ui-tabs-full-width ui-tabs-fluid bg-light">
				<p:tab title="#{msg.tags}">
					<ol id="selectable" class="tran-tabs-selectable"></ol>
				</p:tab>
				<p:tab title="#{msg.summary}">
					<div class="d-flex justify-content-between flex-column">
						<div class="text-center mb-3">
							<p:outputLabel for="@next" styleClass="m-0" value="#{msg.brief_summary}"/>
							<p:inputTextarea id="textarea_s" counter="char_s" styleClass="w-100" maxlength="600" counterTemplate="#{msg.remaining_characters}" autoResize="false" value="#{tedTranscriptBean.summaryTextS}"/>
							<h:outputText id="char_s"/>
							<p:commandButton value="#{msg.submit}" action="#{tedTranscriptBean.submitShortSummary()}"/>
						</div>
						<div class="text-center mb-3">
							<p:outputLabel for="@next" styleClass="m-0" value="#{msg.long_summary}"/>
							<p:inputTextarea id="textarea_m" counter="char_m" styleClass="w-100" maxlength="1500" counterTemplate="#{msg.remaining_characters}" autoResize="false" value="#{tedTranscriptBean.summaryTextM}"/>
							<h:outputText id="char_m"/>
							<p:commandButton value="#{msg.submit}" action="#{tedTranscriptBean.submitLongSummary()}"/>
						</div>
						<div class="text-center mb-3">
							<p:outputLabel for="@next" styleClass="m-0" value="#{msg.detailed_summary}"/>
							<p:inputTextarea id="textarea_l" counter="char_l" styleClass="w-100" maxlength="2500" counterTemplate="#{msg.remaining_characters}" autoResize="false" value="#{tedTranscriptBean.summaryTextL}"/>
							<h:outputText id="char_l"/>
							<p:commandButton value="#{msg.submit}" action="#{tedTranscriptBean.submitDetailedSummary()}"/>
						</div>
					</div>
				</p:tab>
			</p:tabView>
		</h:form>
	</p:outputPanel>

	<p:dialog widgetVar="updateNote" header="#{msg.userAnnotation}" appendTo="@(body)"
			  modal="true" resizable="false" resizeObserver="true" resizeObserverCenter="true" draggable="false"
			  dynamic="true" draggable="false" responsive="true" closeOnEscape="true">
		<h:form id="update_note_form" prependId="false" styleClass="d-flex flex-column">
			<p:outputLabel for="@next" value="#{msg.justify_selection}:"/>
			<p:inputText/>

			<div class="d-flex flex-row-reverse mt-2">
				<p:commandButton value="#{msg['save']}" onclick="annotator.saveAnnotation(); return false;"/>
				<p:commandButton styleClass="secondary-btn" value="#{msg.cancel}" onclick="annotator.cancelAnnotation(); return false;"/>
			</div>
		</h:form>
	</p:dialog>

	<h:outputScript target="body">
		const annotator = new Annotator('#transcript', {
		readOnly: '#{!tedTranscriptBean.tedResource.canEditResource(userBean.user) or tedTranscriptBean.tedResource.readOnlyTranscript}' === 'true',
			lastNoteId: parseInt('#{tedTranscriptBean.noteId}', 10),
			editNoteFormSelector: '#update_note_form',
			tabsOverlaySelector: '.tran-tabs-overlay',
			noteContextMenu: [
				{ action: 'add-annotation', icon: 'fa-plus', name: '#{msg.add_annotation}' },
				{ action: 'edit-annotation', icon: 'fa-pencil-alt', name: '#{msg.edit_annotation}' },
				{ action: 'delete-annotation', icon: 'fa-minus', name: '#{msg.delete_annotation}' },
				{ action: 'add-wordnet-definition', icon: 'fa-language', name: '#{msg.add_wordnet_definition}' },
				{ action: 'delete-selection', icon: 'fa-trash', name: '#{msg.delete_selection}' },
				{ action: 'colorpicker', icon: 'fa-folder', name: '#{msg.color}' }
			]
		});
	</h:outputScript>
</ui:define>

</ui:composition>
