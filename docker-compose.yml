services:
  webapp:
    image: tomcat:10.1-jdk17
    restart: always
    volumes:
      - "./target/Learnweb.war:/usr/local/tomcat/webapps/ROOT.war"
      - "./data/files:/mnt/files"
    ports:
      - "7010:8080"
    depends_on:
      - mariadb
      - solr
      - fuseki
    environment:
      TZ: "Europe/Berlin"
      LEARNWEB_FILE_MANAGER_FOLDER: "/mnt/files"
      LEARNWEB_DATASOURCE_URL: "jdbc:mariadb://mariadb:3306/${DATASOURCE_DATABASE}"
      LEARNWEB_DATASOURCE_USERNAME: ${DATASOURCE_USERNAME}
      LEARNWEB_DATASOURCE_PASSWORD: ${DATASOURCE_PASSWORD}
      LEARNWEB_SOLR_SERVER_URL: "http://solr:8983/solr/learnweb"
    env_file:
      - .env.override
  mariadb:
    image: mariadb:10.11
    restart: always
    ports:
      - "7006:3306"
    volumes:
      - "./data/mariadb:/var/lib/mysql"
    environment:
      TZ: "Europe/Berlin"
      MARIADB_AUTO_UPGRADE: "yes"
      MARIADB_RANDOM_ROOT_PASSWORD: "yes"
      MARIADB_DATABASE: ${DATASOURCE_DATABASE}
      MARIADB_USER: ${DATASOURCE_USERNAME}
      MARIADB_PASSWORD: ${DATASOURCE_PASSWORD}
    env_file:
      - .env.override
  solr:
    image: solr:9
    restart: always
    ports:
      - "7003:8983"
    volumes:
      - "./src/main/conf/solr-setup.sh:/solr-setup.sh:ro"
      - "./data/solr:/var/solr"
    command: bash -e -c "precreate-core learnweb && source /solr-setup.sh && solr-foreground"
  fuseki:
    image: secoresearch/fuseki:latest
    restart: always
    ports:
      - "7005:3030"
    volumes:
      - "./data/fuseki/db:/fuseki-base/databases"
      - "./data/fuseki/conf:/fuseki-base/configuration"
    environment:
      ADMIN_PASSWORD: ${FUSEKI_PASSWORD}
      ENABLE_DATA_WRITE: "true"
      ENABLE_UPDATE: "true"
      ENABLE_SHACL: "true"
    env_file:
      - .env.override
