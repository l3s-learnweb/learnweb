<ui:composition template="/templates/main.xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets" 
	xmlns:h="http://java.sun.com/jsf/html" 
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui" 
	lang="#{userBean.localeCode}">

	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="query" value="#{searchBean.query}" />
			<f:viewParam name="action" value="#{searchBean.action}" />
			<f:viewParam name="resultsetid" value="#{searchBean.resultsetId}" />
			<f:viewParam name="selectedquerytimestamp" value="#{searchHistoryBean.selectedQueryTimestamp}"/>
			<f:event type="preRenderView" listener="#{searchBean.preRenderView}" />
		</f:metadata>
	</ui:define>

	<ui:param name="pageTitle" value="#{msg.searchTitle}" />	
	<ui:param name="helpText" value="#{msg.searchHelp}"/>
	 
	<ui:define name="options_panel">
	
		<div class="options_panel">  
			<h:panelGroup id="returnlink" rendered="#{userBean.loggedIn and userBean.user.activeGroupId != 0}">
				<h:outputLink value="group/overview.jsf" styleClass="returnlink_link" style="color:white;">
        		  Go back to <i>#{userBean.user.activeGroup.title}</i>
					<f:param name="group_id" value="#{userBean.user.activeGroup.id}"></f:param>
				</h:outputLink>
			</h:panelGroup>
					
			<h:form id="optform">
				<h:outputText value="Web" styleClass="optform_text"
					rendered="#{searchBean.searchMode == 'web'}" />
				<h:link value="Web" outcome="search"
					styleClass="optform_link"
					rendered="#{searchBean.searchMode != 'web'}" >
					<f:param name="action" value="web" />
					<f:param name="query" value="#{searchBean.query}" />								
				</h:link>			

				<h:outputText value="#{msg.Images}"
					styleClass="optform_text"
					rendered="#{searchBean.searchMode == 'image'}" />
				<h:link value="#{msg.Images}" outcome="search"
					styleClass="optform_link"
					rendered="#{searchBean.searchMode != 'image'}" >
					<f:param name="action" value="image" />
					<f:param name="query" value="#{searchBean.query}" />
				</h:link>

				<h:outputText value="#{msg.Videos}"
					styleClass="optform_text"
					rendered="#{searchBean.searchMode == 'video'}" />
				<h:link value="#{msg.Videos}" outcome="search"
					styleClass="optform_link"
					rendered="#{searchBean.searchMode != 'video'}" >
					<f:param name="action" value="video" />
					<f:param name="query" value="#{searchBean.query}" />
				</h:link>

				

<!-- 
        <link rel="stylesheet" type="text/css" href="#{learnwebBean.baseUrl}../resources/css/jquery.dropdown.css" />

		<h:outputScript library="js" name="jquery.dropdown.min.js" target="head"/>
			
		<a href="#" data-dropdown="#dropdown-1">dropdown</a>
			 -->
			

	
				<h:panelGroup rendered="#{userBean.searchHistoryEnabled}">
					<span style="float:right;padding-right:5px;"><h:panelGroup styleClass="search_history"><p:commandButton  id="search_history_tools" value="Search History Tools" type="button" icon="ui-icon-triangle-1-s"/></h:panelGroup></span>
					<p:menu overlay="true" trigger="search_history_tools" my="left top"
						at="left bottom">
						<p:submenu label="Search History">
							<p:menuitem value="Show" icon=" ui-icon-arrowstop-1-w" onclick="open_searchbar();" />
							<p:menuitem value="Hide" icon="ui-icon-arrowstop-1-e" onclick="close_searchbar();"/>
						</p:submenu>
						<p:submenu label="Explore History">
							<p:menuitem value="List View" icon="ui-icon-search" outcome="explore">
								<f:param name="mode" value="list_view" />
								<f:param name="page" value="1" />
							</p:menuitem>
						</p:submenu>
					</p:menu>
				</h:panelGroup>
			</h:form>
		</div>	
	</ui:define>
		
		
	<ui:define name="bottom_panel">
		<div id="dropdown-1" class="dropdown dropdown-tip">
		    <ul class="dropdown-menu">
		        <li><a href="#1">Item 1</a></li>
		        <li><a href="#2">Item 2</a></li>
		        <li><a href="#3">Item 3</a></li>
		        <li class="dropdown-divider"></li>
		        <li><a href="#4">Item 4</a></li>
		        <li><a href="#5">Item 5</a></li>
		        <li><a href="#5">Item 6</a></li>
		    </ul>
		</div>
	</ui:define>

		
	<ui:define name="center_layout">
		<h:outputStylesheet library="search" name="search.css"  />		
		<h:outputScript library="search" name="search.js" target="head"/>

		<script type="text/javascript">
			var view = '#{searchBean.view}';
			var userId = '#{userBean.user.id}';
			var searchHistoryEnabled = #{userBean.searchHistoryEnabled};
		</script>			
		 
		<ui:decorate template="/lw/templates/resource_lightbox.xhtml"></ui:decorate> 	

		<div id="results" class="#{searchBean.view}_view">			
			<div class="resources">
				<ui:decorate  template="/lw/templates/resources.xhtml">
					<ui:param name="resources" value="#{searchBean.search.resources}" />
					<ui:param name="view" value="#{searchBean.view}" />					
				</ui:decorate>
			</div>	
			<div class="clear"></div>
		</div>		
		
		<h:panelGroup id="factsheet" rendered="#{!userBean.searchHistoryEnabled}">
			<ui:fragment rendered="${searchBean.graphLoaded}">
				<ui:decorate template="/lw/templates/fact_sheet.xhtml"></ui:decorate>		
			</ui:fragment>		
		</h:panelGroup>

		<h:panelGroup layout="block" id="search_right_bar" class="right_bar" rendered="#{userBean.searchHistoryEnabled}">
			<p:outputPanel autoUpdate="true">
				<p:tabView scrollable="true" id="tabView" widgetVar="tabViewer" activeIndex="#{searchHistoryBean.selectedTab}">
					<p:tab id="tab1" title="Fact Sheet"	rendered="${searchBean.graphLoaded}" >
						<ui:fragment>
							<ui:decorate template="/lw/templates/fact_sheet.xhtml"></ui:decorate>
						</ui:fragment>
					</p:tab>

					<p:tab id="tab2" title="Current Search">
						<ui:decorate template="/lw/templates/current_search.xhtml">
							<ui:param name="currentSearchBean" value="#{searchHistoryBean}"/>
							<ui:param name="searchType" value="#{searchBean.view}"/>
						</ui:decorate>
					</p:tab>
					
					<p:tab id="tab3" title="Similar Queries">
						<ui:decorate template="/lw/templates/query_history.xhtml">
							<ui:param name="queryHistorybydate"
								value="#{searchHistoryBean.queryHistory}" />
						</ui:decorate>
					</p:tab>
				</p:tabView>
			</p:outputPanel>
		</h:panelGroup>		

		<div id="search_loading_more_results">#{msg.loading_more_results} <p:graphicImage value="/resources/icon/ajax-loader.gif" /></div>
		<div id="search_no_more_results">#{msg.no_more_results}</div>
		<div id="search_nothing_found">#{msg.nothingFound}</div>

		<div id="new_results" style="display:none;">	
			<h:panelGroup id="nextPage" layout="block">				
				<ui:decorate  template="/lw/templates/resources_#{searchBean.view}.xhtml">
					<ui:param name="resources" value="#{searchBean.nextPage}" />
				</ui:decorate>		
			</h:panelGroup>
		</div>
	
		<h:form style="display:none;">	
			<p:remoteCommand actionListener="${searchBean.loadNextPage()}" update=":nextPage" name="ajaxLoadNextPage" oncomplete="displayNextPage(xhr, status, args);" />
			<p:remoteCommand actionListener="${searchBean.generateKnowledgeGraph()}" update=":factsheet" name="ajaxLoadFactsheet" async="true" />
			<p:remoteCommand actionListener="${searchBean.setSelectedResource()}" name="setSelectedResource" update=":resource_form" />
		  	<p:remoteCommand actionListener="${searchHistoryBean.updateSearchHistory()}"  update=":tabView:tab3" name="ajaxLoadSearchHistory" />
			<p:remoteCommand update=":tabView:tab2" name="updatecurrentsearch" />		  				
			<p:remoteCommand actionListener="${searchBean.logResourceOpened()}" name="logResourceOpened" async="true" />
			<p:remoteCommand actionListener="${searchBean.logEndTime()}" name="logEndTime" async="false" oncomplete="updatecurrentsearch();"/>
		</h:form>
 
		<p:dialog header="#{msg.options}" widgetVar="resource_dialog" modal="false" minWidth="600" resizable="false" style="z-index:1500;">			
			<h:form id="resource_form">
				<h:panelGrid columns="2" rendered="#{userBean.loggedIn}" style="width:100%;">
					<h:outputText value="#{msg.add_to}:"/>
					<h:selectOneMenu value="#{searchBean.selectedResourceTargetGroupId}">
						<f:selectItem itemLabel="#{msg.myResourcesTitle}" itemValue="0" />
						<f:selectItem itemLabel="------------" itemValue="-1" itemDisabled="true" />	
						<f:selectItems var="group" value="#{userBean.user.writeAbleGroups}" itemLabel="#{group.title}" itemValue="#{group.id}"/>
					</h:selectOneMenu>
					
					<h:outputLabel value="#{msg.title}:" for="title"/>
					<p:inputText value="#{searchBean.selectedResource.title}" id="title" style="width:100%;"/>					
					
					<h:outputLabel value="#{msg.description}:" for="description"/>
					<p:inputTextarea  value="#{searchBean.selectedResource.description}" id="description" autoResize="true"  style="width:100%;"/>
					
					<h:outputText value="Url:" for="url"/>
					<h:outputText value="#{searchBean.selectedResource.url}" style="width:400px; padding:4px;" />
					
					<h:outputText value="#{msg.type}:"/>
					<h:outputText value="#{searchBean.selectedResource.type}" style="width:400px; padding:4px;" />
					
					<h:outputText value="#{msg.source}:"/>
					<h:outputText value="#{searchBean.selectedResource.source}" style="width:400px; padding:4px;" />
					  
					<h:outputText value="" />
					<p:commandButton value="#{msg.save}" action="#{searchBean.addSelectedResource}" process="@form" update=":returnlink :growl" oncomplete="resource_dialog.hide()"/>
				</h:panelGrid>			
			</h:form> 			
		</p:dialog>
		
		
	</ui:define>
	
</ui:composition>