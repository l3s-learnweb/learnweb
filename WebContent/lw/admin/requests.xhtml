<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
				xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
				xmlns:h="http://xmlns.jcp.org/jsf/html"
				xmlns:f="http://xmlns.jcp.org/jsf/core"
				xmlns:p="http://primefaces.org/ui"
				xmlns:lw="http://l3s.de/learnweb">

<ui:param name="pageTitle" value="#{msg.requests_header}"/>

<ui:define name="breadcrumb">
	<ui:fragment rendered="#{userBean.admin}">
		<lw:breadcrumb-item link="admin.jsf" title="#{msg.admin}">
			<ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_first.xhtml"/>
		</lw:breadcrumb-item>

		<lw:breadcrumb-item link="admin/requests.jsf" title="#{msg.ip_requests}">
			<ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_admin.xhtml"/>
		</lw:breadcrumb-item>
	</ui:fragment>
</ui:define>

<ui:define name="center_layout">
	<p:panel rendered="#{not userBean.admin}">
		<h:outputText value="#{msg.missing_authentication}"/>
	</p:panel>

	<p:tabView rendered="#{userBean.admin}" styleClass="ui-tabs-transparent">
		<p:tab title="#{msg.requests}">
			<h:form id="requestform">
				<p:dataTable paginatorPosition="bottom" var="reqData" value="#{adminRequestListBean.requests}" filteredValue="#{adminRequestListBean.filteredRequests}" rows="100" paginator="true"
					   paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
					   currentPageReportTemplate="(Displaying {startRecord} - {endRecord} of {totalRecords})">
					<p:column headerText="IP" sortBy="#{reqData.IP}" filterBy="#{reqData.IP}" filterMatchMode="contains">
						<h:outputText value="#{reqData.IP}"/>
					</p:column>

					<p:column headerText="#{msg.time}" sortBy="#{reqData.time}" filterBy="#{reqData.time}" filterFunction="#{adminRequestListBean.filterByDate}">
						<h:outputText value="#{reqData.time}">
							<f:convertDateTime timeZone="#{userBean.timeZone}" type="both"/>
						</h:outputText>
					</p:column>

					<p:column headerText="URL" sortBy="#{reqData.URL}" filterBy="#{reqData.URL}" filterMatchMode="contains">
						<h:outputText value="#{reqData.URL}"/>
					</p:column>
				</p:dataTable>
			</h:form>
		</p:tab>

		<p:tab title="#{msg.logins}">
			<h:form id="loginform">
				<p:dataTable var="login" paginatorPosition="bottom" value="#{adminRequestListBean.logins}" filteredValue="#{adminRequestListBean.filteredLogins}" rows="100" paginator="true"
					   paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
					   currentPageReportTemplate="(Displaying {startRecord} - {endRecord} of {totalRecords})">
					<p:column headerText="IP" sortBy="#{login.key}" filterBy="#{login.key}" filterMatchMode="contains">
						<h:outputText value="#{login.key}"/>
					</p:column>

					<p:column headerText="#{msg.logins_amount}" sortBy="#{login.value.size()}" filterBy="#{login.value.size()}" filterMatchMode="contains">
						<h:outputText value="#{login.value.size()}"/>
					</p:column>

					<p:column headerText="#{msg.request_usernames}" sortBy="#{login.value.toString()}" filterBy="#{login.value.toString()}" filterMatchMode="contains">
						<h:outputText value="#{login.value.toString()}"/>
					</p:column>
				</p:dataTable>
			</h:form>
		</p:tab>

		<p:tab title="#{msg.aggr_requests}">
			<h:form id="aggrrequestform">
				<p:blockUI block="requestsTable" widgetVar="requestsTableOverlay">
					<h:outputText value="#{msg.please_wait}"/>
				</p:blockUI>
				<span>
					#{msg.aggr_request_updated}:   <h:outputText value="#{adminRequestListBean.aggrRequestsUpdated}">
													<f:convertDateTime timeZone="#{userBean.timeZone}" type="both"/>
													</h:outputText>
					<p:commandButton onstart="PF('requestsTableOverlay').show()" oncomplete="PF('requestsTableOverlay').hide()" action="${adminRequestListBean.onUpdateAggregatedRequests}" global="false" value="#{msg.update}" styleClass="ml-3" immediate="true"/>
				</span>
				<p:dataTable id="requestsTable" tableStyleClass="mt-3" var="aRequest" paginatorPosition="bottom" value="#{adminRequestListBean.aggregatedRequests}" filteredValue="#{adminRequestListBean.filteredAggregatedRequests}" rows="50" paginator="true"
					  paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">
					<p:column headerText="IP" sortBy="#{aRequest.IP}" filterBy="#{aRequest.IP}" filterMatchMode="contains">
						<h:outputText value="#{aRequest.IP}"/>
					</p:column>

					<p:column headerText="#{msg.requests_count}" sortBy="#{aRequest.requests}" filterBy="#{aRequest.requests}" filterMatchMode="contains">
						<h:outputText value="#{aRequest.requests}"/>
					</p:column>

					<p:column headerText="#{msg.logins_amount}" sortBy="#{aRequest.loginCount}" filterBy="#{aRequest.loginCount}" filterMatchMode="contains">
						<h:outputText value="#{aRequest.loginCount}"/>
					</p:column>

					<p:column headerText="#{msg.request_usernames}" sortBy="#{aRequest.usernames}" filterBy="#{aRequest.usernames}" filterMatchMode="contains">
						<h:outputText value="#{aRequest.usernames}"/>
					</p:column>

					<p:column headerText="#{msg.time_stamp}" sortBy="#{aRequest.time}" filterBy="#{aRequest.time}" filterFunction="#{adminRequestListBean.filterByDate}">
						<h:outputText value="#{aRequest.time}">
							<f:convertDateTime timeZone="#{userBean.timeZone}" type="both"/>
						</h:outputText>
					</p:column>
				</p:dataTable>
			</h:form>
		</p:tab>
	</p:tabView>
</ui:define>

</ui:composition>
