<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:lw="http://l3s.de/learnweb">

<ui:param name="pageTitle" value="#{msg.banlist_header}"/>
<ui:param name="hasAccessPermission" value="#{userBean.admin}"/>

<ui:define name="breadcrumb">
    <lw:breadcrumb-item link="admin.jsf" title="#{msg.admin}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_first.xhtml"/>
    </lw:breadcrumb-item>

    <lw:breadcrumb-item link="admin/banlist.jsf" title="#{msg.banlist}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_admin.xhtml"/>
    </lw:breadcrumb-item>
</ui:define>

<ui:define name="center_layout" >
    <div class="row">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
            <p:panel header="#{msg.manual_ban}">
                <h:form id="banformreg">
                    <div class="form-group">
                        <p:outputLabel for="@next" value="#{msg.name_or_ip}:"/>
                        <p:inputText value="#{adminBanlistBean.name}" id="name" required="true"/>
                        <p:message for="@previous"/>
                        <p:selectOneRadio value="#{adminBanlistBean.type}" id="type" styleClass="mt-3" required="true">
                            <f:selectItem itemValue="user" itemLabel="User"/>
                            <f:selectItem itemValue="ip" itemLabel="IP"/>
                        </p:selectOneRadio>
                        <p:message for="@previous"/>
                    </div>

                    <div class="form-group">
                        <p:outputLabel for="@next" value="#{msg.ban_for}:"/>
                        <div class="mb-3">
                            <p:inputText value="#{adminBanlistBean.banDays}" required="false" pt:placeholder="Days" class="mr-3 mb-3 mb-sm-0"/>
                            <p:message for="@previous"/>
                            <p:inputText value="#{adminBanlistBean.banHours}" required="false" pt:placeholder="Hours" class="mr-3 mb-3 mb-sm-0"/>
                            <p:message for="@previous"/>
                            <p:inputText value="#{adminBanlistBean.banMinutes}" required="false" pt:placeholder="Mins"/>
                            <p:message for="@previous"/>
                        </div>
                        <p:selectBooleanCheckbox value="#{adminBanlistBean.permaban}" itemLabel="#{msg.permaban}" id="permabancheckbox"/>
                    </div>

                    <p:commandButton global="false" onstart="PF('banlistformOverlay').show()" oncomplete="PF('banlistformOverlay').hide()" update=":banlistform" action="${adminBanlistBean.onManualBan}" value="#{msg.manual_ban}" process="@form"/>
                </h:form>
            </p:panel>
        </div>
    </div>

    <h:form id="banlistform">
        <p:blockUI block="banlistform" widgetVar="banlistformOverlay">
            <h:outputText value="#{msg.please_wait}"/>
        </p:blockUI>

        <p:dataTable var="accessData" paginatorPosition="bottom" value="#{adminBanlistBean.banlist}" rows="50" paginator="true"
                     paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">
            <p:column headerText="#{msg.name}" sortBy="#{accessData.name}">
                <h:outputText value="#{accessData.name}"/>
            </p:column>

            <p:column headerText="#{msg.bandate}" sortBy="#{accessData.banDate}">
                <h:outputText value="#{accessData.banDate}">
                    <f:convertDateTime timeZone="#{userBean.timeZone}" type="both"/>
                </h:outputText>
            </p:column>

            <p:column headerText="#{msg.bannedon}" sortBy="#{accessData.bannedOn}">
                <h:outputText value="#{accessData.bannedOn}">
                    <f:convertDateTime timeZone="#{userBean.timeZone}" type="both"/>
                </h:outputText>
            </p:column>

            <p:column headerText="#{msg.attempts}" sortBy="#{accessData.attempts}">
                <h:outputText value="#{accessData.attempts}"/>
            </p:column>

            <p:column headerText="#{msg.options}" styleClass="td-text-right">
                <p:commandLink onstart="PF('banlistformOverlay').show()" oncomplete="PF('banlistformOverlay').hide()" actionListener="#{adminBanlistBean.onUnban(accessData.name)}" process="@this"
                               update=":banlistform :growl" styleClass="icon-link"
                               title="#{msg.unban}" global="false">
                    <i class="fa fa-fw fa-ban text-danger" aria-hidden="true"></i>
                    <h:outputText value="#{msg.unban}"/>
                    <p:confirm message="#{msg.unban} #{accessData.name}?"/>
                </p:commandLink>
            </p:column>
        </p:dataTable>
    </h:form>

    <p:panel header="#{msg.suspicious_activity}" styleClass="mt-3" rendered="#{not empty adminBanlistBean.suspiciousActivityList}">
        <p>#{msg.suspicious_activity_message}</p>

        <p:dialog header="Ban" widgetVar="bandialog" modal="true" height="100">
            <h:form class="banform" id="banformdialog">
                <div class="form-group">
                    <p:outputLabel for="@next" value="#{msg.name_or_ip}:"/>
                    <p:inputText value="#{adminBanlistBean.name}" id="name" required="true"/>
                    <p:message for="@previous"/>
                    <p:selectOneRadio value="#{adminBanlistBean.type}" id="type" styleClass="mt-3" required="true">
                        <f:selectItem itemValue="user" itemLabel="User"/>
                        <f:selectItem itemValue="ip" itemLabel="IP"/>
                    </p:selectOneRadio>
                    <p:message for="@previous"/>
                </div>

                <div class="form-group">
                    <p:outputLabel for="@next" value="#{msg.ban_for}:"/>
                    <div class="mb-3">
                        <p:inputText value="#{adminBanlistBean.banDays}" required="false" pt:placeholder="Days" class="mr-3 mb-3 mb-sm-0"/>
                        <p:message for="@previous"/>
                        <p:inputText value="#{adminBanlistBean.banHours}" required="false" pt:placeholder="Hours" class="mr-3 mb-3 mb-sm-0"/>
                        <p:message for="@previous"/>
                        <p:inputText value="#{adminBanlistBean.banMinutes}" required="false" pt:placeholder="Mins"/>
                        <p:message for="@previous"/>
                    </div>
                    <p:selectBooleanCheckbox value="#{adminBanlistBean.permaban}" itemLabel="#{msg.permaban}" id="permabancheckbox"/>
                </div>

                <p:commandButton action="${adminBanlistBean.onManualBan}" value="#{msg.manual_ban}" process="@form"/>
            </h:form>
        </p:dialog>

        <h:form id="suspiciouslistform">
            <p:dataTable  paginatorPosition="bottom" var="aggrReqData" value="#{adminBanlistBean.suspiciousActivityList}" rows="50" paginator="true"
                         paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">
                <p:column headerText="IP" sortBy="#{aggrReqData.IP}">
                    <h:outputText value="#{aggrReqData.IP}"/>
                </p:column>

                <p:column headerText="#{msg.requests_count}" sortBy="#{aggrReqData.requests}">
                    <h:outputText value="#{aggrReqData.requests}"/>
                </p:column>

                <p:column headerText="#{msg.logins_amount}" sortBy="#{aggrReqData.loginCount}">
                    <h:outputText value="#{aggrReqData.loginCount}"/>
                </p:column>

                <p:column headerText="#{msg.request_usernames}" sortBy="#{aggrReqData.usernames}">
                    <h:outputText value="#{aggrReqData.usernames}"/>
                </p:column>

                <p:column headerText="#{msg.time_stamp}" sortBy="#{aggrReqData.time}">
                    <h:outputText value="#{aggrReqData.time}">
                        <f:convertDateTime timeZone="#{userBean.timeZone}" type="both"/>
                    </h:outputText>
                </p:column>

                <p:column headerText="#{msg.options}" styleClass="td-text-right">
                    <p:commandLink onclick="PF('bandialog').show(); setname('#{entry.IP}')" process="@this"
                        update=":suspiciouslistform :growl" styleClass="icon-link">
                        <i class="fa fa-fw fa-ban text-danger" aria-hidden="true"></i>
                        <h:outputText value="#{msg.ban}"/>
                    </p:commandLink>

                    <p:commandLink actionListener="#{adminBanlistBean.onRemoveSuspicious(aggrReqData.IP)}"
                                   update=":suspiciouslistform :growl" styleClass="icon-link">
                        <p:confirm message="#{msg.remove} #{aggrReqData.IP}?"/>
                        <i class="fa fa-fw fa-trash text-danger" aria-hidden="true"></i>
                        <h:outputText value="#{msg.remove}"/>
                    </p:commandLink>
                </p:column>
            </p:dataTable>
        </h:form>
    </p:panel>

    <script type="text/javascript">
        function setname(name) {
            formObj = document.getElementById('banformdialog');
            nameObj = formObj.elements.item(0);
            nameObj.value = name;
            radioObj = formObj.elements.item(0);
            radioObj.checked = true;
        }
    </script>
</ui:define>

</ui:composition>
