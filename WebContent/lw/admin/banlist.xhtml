<ui:composition
	template="/WEB-INF/templates/layout/template.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:p="http://primefaces.org/ui"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

	<ui:param name="loginRequired" value="true"/>
	<ui:param name="pageTitle" value="#{msg.banlist_header}"/>
	
	<ui:define name="sub_breadcrumb">
		<p:menuitem value="#{msg.banlist_header}" url="admin/banlist.jsf#"/>
	</ui:define>
	
	<ui:define name="center_layout">
        <ui:fragment>
            <div class="row" >
                <div class="col-12">
					<p:panel header="#{msg.manual_ban}">
						<h:form id="banformreg">
							<div class="row my-2">
								<div class="col-5 col-md-2">
									<h:outputText value="#{msg.name_or_ip}:" />
								</div>
								<div class="col-7 col-md-5">
									<p:inputText value="#{adminBanlistBean.name}" styleClass="w-100" id="name" required="true" />
								</div>
								<div class="col-12 col-md-5">
									<p:selectOneRadio value="#{adminBanlistBean.type}" required="true" id="type">
										<f:selectItem itemValue="user" itemLabel="User" />
										<f:selectItem itemValue="ip" itemLabel="IP" />
									</p:selectOneRadio>
								</div>
							</div>
							<div class="row my-2">
								<div class="col-5 col-md-2">
									<h:outputText value="#{msg.ban_for}:" />
								</div>
								<div class="col-7 col-md-5 d-flex">
									<ui:fragment >
										<h:inputText value="#{adminBanlistBean.banDays}" required="false" pt:placeholder="Days" class="flex-fill w-100 mr-2 "  />
										<h:inputText value="#{adminBanlistBean.banHours}" required="false" pt:placeholder="Hours" class="flex-fill w-100 mr-2"  />
										<h:inputText value="#{adminBanlistBean.banMinutes}" required="false" pt:placeholder="Mins" class="flex-fill w-100" />
									</ui:fragment>
								</div>
								<div class="col-12 col-md-5">
									<ui:fragment>
										<p:selectBooleanCheckbox value="#{adminBanlistBean.permaban}"  id="permabancheckbox" styleClass="mr-1"/> <p:outputLabel for="permabancheckbox">#{msg.permaban}</p:outputLabel>
									</ui:fragment>
								</div>
							</div>
							<div class="row my-2">
								<div class="col-12">
									<p:commandButton action="${adminBanlistBean.onManualBan}" value="#{msg.manual_ban}" process="@form" styleClass="command-button mt-3" ajax="false" />
								</div>
							</div>
						</h:form>
					</p:panel>
                </div>
            </div>
            <h:form styleClass="mt-3" id="banlistform" >
                <p:dataTable var="accessData" paginatorPosition="bottom" value="#{adminBanlistBean.banlist}" rows="50" paginator="true"
                             paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">

                    <p:column headerText="#{msg.name}" sortBy="#{accessData.name}">
                        <h:outputText value="#{accessData.name}" />
                    </p:column>

                    <p:column headerText="#{msg.bandate}" sortBy="#{accessData.banDate}">
                        <h:outputText value="#{accessData.banDate}">
                            <f:convertDateTime pattern="dd.MM.yyyy HH:mm" />
                        </h:outputText>
                    </p:column>

                    <p:column style="width: 10%" headerText="#{msg.bannedon}" sortBy="#{accessData.bannedOn}">
                        <h:outputText value="#{accessData.bannedOn}">
                            <f:convertDateTime pattern="dd.MM.yyyy HH:mm" />
                        </h:outputText>
                    </p:column>

                    <p:column style="width: 11%" headerText="#{msg.attempts}" sortBy="#{accessData.attempts}">
                        <h:outputText value="#{accessData.attempts}"/>
                    </p:column>

                    <p:column styleClass="column-button" style="width: 8%" headerText="#{msg.options}">
                        <f:facet name="header">
                            #{msg.options}
                        </f:facet>
                        <p:commandLink actionListener="#{adminBanlistBean.onUnban(accessData.name)}" process="@this"
                                       update=":banlistform :growl"
									   title="#{msg.unban}">
							<h:graphicImage value="/resources/icon/Remove.png" width="16" height="16" alt="#{msg.unban}" />
							<span><h:outputText value="#{msg.unban}"/></span>
                            <p:confirm message="#{msg.unban} #{accessData.name}?" />

                        </p:commandLink>

                    </p:column>
                </p:dataTable>
            </h:form>
        </ui:fragment>



		<p:panel header="#{msg.suspicious_activity}" rendered="#{not empty adminBanlistBean.suspiciousActivityList}">

		<p>#{msg.suspicious_activity_message}</p>

			<p:dialog header="Ban" widgetVar="bandialog" modal="true" height="100">
				<h:form class="banform" id="banformdialog">
					<h:panelGrid columns="3">
						<h:outputText value="#{msg.name_or_ip}:" />						
						<p:inputText value="#{adminBanlistBean.name}" id="name" required="true" />
						<p:selectOneRadio value="#{adminBanlistBean.type}" required="true" id="type">
							<f:selectItem itemValue="user" itemLabel="User" />
							<f:selectItem itemValue="ip" itemLabel="IP" />
						</p:selectOneRadio>
						
						<h:outputText value="#{msg.ban_for}:" />
						<ui:fragment>
							<h:inputText value="#{adminBanlistBean.banDays}" required="false" pt:placeholder="Days" class="numinput" />
							<h:inputText value="#{adminBanlistBean.banHours}" required="false" pt:placeholder="Hours" class="numinput" />
							<h:inputText value="#{adminBanlistBean.banMinutes}" required="false" pt:placeholder="Mins" class="numinput" />
						</ui:fragment>

						<ui:fragment>
							<p:selectBooleanCheckbox value="#{adminBanlistBean.permaban}" id="permabancheckbox"/> <p:outputLabel for="permabancheckbox">#{msg.permaban}</p:outputLabel>
						</ui:fragment>

						<p:commandButton action="${adminBanlistBean.onManualBan}" value="#{msg.manual_ban}" process="@form" />
						<h:outputText />
						<h:outputText />
					</h:panelGrid>
				</h:form>
			</p:dialog>

			<h:form id="suspiciouslistform" >
			<p:dataTable  paginatorPosition="bottom" var="aggrReqData" value="#{adminBanlistBean.suspiciousActivityList}" rows="50" paginator="true"
						 paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">

					<p:column headerText="IP" sortBy="#{aggrReqData.IP}" >
						<h:outputText value="#{aggrReqData.IP}" />
					</p:column>

					<p:column headerText="#{msg.requests_count}" sortBy="#{aggrReqData.requests}"  >
						<h:outputText value="#{aggrReqData.requests}" />
					</p:column>

					<p:column headerText="#{msg.logins_amount}" sortBy="#{aggrReqData.loginCount}">
						<h:outputText value="#{aggrReqData.loginCount}" />
					</p:column>

					<p:column headerText="#{msg.request_usernames}" sortBy="#{aggrReqData.usernames}">
						<h:outputText value="#{aggrReqData.usernames}" />
					</p:column>

					<p:column headerText="#{msg.time_stamp}" sortBy="#{aggrReqData.time}">
						<h:outputText value="#{aggrReqData.time}">
						    <f:convertDateTime pattern="dd.MM.yyyy HH:mm" />
						</h:outputText>
					</p:column>

					<p:column headerText="#{msg.options}">
						<f:facet name="header">
							#{msg.options}
						</f:facet>

						<p:commandLink onclick="PF('bandialog').show(); setname('#{entry.IP}')" process="@this"
							update=":suspiciouslistform :growl"
							style="text-decoration:none;" title="#{msg.ban}">
							<h:graphicImage value="/resources/icon/silk/delete.png" width="16" height="16" alt="#{msg.ban}" />
						</p:commandLink>

						<p:commandLink actionListener="#{adminBanlistBean.onRemoveSuspicious(aggrReqData.IP)}" 
									   update=":suspiciouslistform :growl"
									   style="text-decoration:none;" title="#{msg.remove}">
							<p:confirm message="#{msg.remove} #{aggrReqData.IP}?" />
							<h:graphicImage value="/resources/icon/Remove.png" width="16" height="16" alt="#{msg.remove}" />
						</p:commandLink>
					</p:column>
			</p:dataTable>
		</h:form>

		</p:panel>

		<script type="text/javascript">
			function setname(name) {
				formObj = document.getElementById("banformdialog");
				nameObj = formObj.elements.item(0);
				nameObj.value = name;
				radioObj = formObj.elements.item(0);
				radioObj.checked = true;
			}
		</script>

	</ui:define>
</ui:composition>