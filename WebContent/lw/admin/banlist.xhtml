<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:lw="http://l3s.de/learnweb">

<ui:param name="pageTitle" value="#{msg.banlist_header}"/>
<ui:param name="hasAccessPermission" value="#{userBean.admin}"/>

<ui:define name="breadcrumb">
    <lw:breadcrumb-item link="admin/index.jsf" title="#{msg.admin}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_first.xhtml"/>
    </lw:breadcrumb-item>

    <lw:breadcrumb-item link="admin/banlist.jsf" title="#{msg.banlist}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_admin.xhtml"/>
    </lw:breadcrumb-item>
</ui:define>

<ui:define name="center_layout">
    <div class="row">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
            <p:panel header="#{msg.manual_ban}">
                <h:form id="banformreg">
                    <div class="form-group">
                        <p:outputLabel for="@next" value="#{msg.ip_addr}:"/>
                        <p:inputText value="#{adminBanlistBean.addr}" required="true"/>
                        <p:message for="@previous"/>
                    </div>

                    <div class="form-group">
                        <p:outputLabel for="@next" value="#{msg.ban_for}:"/>
                        <div class="row mb-3">
                            <div class="col-12 col-md-4">
                                <p:inputText value="#{adminBanlistBean.banDays}" required="false" pt:placeholder="Days" class="me-3 mb-3 mb-sm-0"/>
                                <p:message for="@previous"/>
                            </div>
                            <div class="col-12 col-md-4">
                                <p:inputText value="#{adminBanlistBean.banHours}" required="false" pt:placeholder="Hours" class="me-3 mb-3 mb-sm-0"/>
                                <p:message for="@previous"/>
                            </div>
                            <div class="col-12 col-md-4">
                                <p:inputText value="#{adminBanlistBean.banMinutes}" required="false" pt:placeholder="Mins"/>
                                <p:message for="@previous"/>
                            </div>
                        </div>
                        <p:selectBooleanCheckbox value="#{adminBanlistBean.permaban}" itemLabel="#{msg.permaban}"/>
                    </div>

                    <p:commandButton onstart="PF('banlistformOverlay').show()" oncomplete="PF('banlistformOverlay').hide()" update=":banlist" action="${adminBanlistBean.onManualBan}" value="#{msg.manual_ban}" process="@form"/>
                </h:form>
            </p:panel>
        </div>
    </div>

    <h:form prependId="false">
        <p:blockUI block="banlist" widgetVar="banlistformOverlay">
            <h:outputText value="#{msg.please_wait}"/>
        </p:blockUI>

        <p:dataTable id="banlist" var="ban" paginatorPosition="bottom" value="#{adminBanlistBean.banlist}" rows="50" paginator="true"
                     paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">
            <f:facet name="header">#{msg.banlist}</f:facet>

            <p:column headerText="#{msg.ip_addr}" sortBy="#{ban.addr}">
                <h:outputText value="#{ban.addr}"/>
            </p:column>

            <p:column headerText="#{msg.bandate}" sortBy="#{ban.expires}">
                <h:outputText value="#{ban.expires}">
                    <f:convertDateTime timeZone="#{userBean.timeZone}" type="localDateTime"/>
                </h:outputText>
            </p:column>

            <p:column headerText="Reason" sortBy="#{ban.reason}">
                <h:outputText value="#{ban.reason}"/>
            </p:column>

            <p:column headerText="#{msg.attempts}" sortBy="#{ban.attempts}">
                <h:outputText value="#{ban.attempts}"/>
            </p:column>

            <p:column headerText="#{msg.bannedon}" sortBy="#{ban.createdAt}">
                <h:outputText value="#{ban.createdAt}">
                    <f:convertDateTime timeZone="#{userBean.timeZone}" type="localDateTime"/>
                </h:outputText>
            </p:column>

            <p:column headerText="#{msg.options}" styleClass="td-text-end">
                <p:commandLink onstart="PF('banlistformOverlay').show()" oncomplete="PF('banlistformOverlay').hide()"
                               actionListener="#{adminBanlistBean.onUnban(ban.addr)}" process="@this" update=":banlist"
                               styleClass="icon-link" title="#{msg.unban}">
                    <i class="fas fa-fw fa-ban text-danger" aria-hidden="true"></i>
                    <h:outputText value="#{msg.unban}"/>
                    <p:confirm message="#{msg.unban} #{ban.addr}?"/>
                </p:commandLink>
            </p:column>
        </p:dataTable>
    </h:form>

    <p:panel header="#{msg.suspicious_activity}" styleClass="mt-3" rendered="#{true}">
        <p>#{msg.suspicious_activity_message}</p>

        <p:dialog header="Ban" widgetVar="banDialog" modal="true" resizable="false" draggable="false" closeOnEscape="true">
            <h:form class="banform" id="banDialogForm">
                <div class="form-group">
                    <p:outputLabel for="@next" value="#{msg.ip_addr}:"/>
                    <p:inputText value="#{adminBanlistBean.addr}" required="true"/>
                    <p:message for="@previous"/>
                </div>

                <div class="form-group">
                    <p:outputLabel for="@next" value="#{msg.ban_for}:"/>
                    <div class="row mb-3">
                        <div class="col-12 col-md-4">
                            <p:inputText value="#{adminBanlistBean.banDays}" required="false" pt:placeholder="Days" class="me-3 mb-3 mb-sm-0"/>
                            <p:message for="@previous"/>
                        </div>
                        <div class="col-12 col-md-4">
                            <p:inputText value="#{adminBanlistBean.banHours}" required="false" pt:placeholder="Hours" class="me-3 mb-3 mb-sm-0"/>
                            <p:message for="@previous"/>
                        </div>
                        <div class="col-12 col-md-4">
                            <p:inputText value="#{adminBanlistBean.banMinutes}" required="false" pt:placeholder="Mins"/>
                            <p:message for="@previous"/>
                        </div>
                    </div>
                    <p:selectBooleanCheckbox value="#{adminBanlistBean.permaban}" itemLabel="#{msg.permaban}"/>
                </div>

                <p:commandButton action="${adminBanlistBean.onManualBan}" value="#{msg.manual_ban}" process="@form"/>
            </h:form>
        </p:dialog>

        <h:form id="suspiciouslistform">
            <p:dataTable paginatorPosition="bottom" var="aggrReqData" value="#{adminBanlistBean.suspiciousActivityList}" rows="50" paginator="true"
                         paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">
                <p:column headerText="IP" sortBy="#{aggrReqData.addr}">
                    <h:outputText value="#{aggrReqData.addr}"/>
                </p:column>

                <p:column headerText="#{msg.requests_count}" sortBy="#{aggrReqData.requests}">
                    <h:outputText value="#{aggrReqData.requests}"/>
                </p:column>

                <p:column headerText="#{msg.logins_amount}" sortBy="#{aggrReqData.loginCount}">
                    <h:outputText value="#{aggrReqData.loginCount}"/>
                </p:column>

                <p:column headerText="#{msg.request_usernames}" sortBy="#{aggrReqData.usernames}">
                    <h:outputText value="#{aggrReqData.usernames}"/>
                </p:column>

                <p:column headerText="#{msg.time_stamp}" sortBy="#{aggrReqData.createdAt}">
                    <h:outputText value="#{aggrReqData.createdAt}">
                        <f:convertDateTime timeZone="#{userBean.timeZone}" type="both"/>
                    </h:outputText>
                </p:column>

                <p:column headerText="#{msg.options}" styleClass="td-text-end">
                    <p:commandLink onclick="PF('banDialog').show(); updateFormValues('#{entry.IP}');" process="@this"
                                   update=":suspiciouslistform" styleClass="icon-link">
                        <i class="fas fa-fw fa-ban text-danger" aria-hidden="true"></i>
                        <h:outputText value="#{msg.ban}"/>
                    </p:commandLink>

                    <p:commandLink actionListener="#{adminBanlistBean.onRemoveSuspicious(aggrReqData.addr)}"
                                   update=":suspiciouslistform" styleClass="icon-link">
                        <p:confirm message="#{msg.remove} #{aggrReqData.addr}?"/>
                        <i class="fas fa-fw fa-trash-alt text-danger" aria-hidden="true"></i>
                        <h:outputText value="#{msg.remove}"/>
                    </p:commandLink>
                </p:column>
            </p:dataTable>
        </h:form>
    </p:panel>

    <h:outputScript>
        function updateFormValues(name) {
            const formObj = document.getElementById('banDialogForm');
            formObj.elements.item(0).value = name;
            formObj.elements.item(2).parentNode.nextSibling.click();
        }
    </h:outputScript>
</ui:define>

</ui:composition>
