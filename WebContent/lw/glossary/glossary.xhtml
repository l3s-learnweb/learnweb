<ui:composition template="/templates/main/main_old.xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

	<ui:param name="pageTitle" value="#{msg['Glossary.glossary']}" />
	<ui:param name="loginRequired" value="true" />
	
	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="resource_id" value="#{glossaryBeanNEW.resourceId}"></f:viewParam>
			<f:viewAction action="#{glossaryBeanNEW.onLoad()}" />
		</f:metadata>
	</ui:define>
	
	<ui:define name="center_layout">
		<h:outputStylesheet library="glossary" name="glossary.css" />
		<h:outputScript library="glossary" name="glossary.js" />
		<ui:fragment rendered="#{glossaryBeanNEW.resourceId gt 0 }">
			<h:panelGroup id="main_component" layout="block">
				
				<h:form id= "form" prependId="false">
					<p:dataTable id="my_gloss_table" var="item" value="#{glossaryBeanNEW.tableItems}" widgetVar="glossTable" tableStyle="table-layout: auto;"
						paginator="false" rows="#{glossaryBeanNEW.paginator ? 100 : 0}" paginatorPosition="bottom"
						filteredValue="#{glossaryBeanNEW.filteredTableItems}" sortBy="#{item.getTimestamp()}" sortOrder="descending"
						paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">

						<p:ajax event="filter" oncomplete="groupRow()" />
						<p:ajax event="page" oncomplete="groupRow()" />
						<p:ajax event="sort" oncomplete="groupRow()" />


						<f:facet name="header">	        					 
							<p:outputPanel>
								<p:autoUpdate />
								<h:outputText value="#{msg['Glossary.search_all_field']} " />
								<p:inputText id="globalFilter" onkeyup="PF('glossTable').filter()" style="width:150px"
									placeholder="#{msg['Glossary.search_filter_placeholder']}" />
							</p:outputPanel>
						</f:facet>
						
						<p:column style=" width:20px;" exportable="false">
							<p:commandLink id="edit" action="#{glossaryBeanNEW.deleteEntry(item)}" process="@this">
								<h:graphicImage value="/resources/icon/silk/delete.png" width="16" height="16" alt="#{msg.delete}" update=":growl" />
							</p:commandLink>


							<p:commandLink action="#{glossaryBeanNEW.setGlossaryForm(item)}" process="@this" oncomplete="openGlossForm();" update=":glossary_add">
								<h:graphicImage value="/resources/icon/silk/pencil.png" width="16" height="16" alt="#{msg.edit}" />
							</p:commandLink>
						</p:column>

						<p:column headerText="#{msg['Glossary.topic']} 1" filterable="true" filterBy="#{item.topicOne}" filterMatchMode="contains"
							filterStyle="width: 90%;" sortBy="#{item.topicOne}">
							<h:outputText value="#{item.topicOne}" pt:data-itemId="#{item.entryId}" id="cell1" />
						</p:column>
						<p:column headerText="#{msg['Glossary.topic']} 2" filterable="true" filterBy="#{item.topicTwo}" filterMatchMode="contains"
							filterStyle="width: 90%;" sortBy="#{item.topicTwo}">
							<h:outputText value="#{item.topicTwo}" pt:data-itemId="#{item.entryId}" id="cell2" />
						</p:column>
						<p:column headerText="#{msg['Glossary.topic']} 3" filterable="true" filterBy="#{item.topicThree}" filterMatchMode="contains"
							filterStyle="width: 90%;" sortBy="#{item.topicThree}">
							<h:outputText value="#{item.topicThree}" pt:data-itemId="#{item.entryId}" id="cell3" />
						</p:column>
						<p:column headerText="#{msg['Glossary.description']}" sortBy="#{item.description}" filterBy="#{item.description}" filterable="true"
							filterMatchMode="contains" filterStyle="width: 90%;">
							<h:outputText value="#{item.description}" pt:data-itemId="#{item.entryId}" id="cell4" />
						</p:column>

						<p:column headerText="#{msg['Glossary.term']}" filterable="true" filterMatchMode="contains" filterBy="#{item.term}"
							filterStyle="width: 90%;" sortBy="#{item.topicOne}#{item.topicTwo}#{item.entryId}#{item.term}">
							<h:outputText value="#{item.term}" />
						</p:column>
						<p:column headerText="#{msg.language}" filterBy="#{item.getLanguage()}" filterMatchMode ="in">
							<f:facet name="filter">
								<p:selectCheckboxMenu value="#{glossaryBeanNEW.tableLanguageFilter}" onchange="PF('glossTable').filter()"  styleClass="custom-filter" converter="#{localeConverter}" label="#{msg.filter}">
									<f:selectItems value="#{glossaryBeanNEW.allowedTermLanguages}" />
									<p:ajax event="toggleSelect" process="@this" oncomplete="PF('glossTable').filter()" />
									
								</p:selectCheckboxMenu>								
								
							</f:facet>

							<h:outputText value="#{msg['language_' += item.languageTag]}" />
						</p:column>
						<p:column headerText="#{msg['Glossary.use']}">
							<h:outputText value="#{item.uses}" />
						</p:column>
						<p:column headerText="#{msg['Glossary.pronounciation']}">
							<h:outputText value="#{item.pronounciation}" />
						</p:column>
						<p:column headerText="#{msg['Glossary.acronym']}">
							<h:outputText value="#{item.acronym}" />
						</p:column>
						<p:column headerText="#{msg.source}">
							<h:outputText value="#{item.source}" />
						</p:column>
						<p:column headerText="#{msg['Glossary.phraseology']}">
							<h:outputText value="#{item.phraseology}" />
						</p:column>					

						<p:column headerText="fulltext search" filterBy="#{item.fulltext}" exportable="false" style="display:none">
							<h:outputText value="#{item.fulltext}" />
						</p:column>
					</p:dataTable>
					
					<p:panelGrid columns="5" styleClass="ui-noborder datatable_footer" style="align-content:center; border-style:none; cell-padding:none;">
						<h:outputText value="#{msg['Glossary.total_concept']} = #{glossaryBeanNEW.entryCount}" style="text-align:center;"
							styleClass="glossary_footer_text"></h:outputText>
                        <!--excel import button-->
                        <p:commandLink styleClass="excel_import"  ajax="false"  onclick="PF('excel_import_dialog').show(); return false;">
                            <p:graphicImage library="default" value="/resources/icon/excel_import.png" width="24"
                                            style="position:relative; text-alignt:center; display: block; " />
                        </p:commandLink>
						<p:commandLink styleClass="excel_export_todo_use" style="text-align:center;" ajax="false">
							<p:graphicImage library="default" value="/resources/icon/excel_icon.jpg" width="24"
								style="position:relative; text-alignt:center; display: block; " />
							<p:dataExporter type="xls" target="my_gloss_table" fileName="glossary" postProcessor="#{glossaryBeanNEW.postProcessXls}" />
						</p:commandLink>
						<p:commandLink style="text-align:center;" ajax="false">
							<p:graphicImage library="default" value="/resources/icon/pdf_icon.png" width="24" style="position:relative; text-alignt:center;" />
							<p:dataExporter type="pdf" fileName="glossary" target="my_gloss_table" preProcessor="#{glossaryBeanNEW.rotatePDF}"></p:dataExporter>
						</p:commandLink>
                        <p:commandLink id="show_all" actionListener="#{glossaryBeanNEW.togglePaginator()}" update=":my_gloss_table @this"
                                       rendered="#{glossaryBeanNEW.entryCount >= 100}">
                            <h:outputText value="#{glossaryBeanNEW.toggleLabel}" oncomplete="groupRow();" />
                        </p:commandLink>
					</p:panelGrid>

                    <p:dialog header="Import glossary" widgetVar="excel_import_dialog" min-height="120"
                              min-width="400" closable="true" responsive="true">
                        <div class="p-grid">
                            <div class="p-col-5">
                                <p:outputLabel for="console" value="Do you want to override table?" />
                            </div>
                            <div class="p-col-5">
                                <p:selectOneRadio id="console">
                                    <f:selectItem itemLabel="Yes" itemValue="true" />
                                    <f:selectItem itemLabel="No" itemValue="false" />
                                </p:selectOneRadio>
                            </div>
                            <div class="p-col-12">
                                <p:fileUpload mode="advanced" skinSimple="true"  fileUploadListener="#{glossaryBeanNEW.parseXls}"
                                              allowTypes="/(\.|\/)(xls|xlsx)$/" multiple="false"/>
                            </div>
                        </div>
                    </p:dialog>

					<br />
					<br />
					<br />
				</h:form>

				<button type="button" onclick="openGlossForm()" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only greenbutton">
					<h:outputText value="#{msg['Glossary.add_new_entry']}"></h:outputText>
				</button>
				
				<div id="glossform" style="display: none">
					<h:form id="glossary_add" styleClass="grey_border" prependId="false">
						<p:growl id="glossgrowl" redisplay="true" globalOnly="true" showDetail="true">
							<p:autoUpdate />
						</p:growl>
						
						<p:panelGrid id="grid" styleClass="centered-form" columns="3" style="border-style: none !important; margin: 0 auto;">
							<p:outputLabel for="topic_1" value="#{msg['Glossary.topic']} 1 " />
							<p:selectOneMenu id="topic_1" value="#{glossaryBeanNEW.formEntry.topicOne}" required="true" requiredMessage="#{msg['Glossary.topic_one_message']}">
								<f:selectItems value="#{glossaryBeanNEW.availableTopicOne}" />
								<f:ajax listener="#{glossaryBeanNEW.changeTopicOne}" render="topic_2 topic_3" />
							</p:selectOneMenu>
							<p:message for="topic_1" />

							<p:outputLabel for="topic_2" value="#{msg['Glossary.topic']} 2 " />
							<h:panelGroup id="topic_2">
								<p:selectOneMenu rendered="#{not empty glossaryBeanNEW.availableTopicTwo}" value="#{glossaryBeanNEW.formEntry.topicTwo}" editable="true">
									<f:selectItems value="#{glossaryBeanNEW.availableTopicTwo}" />
									<f:ajax listener="#{glossaryBeanNEW.changeTopicTwo}" render="topic_3" />
								</p:selectOneMenu>
								<p:inputText rendered="#{empty glossaryBeanNEW.availableTopicTwo}" value="#{glossaryBeanNEW.formEntry.topicTwo}" />
							</h:panelGroup>
							<p:message for="topic_2" />

							<p:outputLabel for="topic_3" value="#{msg['Glossary.topic']} 3 " />
							<h:panelGroup id="topic_3">
								<p:selectOneMenu rendered="#{not empty glossaryBeanNEW.availableTopicThree}" value="#{glossaryBeanNEW.formEntry.topicThree}" editable="true">
									<f:selectItems value="#{glossaryBeanNEW.availableTopicThree}" />
								</p:selectOneMenu>
								<p:inputText rendered="#{empty glossaryBeanNEW.availableTopicThree}" value="#{glossaryBeanNEW.formEntry.topicThree}" />
							</h:panelGroup>
							<h:outputText value="" />
							
							<p:outputLabel value="#{msg['Glossary.description']} " for="description"></p:outputLabel>
							<p:inputText id="description" value="#{glossaryBeanNEW.formEntry.description}" styleClass="inputfield" required="#{glossaryBeanNEW.optionMandatoryDescription}" pt:onpaste="setPasteStatus(this, 'description');" requiredMessage="#{msg['Glossary.description_message']}" />
							<p:message for="description" />							
						</p:panelGrid>						
						
	        			<h:inputHidden value="#{glossaryBeanNEW.formEntry.descriptionPasted}" id="paste_status_description"></h:inputHidden>
						
						<br />
						<p:dataTable value="#{glossaryBeanNEW.formEntry.terms}" var="term" id="lang_terms" tableStyle="width:100%">
        					
							<p:column headerText="#{msg['Glossary.term']}" rendered="#{not term.deleted}">

								<p:inputText id="term" value="#{term.term}" style="width: 90%" required="#{not empty param[save.clientId]}" requiredMessage="#{msg.mandatory_field}" pt:onpaste="setPasteStatus(this, 'term');"/>								
								<p:message for="term" />								
									
	        					<h:inputHidden value="#{term.termPasted}" id="paste_status_term"></h:inputHidden>
	        					<h:inputHidden value="#{term.pronounciationPasted}" id="paste_status_pronounciation"></h:inputHidden>
	        					<h:inputHidden value="#{term.acronymPasted}" id="paste_status_acronym"></h:inputHidden>
	        					<h:inputHidden value="#{term.phraseologyPasted}" id="paste_status_phraseology"></h:inputHidden>								
							</p:column>
							
							<p:column headerText="#{msg.language}" rendered="#{not term.deleted}">
								<p:selectOneMenu id="language" value="#{term.language}" converter="#{localeConverter}">
									<f:selectItems value="#{glossaryBeanNEW.allowedTermLanguages}" />
								</p:selectOneMenu>
								<p:message for="language" />
								</p:column>

							<p:column headerText="#{msg['Glossary.use']}" style="text-align: center" rendered="#{not term.deleted}">
								<p:selectCheckboxMenu id="use" value="#{term.uses}" label="Uses" multiple="true" filter="true" filterMatchMode="startsWith">
									<f:selectItem itemValue="technical" itemLabel="#{msg['Glossary.use_technical']}" />
									<f:selectItem itemValue="popular" itemLabel="#{msg['Glossary.use_popular']}" />
									<f:selectItem itemValue="informal" itemLabel="#{msg['Glossary.use_informal']}" />
								</p:selectCheckboxMenu>
							</p:column>
							<p:column headerText="#{msg['Glossary.pronounciation']}" rendered="#{not term.deleted}">

								<p:inputText id="pronoun" value='#{term.pronounciation}' style="width: 90%" pt:onpaste="setPasteStatus(this, 'pronounciation');" />
							</p:column>
							<p:column headerText="#{msg['Glossary.acronym']}" rendered="#{not term.deleted}">

								<p:inputText id="acro" value='#{term.acronym}' style="width: 90%" pt:onpaste="setPasteStatus(this, 'acronym');" />
							</p:column>
							<p:column headerText="#{msg.source}" rendered="#{not term.deleted}">

								<p:selectOneMenu id="ref" value="#{term.source}" style="width: 80% !important" autoWidth="false">
									<f:selectItem itemValue="#{null}" itemLabel="--#{msg['Glossary.select']}--" />
									<f:selectItem itemValue="Wikipedia" itemLabel="#{msg['Glossary.wikipedia']}"></f:selectItem>
									<f:selectItem itemValue="encyclopaedia" itemLabel="#{msg['Glossary.encyclopaedia']}"></f:selectItem>
									<f:selectItem itemValue="monolingual dictionary" itemLabel="#{msg['Glossary.mono_dictionary']}"></f:selectItem>
									<f:selectItem itemValue="bilingual dictionary" itemLabel="#{msg['Glossary.bi_dictionary']}"></f:selectItem>
									<f:selectItem itemValue="scientific/academic publication" itemLabel="#{msg['Glossary.publication']}"></f:selectItem>
									<f:selectItem itemValue="institutional website" itemLabel="#{msg['Glossary.website']}"></f:selectItem>
									<f:selectItem itemValue="glossary" itemLabel="#{msg['Glossary.glossary']}"></f:selectItem>
									<f:selectItem itemValue="Linguee or Reverso" itemLabel="Linguee or Reverso"></f:selectItem>
									<f:selectItem itemValue="patients' websites and blogs" itemLabel="#{msg['Glossary.web_blog']}"></f:selectItem>
									<f:selectItem itemValue="other" itemLabel="other"></f:selectItem>
								</p:selectOneMenu>
							</p:column>
							<p:column headerText="#{msg['Glossary.phraseology']}" rendered="#{not term.deleted}">

								<p:inputTextarea id="phras" value="#{term.phraseology}" style="width: 90% !important" autoResize="false" pt:onpaste="setPasteStatus(this, 'phraseology');"/>
							</p:column>
							<p:column width="20" rendered="#{not term.deleted}">
								<p:commandLink id="delete_term" actionListener="#{glossaryBeanNEW.deleteTerm(term)}" update=":glossgrowl :lang_terms :growl">
									<f:ajax execute="@this lang_terms" />
									<h:graphicImage value="/resources/icon/silk/delete.png" width="16" height="16" alt="#{msg.delete}" />
								</p:commandLink>
								<p:tooltip for="delete_term" value="#{msg['Glossary.remove_row']}" position="bottom" />
							</p:column>
						</p:dataTable>
						<br />
						<p:commandButton id="add_synonym" value="#{msg['Glossary.add_synonym']}" actionListener="#{glossaryBeanNEW.addTerm()}" style="float:left;" styleClass="greenbutton"
							update=":glossary_add :lang_terms">
							<f:ajax execute="@this lang_terms" />
						</p:commandButton>

						<br />
						<br />
						<p:commandButton id="save" value="#{msg.save}" action="#{glossaryBeanNEW.onSave()}" styleClass="greenbutton resource_button" update=":glossary_add :growl" binding="#{save}" oncomplete="groupRow()">
							<f:ajax execute="@form" />


						</p:commandButton>
						<p:commandButton value="#{msg.cancel}" action="#{glossaryBeanNEW.onCancel()}" styleClass="greenbutton resource_button" update="@form :glossary_add :lang_terms"
							 process="@this" resetValues="true" oncomplete="groupRow()">
						</p:commandButton>

						<br />
						<br />
				
					</h:form>
				</div>
				
			</h:panelGroup>
		</ui:fragment>
		<script type="text/javascript">
			//<![CDATA[
			        
			var groupRow = function() {
				var colIndex = 2;
				var rows = $('#my_gloss_table').find('tr');
				var groupStartIndex = null, rowGroupCellData = null, rowGroupCount = 1, columnData = null;

				var groupCounter = 1;
				
				for (var i = 0; i < rows.length; i++) {
					var row = rows.eq(i);
					var columns = [];
					var column = row.children('td').eq(colIndex);

					for (var j = 0; j < 5; j++) // merge the first 5 rows
						columns.push(row.children('td').eq(j));

					columnData = column.find("span").first().data("itemid");

					if (rowGroupCellData !== columnData) {
						groupCounter++;
						groupStartIndex = i;
						rowGroupCellData = columnData;
						rowGroupCount = 1;
					} 
					else {
						for (var k = 0; k < columns.length; k++)
							columns[k].remove();

						//column.remove();
						rowGroupCount++;
					}

					if (groupStartIndex != null && rowGroupCount > 1) 
					{						
						for (var l = 0; l < columns.length; l++)
						{
							var cell = rows.eq(groupStartIndex).children('td').eq(l);
							cell.attr('rowspan', rowGroupCount);							
							cell.removeClass(); // remove all classes
							cell.addClass(groupCounter % 2 === 0? 'ui-datatable-even' : 'ui-datatable-odd');
						}
					}					
				}
			};

			
			$(document).ready(function() {
				groupRow();
			});
			
			function setPasteStatus(element, field)
			{
				var id = $(element).attr('id');
				id = id.substring(0, id.lastIndexOf(':'));
				id = id +":paste_status_"+ field;
				id = "#"+ id.replace(/:/g, '\\:'); //  need to escape : for jquery
				$(id).val('true');				
			}
			//]]>
		</script>
		<ui:fragment rendered="#{glossaryBeanNEW.resourceId le 0}">
			<div class="noresource">
				<br /> <br />
				<h:outputText value="Please select correct glossary resource." style="text-align:center; font-weight:bold"></h:outputText>
			</div>
		</ui:fragment>
 		<ui:fragment rendered="#{glossaryBeanNEW.glossaryResource.deleted eq true}">
			<div class="noresource">
				<br /> <br />
				<h:outputText value="The resource you are trying to access is deleted and does not exist." style="text-align:center; font-weight:bold"></h:outputText>
			</div>
		</ui:fragment>	 
	</ui:define>	
</ui:composition>
