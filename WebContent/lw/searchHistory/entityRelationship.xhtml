<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
				xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
				xmlns:h="http://xmlns.jcp.org/jsf/html"
				xmlns:f="http://xmlns.jcp.org/jsf/core"
				xmlns:p="http://primefaces.org/ui"
				xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
				xmlns:lw="http://l3s.de/learnweb">

<ui:param name="pageTitle" value="Search History"/>

<ui:define name="metadata">
	<f:metadata>
		<f:viewParam name="user_id" value="#{searchHistoryBean.userId}"/>
		<f:viewParam name="group_id" value="#{searchHistoryBean.selectedGroupId}"/>
		<f:viewAction action="#{searchHistoryBean.onLoad}"/>
	</f:metadata>
</ui:define>

<ui:define name="breadcrumb">
	<lw:breadcrumb-item link="searchHistory/entityRelationship.jsf" title="Search History">
		<ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_first.xhtml"/>
	</lw:breadcrumb-item>
</ui:define>

<ui:define name="center_layout">
	<h:outputScript library="vendor" name="d3js-v3.5.17/d3.min.js" target="body"/>
	<h:outputScript library="vendor" name="d3js-v3.5.17/d3-tip.js" target="body"/>
	<h:outputScript library="vendor" name="d3js-v3.5.17/d3-color.v1.min.js" target="body"/>
	<h:outputScript library="vendor" name="d3js-v3.5.17/d3-interpolate.v1.min.js" target="body"/>
	<h:outputScript library="vendor" name="d3js-v3.5.17/d3-scale-chromatic.v1.min.js" target="body"/>
	<h:outputScript library="vendor" name="d3js-v3.5.17/d3-scale.v1.min.js" target="body"/>
	<h:outputScript library="vendor" name="jsnetworkx-v0.3.4/jsnetworkx.js" target="body"/>
	<h:outputScript library="learnweb-layout" name="js/entity-relationship.js" target="body"/>

	<h:panelGroup styleClass="section-entity-relationship" layout="block">
		<h:form>
			<p:remoteCommand name="updateKG" actionListener="#{searchHistoryBean.actionUpdateKGData}" update="updateGraph updateGraphCategories" oncomplete="draw()"/>
			<p:remoteCommand name="setSelectedSearchId" actionListener="#{searchHistoryBean.actionSelectedSearchId}" update="snippets snippet-viewer-entity" oncomplete="showSnippet();"/>
			<p:remoteCommand name="setSelectedSearchIds" actionListener="#{searchHistoryBean.actionSelectedSearchIds}" update="snippets snippet-viewer-entity" oncomplete="filterSnippets();"/>
			<p:remoteCommand name="setSelectedGroupId" actionListener="#{searchHistoryBean.actionSelectedGroupId}" update="updateSessions" oncomplete="bindClickToSessionBlock();"/>
		</h:form>
		<p:panel styleClass="ui-fluid pt-0">
			<div class="row">
				<div class="col-12 col-xl-4 border-right">
					<h:panelGroup id="sh_nav_dock" layout="block" styleClass="d-flex flex-column-reverse flex-sm-row justify-content-between align-items-center">
						<div class="row">
							<div class="col-6 pr-2">
								<h:form id="search_mode_select">
									<p:commandButton id="selected_group_id_button" value="Groups' History"
													 actionListener="#{searchHistoryBean.actionSetShowGroupHistory}" update=":updateSessions :sh_nav_dock :sh_nav_desc"
													 rendered="#{not searchHistoryBean.showGroupHistory}"/>

									<p:commandButton id="group_unselected_button" value="My History"
													 actionListener="#{searchHistoryBean.actionSetShowUserHistory}" update=":updateSessions :sh_nav_dock :sh_nav_desc" oncomplete="bindClickToSessionBlock();"
													 rendered="#{searchHistoryBean.showGroupHistory}"/>
								</h:form>
							</div>
							<div class="col-6 pr-2 mb-3">
								<h:form id="search_in_history">
									<div class="ui-inputgroup">
										<p:inputText placeholder="Search query" id="sh-query" value="#{searchHistoryBean.searchQuery}"/>
										<p:commandButton icon="fa fa-search" id="sh-search" ajax="true" update=":updateSessions" actionListener="#{searchHistoryBean.search}"/>
									</div>
								</h:form>
							</div>
						</div>
					</h:panelGroup>

					<h:panelGroup id="sh_nav_desc" layout="block">
						<div class="" id="select-groups">
							<ui:fragment rendered="#{not searchHistoryBean.showGroupHistory}">
								<h:outputText value="Show history for User"/>
							</ui:fragment>

							<h:form rendered="#{searchHistoryBean.showGroupHistory}" id="select_grouo_form">
								<h:outputText value="Show history for Group: "/>
								<p:selectOneMenu id="select-group-menu" value="#{searchHistoryBean.selectedGroupId}">
									<f:selectItem itemLabel="---------------" itemValue="-1"/>
									<f:selectItems var="group" value="#{searchHistoryBean.currentUser.groups}" itemLabel="#{group.title}" itemValue="#{group.id}"/>
									<p:ajax listener="#{searchHistoryBean.onChangeGroup}" update=":updateSessions :sh_nav_dock :sh_nav_desc"/>
								</p:selectOneMenu>
							</h:form>
						</div>
					</h:panelGroup>

					<h3>Sessions</h3>

					<div class="">
						<h:panelGroup id="updateSessions" styleClass="w-100">
							<h:outputScript>var selectedGroupId = #{searchHistoryBean.selectedGroupId}</h:outputScript>
							<h:outputText value="No Sessions have been recorded yet." rendered="#{empty searchHistoryBean.sessions}"/>

							<div class="box #{searchHistoryBean.showGroupHistory == false ? 'box-user' : 'box-group'}">
								<ul id="first-list">
									<ui:repeat var="session1" value="#{searchHistoryBean.sessions}">
										<li>
											<span></span>
											<h:panelGroup layout="block" class="session_block cursor-pointer" pt:data-sessionId="#{session1.sessionId}" pt:data-userId="#{session1.userId}">
												<div class="info">
													<p:repeat var="query" value="#{session1.queries}">
														<span class="source_#{query.service}">#{query.query}</span>
													</p:repeat>
												</div>

												<div class="time">
													<h:outputFormat value="#{msg.format_date_and_time_between}" escape="false">
														<f:param value="#{session1.startTimestamp}"/>
														<f:param value="#{session1.endTimestamp}"/>
													</h:outputFormat>
												</div>
												<span><b>#{searchHistoryBean.showGroupHistory == false ? '' : 'From: '.concat(session1.userName)}</b></span>
											</h:panelGroup>
										</li>
									</ui:repeat>
								</ul>
							</div>
						</h:panelGroup>
					</div>
				</div>

				<div class="col-12 col-xl-8 mt-5 mt-xl-0 d-none d-xl-block">
					<div class="ui-g-12 ui-md-12 ui-lg-12 knowledge-graph" id="knowledge-graph">
						<div id="canvas" class="w3-container h-100 m-auto">
							<h:panelGroup id="updateGraph">
								<!--<button onclick="drawQueryPath()" id="query_path_button" style="display: none;">Query Path</button>-->
								<h:outputScript>
									var queriesJsonArr = #{searchHistoryBean.queriesAsJson};
									var edgesJsonArr = #{searchHistoryBean.edgesAsJson};
								</h:outputScript>
							</h:panelGroup>
						</div>

						<div class="tagging-panel" id="tagging-panel">
							<p:panel id="updateGraphCategories" styleClass="mb-4">
								<f:facet name="footer">
									<p:commandButton value="Apply" id="filterByCategories" onclick="return false;"/>
								</f:facet>
								<p:selectManyCheckbox id="categoriesList" layout="responsive" columns="1" onchange="return false;">
									<f:selectItems value="#{searchHistoryBean.categories}" var="cat" itemLabel="#{cat}" itemValue="#{cat}"/>
								</p:selectManyCheckbox>
							</p:panel>
						</div>
					</div>
					<div class="ui-g-3 ui-md-3 ui-lg-3 snippet-viewer" id="knowledge-snippet">
						<h:outputText value="Snippets: "/>
						<span class="hideIcon" onclick="hideSnippet();">
							<svg x="0px" y="0px" width="14px" height="14px" viewBox="0 0 10 10" focusable="false">
								<polygon class="a-s-fa-Ha-pa" fill="#000000" points="10,1.01 8.99,0 5,3.99 1.01,0 0,1.01 3.99,5 0,8.99 1.01,10 5,6.01 8.99,10 10,8.99 6.01,5 ">
								</polygon>
							</svg>
						</span>
						<h:outputText id="snippet-viewer-entity" styleClass="font-italic" value="#{searchHistoryBean.selectedEntity}"/>
						<h:panelGroup layout="block" id="snippets">
							<div class="mb-2"></div>
							<ui:repeat var="snippet" value="#{searchHistoryBean.getSearchResults()}">
								<h:panelGroup layout="block" class="snippet" pt:data-searchId="#{snippet.searchId}" pt:data-rank="#{snippet.rank}">
									<span><a href="#{snippet.url}" target="_blank"><h:outputText value="#{snippet.title}" escape="false"/></a></span><br/>
									<span class="reference_url">#{snippet.url}</span><br/>
									<span>#{snippet.description}</span><br/>
									<span class="snippet_query">query: #{searchHistoryBean.getQuery(snippet.searchId)}</span>
									<span class="float-right">rank: &#35;#{snippet.rank}</span>
								</h:panelGroup>
							</ui:repeat>
						</h:panelGroup>
					</div>
				</div>

			</div>
		</p:panel>

		<p:dialog id="warningDialog" widgetVar="warningSmallScreen" minHeight="40">
			<h:outputText value="This view is not available on small screens"/>
		</p:dialog>
	</h:panelGroup>
</ui:define>

</ui:composition>
