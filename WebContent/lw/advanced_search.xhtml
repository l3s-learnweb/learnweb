<ui:composition template="/templates/main/main_old.xhtml"
				xmlns:ui="http://java.sun.com/jsf/facelets"
				xmlns:h="http://java.sun.com/jsf/html"
				xmlns:f="http://java.sun.com/jsf/core"
				xmlns:p="http://primefaces.org/ui"
				xmlns:c="http://java.sun.com/jsp/jstl/core"
				xmlns:fn="http://java.sun.com/jsp/jstl/functions"
				xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

	<ui:param name="loginRequired" value="true" />
	<ui:param name="pageTitle" value="#{msg.advancedSearch}" />
	<ui:param name="disableGrowl" value="false" />

	<ui:define name="metadata">
		<f:metadata>
			<f:event type="javax.faces.event.PreRenderViewEvent" listener="#{resourceDetailBean.preRenderView}" />
		</f:metadata>
	</ui:define>

	<ui:define name="center_layout">
	
		<p:panel header="#{msg.advancedSearch}">		
			<h:form id="search_form" >	
				<table>
					<c:forEach var="field" items="#{userBean.user.organisation.metadataFields}">
						<tr>
						<!-- 
							<c:if test="#{fn:startsWith(field.type,'FULLWIDTH_')}">	
								<td colspan="2">
									<c:if test="#{field.type eq 'FULLWIDTH_HEADER'}">
										<h3><h:outputText value="${utilBean.getLocaleMessage(field.label, null)}" /></h3>
									</c:if> 
									<c:if test="#{field.type eq 'FULLWIDTH_DESCRIPTION'}">
										<h4><h:outputText value="${utilBean.getLocaleMessage(field.label, null)}" /></h4>
									</c:if> 
									
								</td>
							</c:if>	
							-->
							<c:if test="#{not fn:startsWith(field.type,'FULLWIDTH_')}">							 
								<td>
									<h:outputText value="${utilBean.getLocaleMessage(field.name, null)}" />:
								</td>
								<td>	
									
									<c:if test="#{field.type eq 'INPUT_TEXT' or field.type eq 'INPUT_TEXTAREA'}">					
										<p:inputText id="input_#{field.name}" required="#{field.required}" class="border-box-100" value="#{advSearchBean.queries[field.name]}" title="#{field.info}" />
										<p:tooltip for="input_#{field.name}" showEvent="focus" hideEvent="blur" position="left" rendered="#{not empty field.info}" />
									</c:if>
									
									<c:if test="#{field.type eq 'AUTOCOMPLETE'}">	 				
										<p:autoComplete id="input_complete_#{field.name}" required="#{field.required}" value="#{advSearchBean.queries[field.name]}" 
											completeMethod="#{field.completeText}" class="border-box-100" /> 
										<p:tooltip for="input_complete_#{field.name}" showEvent="hover" position="left" rendered="#{true}" value="blaaaaaaa #{field.info}" /> 
									</c:if>
				
									<c:if test="#{field.type eq 'ONE_MENU' or field.type eq 'ONE_MENU_EDITABLE'}">
										<p:selectOneMenu id="input_selectone_#{field.name}" value="#{advSearchBean.queries[field.name]}" editable="#{field.type eq 'ONE_MENU_EDITABLE'}" required="#{field.required}"
											class="border-box-100" title="#{field.info}">
											<f:selectItems value="#{field.options}" var="option" itemLabel="#{option}" itemValue="#{option}" />
										</p:selectOneMenu>
										<p:tooltip for="input_selectone_#{field.name}" position="left" rendered="#{not empty field.info}" /> 
									</c:if>	
				
									<c:if test="#{field.type eq 'MULTIPLE_MENU'}">
										<p:selectCheckboxMenu id="input_selectmultiple_#{field.name}" value="#{advSearchBean.queriesMultiValued[field.name]}" label="" multiple="true" title="#{field.info}"
					                              required="#{field.required}" filter="#{field.optionsList.size() gt 8}" filterMatchMode="startsWith" panelStyle="width:250px" >
								            <f:selectItems value="#{field.optionsList}" var="option" itemLabel="#{option.label}" itemValue="#{option.value}" />
								        </p:selectCheckboxMenu>			
										<p:tooltip for="input_selectmultiple_#{field.name}" position="left" rendered="#{not empty field.info}" /> 
									</c:if>							
									
								</td>								
							</c:if>
							 
						</tr>
					</c:forEach>
					
					<tr>
						<td></td>
						<td><p:commandButton value="#{msg.searchLabel}" styleClass="greenbutton" action="#{advSearchBean.onSearch()}" /></td> 
					 </tr>
			
				</table>
			</h:form>
		</p:panel>	
	
		<h:panelGroup id="datagrid" layout="block">
			<h:panelGroup id="resourceGrid" styleClass="resource-grid" layout="block">
				<ui:repeat value="#{advSearchBean.paginator.currentPage}" var="result">
					<div class="grey_border" style="margin-bottom:1rem;">
						<h3>
							<a href="group/resources.jsf?group_id=#{result.resource.groupId}&amp;resource_id=#{result.resource.id}&amp;folder_id=#{result.resource.folderId}">
								<h:outputText value="#{result.resource.title}" escape="false" />
							</a>	
						</h3>
						
						<a href="group/resources.jsf?group_id=#{result.resource.groupId}&amp;resource_id=#{result.resource.id}&amp;folder_id=#{result.resource.folderId}">
							<img class="resource-preview-image" src="#{res.thumbnail1.url}" alt="#{res.title}" title="#{res.title}"></img>							
						</a>
					
						<div class="resource-title-text">
							<span class="resource-title-summary"><span>${learnwebBean.getLocaleMessage(result.resource.type)}</span> #{msg.added_by} <span>#{result.resource.ownerUser.username}</span></span>
						</div>
						
							
						<table id="resources_informations_table" class="full-width">

							<ui:fragment rendered="${not empty result.resource.fileName and not result.resource.source.equals('LORO')}">
								<tr>
									<td>
										<span class="resource_field">
											#{msg.file}: 
										</span>
									</td>
									<td>
										<a href="#{result.resource.url}">
											<span style="float:left;text-decoration:underline;">#{result.resource.fileName}</span><span class="ui-icon ui-icon-arrowthickstop-1-s" style="float:left;"></span>
										</a>
									</td>
								</tr>
							</ui:fragment>
							
							<ui:fragment rendered="${empty result.resource.fileName and result.resource.type != 'text' and result.resource.type != 'pdf' and result.resource.type != 'video' and result.resource.type != 'image' }">
								<tr>
									<td>
										<span class="resource_field">
											#{msg.resource}: 
										</span>
									</td>
									<td>
										<a style="color: #22e" href="#{result.resource.urlProxied}">
											#{result.resource.url}
										</a>
									</td>
								</tr>
							</ui:fragment>
												
							<ui:fragment rendered="#{resourceDetailBean.starRatingEnabled}">
								<tr>
									<td>
										<span class="resource_field">
											#{msg.relevance}: 
										</span>
									</td>
									<td>
										<h:form id="rate_form">
											<p:rating value="#{result.resource.starRatingRounded}" disabled="true" cancel="false" style="vertical-align: bottom; margin-right:10px; display:inline-block;">		
											</p:rating>
											 
											<h:outputText value="#{result.resource.starRating}">
												<f:convertNumber maxFractionDigits="1" minFractionDigits="1" />
											</h:outputText>	
											(<h:outputFormat value="#{msg.votes}"><f:param value="#{result.resource.rateNumber}" /></h:outputFormat>)
										</h:form>
									</td>
								</tr>
							</ui:fragment>
												
							<ui:fragment rendered="#{resourceDetailBean.thumbRatingEnabled}">
								<tr>
									<td>
										<span class="resource_field">
											#{msg.reliability}: 
										</span>
									</td>
									<td>
										<h:form id="thumbrating">
											<h:panelGrid columns="4" >
												<h:outputText value="+#{result.resource.thumbUp}" />
												<p:commandLink actionListener="#{resourceDetailBean.onThumbUp}" update="thumbrating :growl">
													<f:param name="resource_id" value="#{result.resource.id}" />
													<h:graphicImage value="/resources/icon/thumb_up.png" width="16" height="16" alt="Rate thump up"/>
												</p:commandLink>
				
												<p:commandLink actionListener="#{resourceDetailBean.onThumbDown}" update="thumbrating :growl">
													<f:param name="resource_id" value="#{result.resource.id}" />
													<h:graphicImage value="/resources/icon/thumb_dw.png" width="16" height="16" alt="Rate thump down" />
												</p:commandLink>
												<h:outputText value="-#{result.resource.thumbDown}" />
											</h:panelGrid>
										</h:form>
									</td>
								</tr>
							</ui:fragment>				
	
							<ui:fragment rendered="#{not empty result.resource.author}">
								<tr>
									<td>
										<span class="resource_field">
											#{msg.author}: 
										</span>
									</td>
									<td>
										<h:outputText value="#{result.resource.author}"/>
									</td>
								</tr>
							</ui:fragment>
							
							<ui:fragment rendered="#{not empty result.resource.language}">
								<tr>
									<td>
										<span class="resource_field">
											#{msg.language}:
										</span>
									</td>
									<td>
										<ui:repeat var="language" value="#{result.resource.metadataMultiValue['language']}" varStatus="status">
											<h:outputText value="#{msg['language_' += language]}" /><h:outputText value=", " rendered="#{!status.last}" escape="false" />
										</ui:repeat>	
									</td>
								</tr>
							</ui:fragment>
							
							<tr>
								<td>
									<span class="resource_field">
										#{msg.source}: 
									</span>
								</td>
								<td style="overflow:hidden;">
									<a href="#{result.resource.urlProxied}"><h:outputText value="#{result.resource.source}" /></a>
									<span style="display:inline-block; width:300px;"> </span>
								</td>
							</tr>		
							
							<ui:fragment rendered="${not empty result.resource.group}">
								<tr>
									<td>
										<span class="resource_field">
											#{msg.group}: 
										</span>
									</td>
									<td>
										<h:outputLink value="group/overview.jsf" style="display:inline-block; margin-right:1rem;">
											<f:param name="group_id" value="#{result.resource.group.id}" />
											<h:outputText value="#{result.resource.group.title}" />
										</h:outputLink>
									</td>
								</tr>
							</ui:fragment>
							<ui:fragment rendered="${not empty result.resource.originalGroup}">
								<tr>
									<td>
										<span class="resource_field">
											#{msg.copied_from}: 
										</span>
									</td>
									<td>
										<h:outputLink value="group/overview.jsf" style="display:inline-block; margin-right:1rem;">
											<f:param name="group_id" value="#{result.resource.originalGroup.id}" />
											<h:outputText value="#{result.resource.originalGroup.title}" />
										</h:outputLink>
									</td>
								</tr>
							</ui:fragment>
							<ui:fragment rendered="${result.resource.source == 'TED' or result.resource.source == 'TEDx'}">
								<tr>
									<td>
										<span class="resource_field">
											#{msg.transcript}: 
										</span>
									</td>
									<td>
										<h:outputLink value="ted_transcript.jsf" style="text-decoration:underline;">
											<f:param name="resource_id" value="#{result.resource.id}" />
											#{msg.link_to_transcript}
										</h:outputLink>
									</td>
								</tr>
							</ui:fragment>							
							<ui:fragment rendered="${not empty result.resource.creationDate}">
								<tr>
									<td>
										<span class="resource_field">
											#{msg.date}:
										</span>
									</td>
									<td>
										<h:outputText value="#{result.resource.creationDate}">
											<f:convertDateTime type="date" dateStyle="long" timeZone="#{userBean.timeZone}"/>
										</h:outputText>
									</td>
								</tr>
							</ui:fragment>
							<ui:fragment rendered="#{result.resource.folderId != 0}">
								<tr>
									<td>
										<span class="resource_field">
											#{msg.path}:
										</span>
									</td>
									<td>
										<h:outputText value="#{result.resource.prettyPath}" />
									</td>
								</tr>
							</ui:fragment>
							
												
							<ui:repeat var="entry" value="#{result.resource.metadataEntries}">
								<ui:fragment rendered="#{not empty entry.value}">
									<tr>
										<td>
											<span class="resource_field">
												<h:outputText value="${utilBean.getLocaleMessage(entry.key, null)}" />: 
											</span>
										</td>
										<td>
											<h:outputText value="#{entry.value}" />									
										</td>
									</tr>
								</ui:fragment>
							</ui:repeat>
							
							
							<tr>
								<td>
									<span class="resource_field">
										Example:
									</span>
								</td>
								<td>
									<h:outputText value="#{result.resource.metadataWrapper['author']}" />
									<h:outputText value="#{result.resource.metadataWrapper['yell_media_type']}" />
								</td>
							</tr>
							
						</table>
	
						<h:panelGroup rendered="#{not empty result.resource.description}">
							<div class="resource_field" style="padding-top: 10px">
								#{msg.description}
							</div>
							<h:outputText id="resource_description" value="#{result.resource.descriptionHTML}" escape="false" />
						</h:panelGroup>

					</div>
				</ui:repeat>
			</h:panelGroup>

			<h:outputText value="${msg.no_resources_found}" class="nothing_found"
						  rendered="#{advSearchBean.paginator.isEmpty() and advSearchBean.paginator.getClass().getSimpleName() eq 'GroupPaginator'}"/>

			<h:outputText value="#{msg.no_results_found}" class="nothing_found"
						  rendered="#{advSearchBean.paginator.isEmpty() and advSearchBean.paginator.getClass().getSimpleName() eq 'SearchPaginator'}"/>

		</h:panelGroup>

		<h:panelGroup id="paginator" layout="block">
			<ui:decorate template="/templates/main/paging.xhtml">
				<ui:param name="paginator" value="${advSearchBean.paginator}" />
			</ui:decorate>
		</h:panelGroup>
	
	
		
		<script type="text/javascript">
			$("#center_pane").prepend($("#group_header")).append($("#paginator"));
		</script>

	</ui:define>
</ui:composition>