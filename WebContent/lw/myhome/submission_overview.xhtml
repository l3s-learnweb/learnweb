<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
				xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
				xmlns:h="http://xmlns.jcp.org/jsf/html"
				xmlns:f="http://xmlns.jcp.org/jsf/core"
				xmlns:p="http://primefaces.org/ui">

<ui:param name="rightPane" value="true"/>
	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="user_id" value="#{submissionBean.userId}" />
            <f:viewParam name="resource_id" value="#{rightPaneBean.resourceId}"/>
			<f:viewAction action="#{rightPaneBean.onLoad}"/>
			<f:viewAction action="#{submissionBean.onLoad}"/>
		</f:metadata>
	</ui:define>

	<ui:param name="loginRequired" value="true" />
	<ui:param name="pageTitle" value="#{msg['Submission.overview_title']}" />
	<ui:param name="helpText" value=""/>
	<ui:define name="sub_breadcrumb">
		<p:menuitem value="#{msg['Submission.overview_title']}" url="myhome/submission_overview.jsf#"/>
	</ui:define>
	<ui:define name="center_layout">

		<!--<h:form>
			<p:remoteCommand name="resourceAddedHook" update=":resourcesView" />
			<p:remoteCommand name="resourceUpdatedHook" update=":resourcesView" />
		</h:form>-->

		<h:panelGroup styleClass="section-resource-submission" layout="block">
			<ui:fragment rendered="#{userBean.isMemberOfCourse(1297)}">
				<p:panel>
					Links to the resources that you have submitted:
					<ul>
						<ui:repeat var="submission" value="#{submissionBean.pastSubmissions}">
							<ui:repeat var="res" value="#{submission.submittedResources}">
								<li>
									<a href="#{learnwebBean.learnweb.secureServerUrl}/lw/myhome/submission_overview.jsf?user_id=#{submissionBean.userId}&amp;resource_id=#{res.id}">
										#{learnwebBean.learnweb.secureServerUrl}/lw/myhome/submission_overview.jsf?user_id=#{submissionBean.userId}&amp;resource_id=#{res.id}
									</a>
								</li>
							</ui:repeat>
						</ui:repeat>
					</ul>
					Link to the peer assessment form that you have to submit:
					<ul>
						<ui:repeat var="pair" value="#{submissionBean.peerAssessmentPairs}">
							<li>
								<a href="#{learnwebBean.learnweb.secureServerUrl}/lw/survey/answer.jsf?resource_id=#{pair.peerAssessment.id}&amp;user_id=#{submissionBean.userId}">
									#{learnwebBean.learnweb.secureServerUrl}/lw/survey/answer.jsf?resource_id=#{pair.peerAssessment.id}&amp;user_id=#{submissionBean.userId}
								</a>

								<h:outputText value=" Not submitted yet" rendered="#{not pair.peerAssessment.getAnswersOfUser(submissionBean.userId).submitted}" styleClass="red bold" />
								<h:outputText value=" Submitted successfully" rendered="#{pair.peerAssessment.getAnswersOfUser(submissionBean.userId).submitted}" styleClass="green bold" />
							</li>
						</ui:repeat>
					</ul>
				</p:panel>
			</ui:fragment>


			<p:dialog header="#{msg['Submission.edit_submission']}"  styleClass="submission-dialog" id="edit_submission_dialog1" draggable="false" resizable="false" modal="true" appendTo="@(body)" widgetVar="submission_edit_dialog">
				<h:form prependId="false">

						<h:outputText value="#{msg.title}:" title="#{msg.title}" styleClass="font-weight-bold"/>
						<p:inputText styleClass="w-100 mb-3" value="#{submissionBean.selectedSubmission.title}"/>

						<h:outputText value="#{msg.course}:" title="#{msg.course}" styleClass="font-weight-bold"/>
						<p:selectOneMenu  styleClass="w-100 mb-3" value="#{submissionBean.selectedSubmission.courseId}">
							<f:selectItems var="course" value="#{userBean.user.courses}" itemLabel="#{course.title}" itemValue="#{course.id}"/>
							<f:ajax listener="#{submissionBean.onEditSurveyChangeCourse}"
									render="edit_dialog_survey_menu" onevent="courseChange"/>
						</p:selectOneMenu>

						<h:outputText value="#{msg.description}:" title="#{msg.description}" styleClass="font-weight-bold"/>
						<p:inputTextarea autoResize="1" maxHeight="20" rows="2" value="#{submissionBean.selectedSubmission.description}" styleClass="w-100 mb-3"/>

						<div class="d-flex flex-column w-100 mb-3 ">
							<h:outputText value="#{msg['Submission.open_date']}:" styleClass="font-weight-bold" />
							<p:calendar styleClass="submission_dialog_select" value="#{submissionBean.selectedSubmission.openDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button" />
						</div>
						<div class="d-flex flex-column w-100 mb-3 ">
							<h:outputText  value="#{msg['Submission.close_date']}:" styleClass="font-weight-bold" />
							<p:calendar styleClass="submission_dialog_select" value="#{submissionBean.selectedSubmission.closeDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button" />
						</div>


						<h:outputText value="#{msg['Submission.max_resources']}:" styleClass="font-weight-bold"/>
						<p:inputText styleClass="w-100 mb-3" value="#{submissionBean.selectedSubmission.noOfResources}"/>

                        <div class="w-100 mb-3">
                            <h:outputText value="#{msg['Submission.survey_mandatory']}" styleClass="font-weight-bold mr-2"/>
                            <p:selectBooleanCheckbox value="#{submissionBean.selectedSubmission.surveyMandatory}" widgetVar="editSurveyCheckBox">
                                <p:ajax update=":edit_dialog_survey_menu" oncomplete="toggleSurveySelectField(editSurveyCheckBox.input.is(':checked'), 'edit');"/>
                            </p:selectBooleanCheckbox>
                        </div>


						<h:outputText id="edit_dialog_survey_text" value="#{msg['Submission.survey']}:" style="display:none;" styleClass="font-weight-bold "/>
						<p:selectOneMenu styleClass="w-100 mb-3" id="edit_dialog_survey_menu" value="#{submissionBean.selectedSubmission.surveyResourceId}" style="display:none;" required="#{submissionBean.selectedSubmission.surveyMandatory}" requiredMessage="#{msg['Submission.survey_required']}">
							<f:selectItem itemLabel="Select Survey Resource" itemValue="-1"/>
							<f:selectItems value="#{submissionBean.editSurveyResourcesList}"/>
						</p:selectOneMenu>

						<div class="w-100 mt-3">
							<p:commandButton value="#{msg.delete}" styleClass="command-button" onclick="return confirmSubmissionDelete('#{submissionBean.selectedSubmission.title}');" update=":submissions" actionListener="#{submissionBean.deleteSubmission()}" oncomplete="addSubmissionHeaderClickHandler();"/>
							<p:commandButton value="#{msg.save}" styleClass="command-button float-right" onclick="PF('submission_edit_dialog').hide();" update=":submissions" actionListener="#{submissionBean.updateSubmissionDetails()}" oncomplete="addSubmissionHeaderClickHandler();"/>
						</div>

				</h:form>
			</p:dialog>

			<p:dialog header="#{msg['Submission.create_new_submission']}" styleClass="submission-dialog" id="create_submission_dialog1" draggable="false" resizable="false" modal="true" appendTo="@(body)" widgetVar="create_submission_dialog">
				<h:form prependId="false">

					<h:outputText value="#{msg.title}:" styleClass="font-weight-bold" title="#{msg.title}:"/>
					<p:inputText id="title_input" styleClass="w-100 mb-3" value="#{submissionBean.newSubmission.title}"/>
					<p:message for="title_input" display="icon" />


					<h:outputText value="#{msg.course}:" styleClass="font-weight-bold" title="#{msg.course}:"/>
					<p:selectOneMenu styleClass="w-100 mb-3"  value="#{submissionBean.newSubmission.courseId}">
						<f:selectItem itemLabel="Select Course" />
						<f:selectItems var="course" value="#{userBean.user.courses}" itemLabel="#{course.title}" itemValue="#{course.id}"/>
						<f:ajax listener="#{submissionBean.onCreateSurveyChangeCourse}"
								render="create_dialog_survey_menu" onevent="courseChange"/>
					</p:selectOneMenu>
					<h:outputText value="" />

					<h:outputText value="#{msg.description}:" title="#{msg.description}:" styleClass="font-weight-bold" />
					<p:inputTextarea  id="description" autoResize="1" rows="2" maxHeight="20" value="#{submissionBean.newSubmission.description}" styleClass="w-100 mb-3"/>
					<p:message for="description" display="icon" />


					<div class="d-flex flex-column w-100 mb-3 ">
						<h:outputText value="#{msg['Submission.open_date']}:" styleClass="font-weight-bold"/>
						<p:calendar styleClass="w-100" id="open_date" value="#{submissionBean.newSubmission.openDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button"/>
						<p:message for="open_date" display="icon" />
					</div>

					<div class="d-flex flex-column w-100 mb-3 ">
						<h:outputText value="#{msg['Submission.close_date']}:" styleClass="font-weight-bold"/>
						<p:calendar styleClass="w-100" id="close_date" value="#{submissionBean.newSubmission.closeDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button"/>
						<p:message for="close_date" display="icon" />
					</div>



					<h:outputText value="#{msg['Submission.max_resources']}:" styleClass="font-weight-bold"/>
					<p:inputText styleClass="w-100 mb-3" id="max_resources" value="#{submissionBean.newSubmission.noOfResources}"/>
					<p:message for="max_resources" display="icon" />

                    <div class="w-100 mb-3">
                        <h:outputText value="#{msg['Submission.survey_mandatory']}" styleClass="font-weight-bold mr-2"/>
                        <p:selectBooleanCheckbox value="#{submissionBean.newSubmission.surveyMandatory}" widgetVar="surveyCheckBox" id="survey_checkbox">
                            <p:ajax update=":create_dialog_survey_menu" oncomplete="toggleSurveySelectField(surveyCheckBox.input.is(':checked'), 'create');"/>
                        </p:selectBooleanCheckbox>
                        <p:message for="survey_checkbox" display="icon" />
                    </div>

					<h:outputText id="create_dialog_survey_text" value="#{msg['Submission.survey']}:" style="display:none;" styleClass="font-weight-bold"/>
					<p:selectOneMenu styleClass="w-100 mb-3" id="create_dialog_survey_menu" value="#{submissionBean.newSubmission.surveyResourceId}" style="display:none;" required="#{submissionBean.newSubmission.surveyMandatory}" requiredMessage="#{msg['Submission.survey_required']}">
						<f:selectItem itemLabel="Select Survey Resource" />
						<f:selectItems value="#{submissionBean.surveyResourcesList}"/>
					</p:selectOneMenu>
					<p:message id="create_dialog_survey_menu_message" for="create_dialog_survey_menu" display="icon" />

					<p:commandButton value="#{msg.save}" styleClass="command-button mt-3 float-right" update=":submissions :create_submission_dialog1" actionListener="#{submissionBean.createNewSubmission()}" oncomplete="handleDialogSubmit(xhr, status, args, 'create_submission_dialog')"/>

				</h:form>
			</p:dialog>

			<div>
				<h:outputText id="no_submissions" rendered="#{empty submissionBean.pastSubmissions and empty submissionBean.currentSubmissions and empty submissionBean.futureSubmissions}" value="#{msg['Submission.no_submissions_message']}"/>
			</div>

			<p:accordionPanel styleClass="submission-accordion" id="submissions">
				<p:tab title="#{msg['Submission.current_submissions']} (#{submissionBean.currentSubmissions.size()})" rendered="#{not empty submissionBean.currentSubmissions}">
					<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
						<ui:param name="submissions" value="#{submissionBean.currentSubmissions}" />
					</ui:decorate>
				</p:tab>
				<p:tab title="#{msg['Submission.past_submissions']} (#{submissionBean.pastSubmissions.size()})" rendered="#{not empty submissionBean.pastSubmissions}">
					<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
						<ui:param name="submissions" value="#{submissionBean.pastSubmissions}" />
					</ui:decorate>
				</p:tab>

				<p:tab title="#{msg['Submission.future_submissions']} (#{submissionBean.futureSubmissions.size()})" rendered="#{not empty submissionBean.futureSubmissions}">
					<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
						<ui:param name="submissions" value="#{submissionBean.futureSubmissions}" />
					</ui:decorate>
				</p:tab>
			</p:accordionPanel>


			<!--<h:panelGroup  id="submissions" layout="block">

				<h:panelGroup id="past_submissions" layout="block" rendered="#{not empty submissionBean.pastSubmissions}">
					<div class="submission_header">
						<div><h2 class="h2 mb-0 p-2">#{msg['Submission.past_submissions']} (${submissionBean.pastSubmissions.size()})<span
								class="icon_wrapper"><i class="fa fa-caret-right" /></span></h2></div>
					</div>
					<div class="submission_cards">
						<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
							<ui:param name="submissions" value="#{submissionBean.pastSubmissions}" />
						</ui:decorate>
					</div>
				</h:panelGroup>
				<h:panelGroup id="current_submissions" styleClass="mt-3" layout="block" rendered="#{not empty submissionBean.currentSubmissions}">
					<div class="">
						<div><h2 class="h2 mb-0 p-2"> <span
								class="icon_wrapper"><i class="fa fa-caret-right" /></span></h2></div>
					</div>
					<div class="submission_cards">
						<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
							<ui:param name="submissions" value="#{submissionBean.currentSubmissions}" />
						</ui:decorate>
					</div>
				</h:panelGroup>
				<h:panelGroup id="future_submissions" styleClass="mt-3" layout="block" rendered="#{not empty submissionBean.futureSubmissions}">
					<div class="submission_header">
						<div><h2 class="h2 mb-0 p-2"> <span
								class="icon_wrapper"><i class="fa fa-caret-right" /></span> </h2></div>
					</div>
					<div class="submission_cards">
						<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
							<ui:param name="submissions" value="#{submissionBean.futureSubmissions}" />
						</ui:decorate>
					</div>
				</h:panelGroup>
				<br/>

			</h:panelGroup>-->

				<p:panel styleClass="mt-3">
					<h:form prependId="false">
						<p:commandLink styleClass="command-button admin-element" title="#{msg['Submission.create_new_submission']}" rendered="#{(userBean.moderator) and not submissionBean.submissionOverviewReadOnly}"
									   process="@this" oncomplete="PF('create_submission_dialog').show();">
							#{msg['Submission.create_new_submission']}
						</p:commandLink>
					</h:form>
				</p:panel>



			<h:panelGroup id="datagrid" class="not-selectable d-none"></h:panelGroup>
		</h:panelGroup>

		<script type="text/javascript">
			function addSubmissionHeaderClickHandler(){
				$('.submission_header').on('click', function(){
					$(this).toggleClass('active');
					$(this).siblings().slideToggle();
					$(this).find(".fa-caret-right").toggleClass('open');
				});
			}

			function clickCurrentSubmissions(){
				$('#current_submissions > .submission_header').trigger("click");
			}

			var scrollPos;
			function saveScrollPos(event){
				scrollPos = $(event.currentTarget).get(0).offsetTop;
			}

			function setScrollPos(){
				$('.nano').nanoScroller({scrollTop: scrollPos});
			}

			function toggleSurveySelectField(show, surveySelectType)
			{
				var selectFieldIdPrefix = surveySelectType === "edit" ? "#edit_dialog_survey" : "#create_dialog_survey";
				if(show)
				{
					$(selectFieldIdPrefix + '_text').show();
					$(selectFieldIdPrefix + '_menu').show();
				}
				else
				{
					$(selectFieldIdPrefix + '_text').hide();
					$(selectFieldIdPrefix + '_menu').hide();
					$(selectFieldIdPrefix + '_menu_message').hide();
				}
			}

			function handleDialogSubmit(xhr, status, args, dialogWidgetVar) {
				if (args.validationFailed) {
					PF(dialogWidgetVar).show();
					var surveySelectType = dialogWidgetVar === 'create_submission_dialog' ? 'create' : 'edit';
					toggleSurveySelectField(surveyCheckBox.input.is(':checked'), surveySelectType);
				} else {
					PF(dialogWidgetVar).hide();
					addSubmissionHeaderClickHandler();
				}
			}

			function courseChange(data)
			{
				var status = data.status;
				if(status === "success")
				{
					toggleSurveySelectField(surveyCheckBox.input.is(':checked'), 'create');
					toggleSurveySelectField(editSurveyCheckBox.input.is(':checked'), 'edit');
				}
			}

			function confirmSubmissionDelete(submissionTitle)
			{
				var status = confirm('Are you sure you want to delete this submission "' + submissionTitle +'" ?');
				if(status)
					PF('submission_edit_dialog').hide();

				return status;
			}
			$(document).ready(function(){
				addSubmissionHeaderClickHandler();
				toggleSurveySelectField(surveyCheckBox.input.is(':checked'), 'create');
				toggleSurveySelectField(editSurveyCheckBox.input.is(':checked'), 'edit');
				$('#current_submissions .submission_header').click();
			});
		</script>
	</ui:define>
	<ui:define name="right_layout">
		<ui:decorate  template="/templates/resources/right_pane.xhtml">
			<ui:param name="bean" value="#{submissionBean}" />
		</ui:decorate>
	</ui:define>
</ui:composition>