<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	lang="#{userBean.localeCode}">

	<ui:composition template="/templates/main/main_old.xhtml">
	
		<ui:define name="metadata">
			<f:metadata>
				<f:viewParam name="user_id" value="#{submitResourcesBean.userId}" />
				<f:event type="javax.faces.event.PreRenderViewEvent" listener="#{resourceDetailBean.preRenderView}" />
				<f:event type="javax.faces.event.PreRenderViewEvent" listener="#{submitResourcesBean.preRenderView}"/>
			</f:metadata>
		</ui:define>
		
		<ui:param name="loginRequired" value="true" />
		<ui:param name="pageTitle" value="#{msg['Submission.overview_title']}" />
		<ui:param name="helpText" value=""/>	
	
		<ui:define name="center_layout">
			<script type="text/javascript">
			function addSubmissionHeaderClickHandler(){
				$('.submission_header').on('click', function(){
			    	$(this).toggleClass('active');
			    	$(this).siblings().slideToggle();
			    });
			}
			
			function toggleSurveySelectField(show, surveySelectType)
			{
				var selectFieldIdPrefix = surveySelectType == "edit" ? "#edit_survey" : "#survey";
			    if(show)
			    {
			    	$(selectFieldIdPrefix + '_url').show();
			        $(selectFieldIdPrefix + '_url_input').show();
			    }
			   	else
			   	{
			    	$(selectFieldIdPrefix + '_url').hide();
			        $(selectFieldIdPrefix + '_url_input').hide();
			        $(selectFieldIdPrefix + '_url_input_message').hide();
			    }
			}

			function handleDialogSubmit(xhr, status, args, dialogWidgetVar) {
		        if (args.validationFailed) {
		        	PF(dialogWidgetVar).show();
		        	var surveySelectType = dialogWidgetVar == 'create_submission_dialog' ? 'create' : 'edit';
		        	toggleSurveySelectField(surveyCheckBox.input.is(':checked'), surveySelectType);
		        } else {
		        	PF(dialogWidgetVar).hide();
		        	addSubmissionHeaderClickHandler();
		        }
		    }
			
			function courseChange(data)
			{
				var status = data.status;
				if(status == "success")
				{
					toggleSurveySelectField(surveyCheckBox.input.is(':checked'), 'create');
					toggleSurveySelectField(editSurveyCheckBox.input.is(':checked'), 'edit');
				}
			}
			
			function confirmSubmissionDelete(submissionTitle)
			{
				var status = confirm('Are you sure you want to delete this submission "' + submissionTitle +'" ?');
				if(status)
					PF('submission_edit_dialog').hide();
				
				return status;
			}
			
			$(document).ready(function(){
				addSubmissionHeaderClickHandler();
				toggleSurveySelectField(surveyCheckBox.input.is(':checked'), 'create');
				toggleSurveySelectField(editSurveyCheckBox.input.is(':checked'), 'edit');
			});
			</script>
			<h:form>
				<p:remoteCommand name="selectGroupItemCommand" actionListener="#{submitResourcesBean.actionSelectGroupItem}" update=":add_resource_panel :growl" oncomplete="update_header();load_editor(); "/>
			</h:form>
			
			<h:outputStylesheet library="resource-submission" name="submit.css" />
			
			<p:dialog header="#{msg['Submission.edit_submission']}" id="edit_submission_dialog1" modal="true" minWidth="440" appendTo="@(body)" widgetVar="submission_edit_dialog">
				<h:form id="submission_dialog_form" prependId="false">
					<p:panelGrid styleClass="ui-noborder">
					
						<p:row>
							<p:column><h:outputText value="#{msg.title}" title="#{msg.title}"/></p:column> 
							<p:column><p:inputText value="#{submitResourcesBean.selectedSubmission.title}"/></p:column>
						</p:row>
						
						<p:row>
							<p:column><h:outputText value="#{msg.course}" title="#{msg.course}"/></p:column>
							<p:column>
							<h:selectOneMenu value="#{submitResourcesBean.selectedSubmission.courseId}" style="width:22rem;">	
								<f:selectItems var="course" value="#{userBean.user.courses}" itemLabel="#{course.title}" itemValue="#{course.id}"/>
								<f:ajax listener="#{submitResourcesBean.onEditSurveyChangeCourse}"
									render="edit_survey_url_input" onevent="courseChange"/>
							</h:selectOneMenu>
							</p:column>
						</p:row>
						
						<p:row>
							<p:column><h:outputText value="#{msg.description}" title="#{msg.description}"/></p:column> 
							<p:column><p:inputTextarea autoResize="1" maxHeight="20" value="#{submitResourcesBean.selectedSubmission.description}" styleClass="resource_dialog_field"/></p:column>
						</p:row>
						
						<p:row>
							<p:column><h:outputText value="#{msg['Submission.open_date']}"/></p:column>
							<p:column><p:calendar value="#{submitResourcesBean.selectedSubmission.openDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button"/></p:column>
						</p:row>
						
						<p:row>
							<p:column><h:outputText value="#{msg['Submission.close_date']}"/></p:column>
							<p:column><p:calendar value="#{submitResourcesBean.selectedSubmission.closeDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button"/></p:column>
						</p:row>
						
						<p:row>
							<p:column><h:outputText value="#{msg['Submission.max_resources']}"/></p:column>
							<p:column><p:inputText value="#{submitResourcesBean.selectedSubmission.noOfResources}"/></p:column>
						</p:row>
						
						<p:row>
							<p:column><h:outputText value="#{msg['Submission.survey_mandatory']}"/></p:column>
							<p:column>
							<p:selectBooleanCheckbox value="#{submitResourcesBean.selectedSubmission.surveyMandatory}" widgetVar="editSurveyCheckBox">
								<p:ajax update=":edit_survey_url_input" oncomplete="toggleSurveySelectField(editSurveyCheckBox.input.is(':checked'), 'edit');"/>
							</p:selectBooleanCheckbox>
							</p:column>
						</p:row>
						
						<p:row>
							<p:column><h:outputText id="edit_survey_url" value="#{msg['Submission.survey_url']}" style="display:none;"/></p:column>
							<p:column>
							<h:selectOneMenu id="edit_survey_url_input" value="#{submitResourcesBean.selectedSubmission.surveyResourceId}" style="display:none;width:22rem;" required="#{submitResourcesBean.selectedSubmission.surveyMandatory}" requiredMessage="#{msg['Submission.survey_url_required']}">	
								<f:selectItem itemLabel="Select Survey Resource" itemValue="-1"/>
								<f:selectItems value="#{submitResourcesBean.editSurveyResourcesList}"/>
							</h:selectOneMenu>
							</p:column>
						</p:row>
						
						<p:row>
							<p:column><p:commandButton value="#{msg.save}" styleClass="greenbutton" onclick="PF('submission_edit_dialog').hide();" update=":submissions" actionListener="#{submitResourcesBean.updateSubmissionDetails()}" oncomplete="addSubmissionHeaderClickHandler();"/></p:column>
							<p:column><h:outputText value=""/></p:column> 
						</p:row>
						
						<p:row>
							<p:column colspan="2"><p:separator /></p:column>
						</p:row>
						
						<p:row>
							<p:column><p:commandButton value="#{msg.delete}" styleClass="greenbutton" onclick="return confirmSubmissionDelete('#{submitResourcesBean.selectedSubmission.title}');" update=":submissions" actionListener="#{submitResourcesBean.deleteSubmission()}" oncomplete="addSubmissionHeaderClickHandler();"/></p:column>
							<p:column><h:outputText value=""/></p:column> 
						</p:row>
						
					</p:panelGrid>	
				</h:form>
			</p:dialog>
		
			<p:dialog header="#{msg['Submission.create_new_submission']}" id="create_submission_dialog1" modal="true" minWidth="440" appendTo="@(body)" widgetVar="create_submission_dialog">
				<h:form id="create_submission_dialog_form" prependId="false">
				<h:panelGrid columns="3">
				
					<h:outputText value="#{msg.title}" title="#{msg.title}"/>
					<p:inputText id="title_input" value="#{submitResourcesBean.newSubmission.title}"/>
					<p:message for="title_input" display="icon" />
					
					<h:outputText value="#{msg.course}" title="#{msg.course}"/>
					<h:selectOneMenu value="#{submitResourcesBean.newSubmission.courseId}" style="width:22rem;">	
						<f:selectItem itemLabel="-- Select Course--" />
						<f:selectItems var="course" value="#{userBean.user.courses}" itemLabel="#{course.title}" itemValue="#{course.id}"/>
						<f:ajax listener="#{submitResourcesBean.onCreateSurveyChangeCourse}"
								render="survey_url_input" onevent="courseChange"/>
					</h:selectOneMenu>
					<h:outputText value="" />
							
					<h:outputText value="#{msg.description}" title="#{msg.description}"/> 
					<p:inputTextarea id="description" autoResize="1" maxHeight="20" value="#{submitResourcesBean.newSubmission.description}" styleClass="resource_dialog_field"/>
					<p:message for="description" display="icon" />
					
					<h:outputText value="#{msg['Submission.open_date']}"/>
					<p:calendar id="open_date" value="#{submitResourcesBean.newSubmission.openDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button"/>
					<p:message for="open_date" display="icon" />
					
					<h:outputText value="#{msg['Submission.close_date']}"/>
					<p:calendar id="close_date" value="#{submitResourcesBean.newSubmission.closeDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button"/>
					<p:message for="close_date" display="icon" />
					
					<h:outputText value="#{msg['Submission.max_resources']}"/>
					<p:inputText id="max_resources" value="#{submitResourcesBean.newSubmission.noOfResources}"/>
					<p:message for="max_resources" display="icon" />
					
					<h:outputText value="#{msg['Submission.survey_mandatory']}"/>
					<p:selectBooleanCheckbox value="#{submitResourcesBean.newSubmission.surveyMandatory}" widgetVar="surveyCheckBox" id="survey_checkbox">
						<p:ajax update=":survey_url_input" oncomplete="toggleSurveySelectField(surveyCheckBox.input.is(':checked'), 'create');"/>
					</p:selectBooleanCheckbox>
					<p:message for="survey_checkbox" display="icon" />
					
					<h:outputText id="survey_url" value="#{msg['Submission.survey_url']}" style="display:none;"/>
					<h:selectOneMenu id="survey_url_input" value="#{submitResourcesBean.newSubmission.surveyResourceId}" style="display:none;width:22rem;" required="#{submitResourcesBean.newSubmission.surveyMandatory}" requiredMessage="#{msg['Submission.survey_url_required']}">	
						<f:selectItem itemLabel="Select Survey Resource" />
						<f:selectItems value="#{submitResourcesBean.surveyResourcesList}"/>
					</h:selectOneMenu>
					<p:message id="survey_url_input_message" for="survey_url_input" display="icon" />
					
					<p:commandButton value="#{msg.save}" styleClass="greenbutton" update=":submissions :create_submission_dialog1" actionListener="#{submitResourcesBean.createNewSubmission()}" oncomplete="handleDialogSubmit(xhr, status, args, 'create_submission_dialog')"/>
					<h:outputText value=""/>
					<h:outputText value=""/>
				</h:panelGrid>	
				</h:form>
			</p:dialog>
			
			<div class="page_header">
				<span>
					<h:outputText value="#{msg['Submission.overview']}" rendered="#{not userBean.moderator || submitResourcesBean.submissionOverviewReadOnly}"/>
					<h:outputText value="Submission Forms Overview" rendered="#{userBean.moderator and not submitResourcesBean.submissionOverviewReadOnly}"/>
				</span>
			</div>
			<h:panelGroup id="submissions" layout="block" style="margin-bottom: 30px;">
				<div>
					<h:outputText id="no_submissions" rendered="${submitResourcesBean.pastSubmissions.size() == 0 and submitResourcesBean.currentSubmissions.size() == 0 and submitResourcesBean.futureSubmissions.size() == 0}" value="#{msg['Submission.no_submissions_message']}"/>
				</div>
				<h:panelGroup id="past_submissions" layout="block" rendered="${submitResourcesBean.pastSubmissions.size() > 0}">
					<div class="submission_header">
						<div style="margin-top:10px;"><h1>#{msg['Submission.past_submissions']} (${submitResourcesBean.pastSubmissions.size()})</h1></div>
					</div>
					<div class="submission_cards">
						<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
							<ui:param name="submissions" value="#{submitResourcesBean.pastSubmissions}" />
						</ui:decorate>
					</div>
				</h:panelGroup>
				<h:panelGroup id="current_submissions" layout="block" rendered="${submitResourcesBean.currentSubmissions.size() > 0}">
					<div class="submission_header">
						<div style="margin-top:10px;"><h1>#{msg['Submission.current_submissions']} (${submitResourcesBean.currentSubmissions.size()})</h1></div>
					</div>
					<div class="submission_cards">
						<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
							<ui:param name="submissions" value="#{submitResourcesBean.currentSubmissions}" />
						</ui:decorate>
					</div>
				</h:panelGroup>
				<h:panelGroup id="future_submissions" layout="block" rendered="${submitResourcesBean.futureSubmissions.size() > 0}">
					<div class="submission_header">
						<div style="margin-top:10px;"><h1>#{msg['Submission.future_submissions']} (${submitResourcesBean.futureSubmissions.size()})</h1></div>
					</div>
					<div class="submission_cards">
						<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
							<ui:param name="submissions" value="#{submitResourcesBean.futureSubmissions}" />
						</ui:decorate>
					</div>
				</h:panelGroup>
				<br/>
				<h:form prependId="false">
					<p:commandLink styleClass="greenbutton" style="margin-top:20px;text-decoration:none;" title="#{msg['Submission.create_new_submission']}" rendered="#{(userBean.admin || userBean.moderator) and not submitResourcesBean.submissionOverviewReadOnly}"
								process="@this" oncomplete="PF('create_submission_dialog').show();">
								#{msg['Submission.create_new_submission']}
					</p:commandLink>
				</h:form>
			</h:panelGroup>
			<h:panelGroup id="datagrid" class="not-selectable display-none"></h:panelGroup>			
		</ui:define>
		<ui:define name="right_layout">
			<ui:decorate  template="/templates/resources/right_pane.xhtml">
				<ui:param name="bean" value="#{submitResourcesBean}" />
			</ui:decorate>
		</ui:define>
	</ui:composition>
</html>