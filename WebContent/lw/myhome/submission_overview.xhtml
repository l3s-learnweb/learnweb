<ui:composition template="/templates/main/main_old.xhtml"
				xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
				xmlns:h="http://xmlns.jcp.org/jsf/html"
				xmlns:f="http://xmlns.jcp.org/jsf/core"
				xmlns:p="http://primefaces.org/ui">

	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="user_id" value="#{submitResourcesBean.userId}" />
            <f:viewParam name="resource_id" value="#{rightPaneBean.resourceId}"/>
			<f:viewAction action="#{rightPaneBean.onLoad}"/>
			<f:event type="javax.faces.event.PreRenderViewEvent" listener="#{submitResourcesBean.preRenderView}"/>
		</f:metadata>
	</ui:define>

	<ui:param name="loginRequired" value="true" />
	<ui:param name="pageTitle" value="#{msg['Submission.overview_title']}" />
	<ui:param name="helpText" value=""/>	

	<ui:define name="center_layout">
		<script type="text/javascript">
		function addSubmissionHeaderClickHandler(){
			$('.submission_header').on('click', function(){
		    	$(this).toggleClass('active');
		    	$(this).siblings().slideToggle();
		    	$(this).find(".fa-caret-right").toggleClass('open');
		    });
		}
		
		function clickCurrentSubmissions(){
			$('#current_submissions > .submission_header').trigger("click");
		}
		
		var scrollPos;
		function saveScrollPos(event){
			scrollPos = $(event.currentTarget).get(0).offsetTop;
		}
		
		function setScrollPos(){
			$('.nano').nanoScroller({scrollTop: scrollPos});
		}
		
		function toggleSurveySelectField(show, surveySelectType)
		{
			var selectFieldIdPrefix = surveySelectType == "edit" ? "#edit_dialog_survey" : "#create_dialog_survey";
		    if(show)
		    {
		    	$(selectFieldIdPrefix + '_text').show();
		        $(selectFieldIdPrefix + '_menu').show();
		    }
		   	else
		   	{
		    	$(selectFieldIdPrefix + '_text').hide();
		        $(selectFieldIdPrefix + '_menu').hide();
		        $(selectFieldIdPrefix + '_menu_message').hide();
		    }
		}

		function handleDialogSubmit(xhr, status, args, dialogWidgetVar) {
	        if (args.validationFailed) {
	        	PF(dialogWidgetVar).show();
	        	var surveySelectType = dialogWidgetVar == 'create_submission_dialog' ? 'create' : 'edit';
	        	toggleSurveySelectField(surveyCheckBox.input.is(':checked'), surveySelectType);
	        } else {
	        	PF(dialogWidgetVar).hide();
	        	addSubmissionHeaderClickHandler();
	        }
	    }
		
		function courseChange(data)
		{
			var status = data.status;
			if(status == "success")
			{
				toggleSurveySelectField(surveyCheckBox.input.is(':checked'), 'create');
				toggleSurveySelectField(editSurveyCheckBox.input.is(':checked'), 'edit');
			}
		}
		
		function confirmSubmissionDelete(submissionTitle)
		{
			var status = confirm('Are you sure you want to delete this submission "' + submissionTitle +'" ?');
			if(status)
				PF('submission_edit_dialog').hide();
			
			return status;
		}
		$(document).ready(function(){
			addSubmissionHeaderClickHandler();
			toggleSurveySelectField(surveyCheckBox.input.is(':checked'), 'create');
			toggleSurveySelectField(editSurveyCheckBox.input.is(':checked'), 'edit');
			$('#current_submissions .submission_header').click();
		});
		</script>
		<h:form>
			<p:remoteCommand name="selectGroupItemCommand" actionListener="#{submitResourcesBean.actionSelectGroupItem}" update=":right_pane_wrapper :growl" oncomplete="update_header();load_editor(); "/>
		</h:form>

		<h:outputStylesheet library="resource-submission" name="submit.css" />

		<h:panelGroup id="resourcesView" layout="block">
			<!-- dummy for right pane -->
		</h:panelGroup>

		<ui:fragment rendered="#{userBean.isMemberOfCourse(1297)}">
			<p:panel>					
				Links to the resources that you have submitted:
				<ul style="margin-bottom:0.5rem">
					<ui:repeat var="submission" value="#{submitResourcesBean.pastSubmissions}">
						<ui:repeat var="res" value="#{submission.submittedResources}">
							<li>
								<a href="#{learnwebBean.learnweb.secureServerUrl}/lw/myhome/submission_overview.jsf?user_id=#{submitResourcesBean.userId}&amp;resource_id=#{res.id}">
									#{learnwebBean.learnweb.secureServerUrl}/lw/myhome/submission_overview.jsf?user_id=#{submitResourcesBean.userId}&amp;resource_id=#{res.id}
								</a>
							</li>
						</ui:repeat>
					</ui:repeat>
				</ul>
				Link to the peer assessment form that you have to submit:
				<ul>
					<ui:repeat var="pair" value="#{submitResourcesBean.peerAssessmentPairs}">
						<li>
							<a href="#{learnwebBean.learnweb.secureServerUrl}/lw/survey/answer.jsf?resource_id=#{pair.peerAssessment.id}&amp;user_id=#{submitResourcesBean.userId}">
								#{learnwebBean.learnweb.secureServerUrl}/lw/survey/answer.jsf?resource_id=#{pair.peerAssessment.id}&amp;user_id=#{submitResourcesBean.userId}
							</a>
							
							<h:outputText value=" Not submitted yet" rendered="#{not pair.peerAssessment.getAnswersOfUser(submitResourcesBean.userId).submitted}" styleClass="red bold" />
							<h:outputText value=" Submitted successfully" rendered="#{pair.peerAssessment.getAnswersOfUser(submitResourcesBean.userId).submitted}" styleClass="green bold" />
						</li>
					</ui:repeat>
				</ul>
			</p:panel>
			<br/>
		</ui:fragment>


		<p:dialog header="#{msg['Submission.edit_submission']}" id="edit_submission_dialog1" modal="true" minWidth="440" appendTo="@(body)" widgetVar="submission_edit_dialog">
			<h:form id="submission_dialog_form" prependId="false">
				<p:panelGrid styleClass="ui-noborder">
				
					<p:row>
						<p:column><h:outputText value="#{msg.title}" title="#{msg.title}"/></p:column> 
						<p:column><p:inputText value="#{submitResourcesBean.selectedSubmission.title}"/></p:column>
					</p:row>
					
					<p:row>
						<p:column><h:outputText value="#{msg.course}" title="#{msg.course}"/></p:column>
						<p:column>
						<h:selectOneMenu value="#{submitResourcesBean.selectedSubmission.courseId}" style="width:22rem;">	
							<f:selectItems var="course" value="#{userBean.user.courses}" itemLabel="#{course.title}" itemValue="#{course.id}"/>
							<f:ajax listener="#{submitResourcesBean.onEditSurveyChangeCourse}"
								render="edit_dialog_survey_menu" onevent="courseChange"/>
						</h:selectOneMenu>
						</p:column>
					</p:row>
					
					<p:row>
						<p:column><h:outputText value="#{msg.description}" title="#{msg.description}"/></p:column> 
						<p:column><p:inputTextarea autoResize="1" maxHeight="20" value="#{submitResourcesBean.selectedSubmission.description}" styleClass="resource_dialog_field"/></p:column>
					</p:row>
					
					<p:row>
						<p:column><h:outputText value="#{msg['Submission.open_date']}"/></p:column>
						<p:column><p:calendar value="#{submitResourcesBean.selectedSubmission.openDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button" /></p:column>
					</p:row>
					
					<p:row>
						<p:column><h:outputText value="#{msg['Submission.close_date']}"/></p:column>
						<p:column><p:calendar value="#{submitResourcesBean.selectedSubmission.closeDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button" /></p:column>
					</p:row>
					
					<p:row>
						<p:column><h:outputText value="#{msg['Submission.max_resources']}"/></p:column>
						<p:column><p:inputText value="#{submitResourcesBean.selectedSubmission.noOfResources}"/></p:column>
					</p:row>
					
					<p:row>
						<p:column><h:outputText value="#{msg['Submission.survey_mandatory']}"/></p:column>
						<p:column>
						<p:selectBooleanCheckbox value="#{submitResourcesBean.selectedSubmission.surveyMandatory}" widgetVar="editSurveyCheckBox">
							<p:ajax update=":edit_dialog_survey_menu" oncomplete="toggleSurveySelectField(editSurveyCheckBox.input.is(':checked'), 'edit');"/>
						</p:selectBooleanCheckbox>
						</p:column>
					</p:row>
					
					<p:row>
						<p:column><h:outputText id="edit_dialog_survey_text" value="#{msg['Submission.survey']}" style="display:none;"/></p:column>
						<p:column>
						<h:selectOneMenu id="edit_dialog_survey_menu" value="#{submitResourcesBean.selectedSubmission.surveyResourceId}" style="display:none;width:22rem;" required="#{submitResourcesBean.selectedSubmission.surveyMandatory}" requiredMessage="#{msg['Submission.survey_required']}">	
							<f:selectItem itemLabel="Select Survey Resource" itemValue="-1"/>
							<f:selectItems value="#{submitResourcesBean.editSurveyResourcesList}"/>
						</h:selectOneMenu>
						</p:column>
					</p:row>
					
					<p:row>
						<p:column colspan="2">
							<p:commandButton value="#{msg.delete}" styleClass="graybutton float-right" onclick="return confirmSubmissionDelete('#{submitResourcesBean.selectedSubmission.title}');" update=":submissions" actionListener="#{submitResourcesBean.deleteSubmission()}" oncomplete="addSubmissionHeaderClickHandler();"/>
							<p:commandButton value="#{msg.save}" styleClass="greenbutton" onclick="PF('submission_edit_dialog').hide();" update=":submissions" actionListener="#{submitResourcesBean.updateSubmissionDetails()}" oncomplete="addSubmissionHeaderClickHandler();"/>
						</p:column>
					</p:row>
					
					
				</p:panelGrid>	
			</h:form>
		</p:dialog>
	
		<p:dialog header="#{msg['Submission.create_new_submission']}" id="create_submission_dialog1" modal="true" minWidth="440" appendTo="@(body)" widgetVar="create_submission_dialog">
			<h:form id="create_submission_dialog_form" prependId="false">
			<h:panelGrid columns="3">
			
				<h:outputText value="#{msg.title}" title="#{msg.title}"/>
				<p:inputText id="title_input" value="#{submitResourcesBean.newSubmission.title}"/>
				<p:message for="title_input" display="icon" />
				
				<h:outputText value="#{msg.course}" title="#{msg.course}"/>
				<h:selectOneMenu value="#{submitResourcesBean.newSubmission.courseId}" style="width:22rem;">	
					<f:selectItem itemLabel="-- Select Course--" />
					<f:selectItems var="course" value="#{userBean.user.courses}" itemLabel="#{course.title}" itemValue="#{course.id}"/>
					<f:ajax listener="#{submitResourcesBean.onCreateSurveyChangeCourse}"
							render="create_dialog_survey_menu" onevent="courseChange"/>
				</h:selectOneMenu>
				<h:outputText value="" />
						
				<h:outputText value="#{msg.description}" title="#{msg.description}"/> 
				<p:inputTextarea id="description" autoResize="1" maxHeight="20" value="#{submitResourcesBean.newSubmission.description}" styleClass="resource_dialog_field"/>
				<p:message for="description" display="icon" />
				
				<h:outputText value="#{msg['Submission.open_date']}"/>
				<p:calendar id="open_date" value="#{submitResourcesBean.newSubmission.openDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button"/>
				<p:message for="open_date" display="icon" />
				
				<h:outputText value="#{msg['Submission.close_date']}"/>
				<p:calendar id="close_date" value="#{submitResourcesBean.newSubmission.closeDatetime}"  locale="#{userBean.locale}" navigator="true" showOn="button"/>
				<p:message for="close_date" display="icon" />
				
				<h:outputText value="#{msg['Submission.max_resources']}"/>
				<p:inputText id="max_resources" value="#{submitResourcesBean.newSubmission.noOfResources}"/>
				<p:message for="max_resources" display="icon" />
				
				<h:outputText value="#{msg['Submission.survey_mandatory']}"/>
				<p:selectBooleanCheckbox value="#{submitResourcesBean.newSubmission.surveyMandatory}" widgetVar="surveyCheckBox" id="survey_checkbox">
					<p:ajax update=":create_dialog_survey_menu" oncomplete="toggleSurveySelectField(surveyCheckBox.input.is(':checked'), 'create');"/>
				</p:selectBooleanCheckbox>
				<p:message for="survey_checkbox" display="icon" />
				
				<h:outputText id="create_dialog_survey_text" value="#{msg['Submission.survey']}" style="display:none;"/>
				<h:selectOneMenu id="create_dialog_survey_menu" value="#{submitResourcesBean.newSubmission.surveyResourceId}" style="display:none;width:22rem;" required="#{submitResourcesBean.newSubmission.surveyMandatory}" requiredMessage="#{msg['Submission.survey_required']}">	
					<f:selectItem itemLabel="Select Survey Resource" />
					<f:selectItems value="#{submitResourcesBean.surveyResourcesList}"/>
				</h:selectOneMenu>
				<p:message id="create_dialog_survey_menu_message" for="create_dialog_survey_menu" display="icon" />
				
				<p:commandButton value="#{msg.save}" styleClass="greenbutton" update=":submissions :create_submission_dialog1" actionListener="#{submitResourcesBean.createNewSubmission()}" oncomplete="handleDialogSubmit(xhr, status, args, 'create_submission_dialog')"/>
				<h:outputText value=""/>
				<h:outputText value=""/>
			</h:panelGrid>	
			</h:form>
		</p:dialog>
		
		<div class="page_header">
			<span>
				<h:outputText value="#{msg['Submission.overview']}" rendered="#{not userBean.moderator || submitResourcesBean.submissionOverviewReadOnly}"/>
				<h:outputText value="Submission Forms Overview" rendered="#{userBean.moderator and not submitResourcesBean.submissionOverviewReadOnly}"/>
			</span>
		</div>
		<h:panelGroup id="submissions" layout="block" style="margin-bottom: 30px;">
			<div>
				<h:outputText id="no_submissions" rendered="#{empty submitResourcesBean.pastSubmissions and empty submitResourcesBean.currentSubmissions and empty submitResourcesBean.futureSubmissions}" value="#{msg['Submission.no_submissions_message']}"/>
			</div>
			<h:panelGroup id="past_submissions" layout="block" rendered="#{not empty submitResourcesBean.pastSubmissions}">
				<div class="submission_header">
					<div style="margin-top:10px;"><h1>#{msg['Submission.past_submissions']} (${submitResourcesBean.pastSubmissions.size()})<span
								class="icon_wrapper"><i class="fa fa-caret-right" /></span></h1></div>
				</div>
				<div class="submission_cards">
					<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
						<ui:param name="submissions" value="#{submitResourcesBean.pastSubmissions}" />
					</ui:decorate>
				</div>
			</h:panelGroup>
			<h:panelGroup id="current_submissions" layout="block" rendered="#{not empty submitResourcesBean.currentSubmissions}">
				<div class="submission_header">
					<div style="margin-top:10px;"><h1>#{msg['Submission.current_submissions']} (${submitResourcesBean.currentSubmissions.size()})<span
								class="icon_wrapper"><i class="fa fa-caret-right" /></span></h1></div>
				</div>
				<div class="submission_cards">
					<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
						<ui:param name="submissions" value="#{submitResourcesBean.currentSubmissions}" />
					</ui:decorate>
				</div>
			</h:panelGroup>
			<h:panelGroup id="future_submissions" layout="block" rendered="#{not empty submitResourcesBean.futureSubmissions}">
				<div class="submission_header">
					<div style="margin-top:10px;"><h1>#{msg['Submission.future_submissions']} (${submitResourcesBean.futureSubmissions.size()})<span
								class="icon_wrapper"><i class="fa fa-caret-right" /></span> </h1></div>
				</div>
				<div class="submission_cards">
					<ui:decorate  template="/lw/templates/submission_cards_template.xhtml">
						<ui:param name="submissions" value="#{submitResourcesBean.futureSubmissions}" />
					</ui:decorate>
				</div>
			</h:panelGroup>
			<br/>
			<h:form prependId="false">
				<p:commandLink styleClass="greenbutton" style="margin-top:20px;text-decoration:none;" title="#{msg['Submission.create_new_submission']}" rendered="#{(userBean.admin || userBean.moderator) and not submitResourcesBean.submissionOverviewReadOnly}"
							process="@this" oncomplete="PF('create_submission_dialog').show();">
							#{msg['Submission.create_new_submission']}
				</p:commandLink>
			</h:form>
		</h:panelGroup>
		<h:panelGroup id="datagrid" class="not-selectable display-none"></h:panelGroup>			
	</ui:define>
	<ui:define name="right_layout">
		<ui:decorate  template="/templates/resources/right_pane.xhtml">
			<ui:param name="bean" value="#{submitResourcesBean}" />
		</ui:decorate>
	</ui:define>
</ui:composition>