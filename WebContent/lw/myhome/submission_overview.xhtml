<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
				xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
				xmlns:h="http://xmlns.jcp.org/jsf/html"
				xmlns:f="http://xmlns.jcp.org/jsf/core"
				xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
				xmlns:p="http://primefaces.org/ui">

    <ui:param name="loginRequired" value="true"/>
    <ui:param name="pageTitle" value="#{msg['Submission.overview_title']}"/>
    <ui:param name="helpText" value=""/>

	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="user_id" value="#{submissionBean.userId}"/>
			<f:viewParam name="resource_id" value="#{rightPaneBean.resourceId}"/>
			<f:viewAction action="#{rightPaneBean.onLoad}"/>
			<f:viewAction action="#{submissionBean.onLoad}"/>
		</f:metadata>
	</ui:define>

	<ui:define name="breadcrumb_ext">
		<p:menuitem value="#{msg['Submission.overview_title']}" url="myhome/submission_overview.jsf#"/>
	</ui:define>

	<ui:define name="head">
		<h:outputStylesheet name="vendor/fancybox-v3.5.7/jquery.fancybox.min.css"/>
		<h:outputScript name="vendor/fancybox-v3.5.7/jquery.fancybox.min.js"/>

		<h:outputScript library="learnweb-layout" name="js/right-pane.js" target="head"/>
		<h:outputScript library="learnweb-layout" name="js/group-resources.js" target="head"/>
	</ui:define>

	<ui:define name="center_layout">
		<h:form>
			<p:remoteCommand name="selectGroupItemCommand" actionListener="#{submissionBean.actionSelectGroupItem}" update=":right_pane :growl"
							 global="false" onstart="PF('rightPaneOverlay').show();PF('learnweb').showRightPane();" oncomplete="PF('rightPaneOverlay').hide()"/>
			<p:remoteCommand name="resourceAddedHook" update=":resourcesWrapper"
							 global="false" onstart="PF('resourcesOverlay').show();" oncomplete="PF('resourcesOverlay').hide();onResourcesUpdated();"/>
			<p:remoteCommand name="resourceUpdatedHook" update=":submissions"
							 global="false" onstart="PF('resourcesOverlay').show();" oncomplete="PF('resourcesOverlay').hide();onResourcesUpdated();"/>
		</h:form>

		<h:panelGroup layout="block" id="resourcesWrapper">
			<p:blockUI block="resourcesWrapper" widgetVar="resourcesOverlay">
				<h:outputText value="#{msg.please_wait}"/>
			</p:blockUI>

			<ui:fragment rendered="#{userBean.isMemberOfCourse(1297)}">
				<p:panel>
					Links to the resources that you have submitted:
					<ul>
						<ui:repeat var="submission" value="#{submissionBean.pastSubmissions}">
							<ui:repeat var="res" value="#{submission.submittedResources}">
								<li>
									<a href="#{learnwebBean.learnweb.secureServerUrl}/lw/myhome/submission_overview.jsf?user_id=#{submissionBean.userId}&amp;resource_id=#{res.id}">
										#{learnwebBean.learnweb.secureServerUrl}/lw/myhome/submission_overview.jsf?user_id=#{submissionBean.userId}&amp;resource_id=#{res.id}
									</a>
								</li>
							</ui:repeat>
						</ui:repeat>
					</ul>
					Link to the peer assessment form that you have to submit:
					<ul>
						<ui:repeat var="pair" value="#{submissionBean.peerAssessmentPairs}">
							<li>
								<a href="#{learnwebBean.learnweb.secureServerUrl}/lw/survey/answer.jsf?resource_id=#{pair.peerAssessment.id}&amp;user_id=#{submissionBean.userId}">
									#{learnwebBean.learnweb.secureServerUrl}/lw/survey/answer.jsf?resource_id=#{pair.peerAssessment.id}&amp;user_id=#{submissionBean.userId}
								</a>

								<h:outputText value=" Not submitted yet" rendered="#{not pair.peerAssessment.getAnswersOfUser(submissionBean.userId).submitted}" styleClass="red bold"/>
								<h:outputText value=" Submitted successfully" rendered="#{pair.peerAssessment.getAnswersOfUser(submissionBean.userId).submitted}" styleClass="green bold"/>
							</li>
						</ui:repeat>
					</ul>
				</p:panel>
			</ui:fragment>

			<p:dialog header="#{msg['Submission.edit_submission']}" id="edit_submission_dialog1" styleClass="modal-dialog-select" responsive="true" draggable="false" resizable="false" modal="true" appendTo="@(body)" widgetVar="submission_edit_dialog">
				<h:form prependId="false" id="form">
					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg.title}:"/>
						<p:inputText value="#{submissionBean.selectedSubmission.title}"/>
						<p:message for="@previous"/>
					</div>

					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg.course}:"/>
						<p:selectOneMenu value="#{submissionBean.selectedSubmission.courseId}">
							<f:selectItems var="course" value="#{userBean.user.courses}" itemLabel="#{course.title}" itemValue="#{course.id}"/>
							<f:ajax listener="#{submissionBean.onEditSurveyChangeCourse}" render="edit_dialog_survey_menu" onevent="courseChange"/>
						</p:selectOneMenu>
						<p:message for="@previous"/>
					</div>

					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg.description}:"/>
						<p:inputTextarea autoResize="1" maxHeight="20" rows="2" value="#{submissionBean.selectedSubmission.description}"/>
						<p:message for="@previous"/>
					</div>

					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg['Submission.open_date']}:"/>
						<p:calendar value="#{submissionBean.selectedSubmission.openDatetime}" locale="#{userBean.locale}" navigator="true" showOn="button"/>
						<p:message for="@previous"/>
					</div>

					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg['Submission.close_date']}:"/>
						<p:calendar value="#{submissionBean.selectedSubmission.closeDatetime}" locale="#{userBean.locale}" navigator="true" showOn="button"/>
						<p:message for="@previous"/>
					</div>

					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg['Submission.max_resources']}:"/>
						<p:inputText value="#{submissionBean.selectedSubmission.noOfResources}"/>
						<p:message for="@previous"/>
					</div>

					<div class="form-group">
						<p:selectBooleanCheckbox value="#{submissionBean.selectedSubmission.surveyMandatory}" itemLabel="#{msg['Submission.survey_mandatory']}" widgetVar="editSurveyCheckBox">
							<p:ajax update=":edit_dialog_survey_menu" oncomplete="toggleSurveySelectField(PF('editSurveyCheckBox').input.is(':checked'), 'edit');"/>
						</p:selectBooleanCheckbox>
					</div>

					<div class="form-group" id="edit_dialog_survey_text" style="display:none;">
						<p:outputLabel for="@next" value="#{msg['survey']}:"/>
						<p:selectOneMenu id="edit_dialog_survey_menu" value="#{submissionBean.selectedSubmission.surveyResourceId}" required="#{submissionBean.selectedSubmission.surveyMandatory}" requiredMessage="#{msg['Submission.survey_required']}">
							<f:selectItem itemLabel="Select Survey Resource" itemValue="-1"/>
							<f:selectItems value="#{submissionBean.editSurveyResourcesList}"/>
						</p:selectOneMenu>
						<p:message for="@previous"/>
					</div>

					<div class="d-flex mt-3">
						<div class="mr-auto">
							<p:commandButton value="#{msg.delete}" update=":submissions" process="@this" actionListener="#{submissionBean.deleteSubmission()}"
											 onclick="return confirmSubmissionDelete('#{submissionBean.selectedSubmission.title}');"
											 oncomplete="addSubmissionHeaderClickHandler();"/>
						</div>
						<div>
							<p:commandButton value="#{msg.save}" update=":submissions" actionListener="#{submissionBean.updateSubmissionDetails()}"
											 onclick="PF('submission_edit_dialog').hide();" oncomplete="addSubmissionHeaderClickHandler();"/>
						</div>
					</div>
				</h:form>
			</p:dialog>

			<p:dialog header="#{msg['Submission.create_new_submission']}" id="create_submission_dialog1" draggable="false" responsive="true" resizable="false" modal="true" appendTo="@(body)" widgetVar="create_submission_dialog">
				<h:form prependId="false">
					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg.title}:"/>
						<p:inputText id="title_input" value="#{submissionBean.newSubmission.title}"/>
						<p:message for="@previous" display="icon"/>
					</div>

					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg.course}:"/>
						<p:selectOneMenu value="#{submissionBean.newSubmission.courseId}">
							<f:selectItem itemLabel="Select Course"/>
							<f:selectItems var="course" value="#{userBean.user.courses}" itemLabel="#{course.title}" itemValue="#{course.id}"/>
							<f:ajax listener="#{submissionBean.onCreateSurveyChangeCourse}" render="create_dialog_survey_menu" onevent="courseChange"/>
						</p:selectOneMenu>
						<p:message for="@previous" display="icon"/>
					</div>

					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg.description}:"/>
						<p:inputTextarea  id="description" autoResize="1" rows="2" maxHeight="20" value="#{submissionBean.newSubmission.description}"/>
						<p:message for="@previous" display="icon"/>
					</div>

					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg['Submission.open_date']}:"/>
						<p:calendar id="open_date" value="#{submissionBean.newSubmission.openDatetime}" locale="#{userBean.locale}" navigator="true" showOn="button"/>
						<p:message for="@previous" display="icon"/>
					</div>

					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg['Submission.close_date']}:"/>
						<p:calendar id="close_date" value="#{submissionBean.newSubmission.closeDatetime}" locale="#{userBean.locale}" navigator="true" showOn="button"/>
						<p:message for="@previous" display="icon"/>
					</div>

					<div class="form-group">
						<p:outputLabel for="@next" value="#{msg['Submission.max_resources']}:"/>
						<p:inputText id="max_resources" value="#{submissionBean.newSubmission.noOfResources}"/>
						<p:message for="@previous" display="icon"/>
					</div>

					<div class="form-group">
						<p:selectBooleanCheckbox value="#{submissionBean.newSubmission.surveyMandatory}" itemLabel="#{msg['Submission.survey_mandatory']}" widgetVar="surveyCheckBox" id="survey_checkbox">
							<p:ajax update=":create_dialog_survey_menu" oncomplete="toggleSurveySelectField(surveyCheckBox.input.is(':checked'), 'create');"/>
						</p:selectBooleanCheckbox>
					</div>

					<div class="form-group modal-dialog-select" id="create_dialog_survey_text" style="display:none;">
						<p:outputLabel for="@next" value="#{msg['Submission.survey']}:"/>
						<p:selectOneMenu id="create_dialog_survey_menu" value="#{submissionBean.newSubmission.surveyResourceId}" required="#{submissionBean.newSubmission.surveyMandatory}" requiredMessage="#{msg['Submission.survey_required']}">
							<f:selectItem itemLabel="Select Survey Resource"/>
							<f:selectItems value="#{submissionBean.surveyResourcesList}"/>
						</p:selectOneMenu>
						<p:message id="create_dialog_survey_menu_message" for="create_dialog_survey_menu" display="icon"/>
					</div>

					<div class="text-right mt-3">
						<p:commandButton value="#{msg.save}" update=":submissions :create_submission_dialog1" actionListener="#{submissionBean.createNewSubmission()}"
										 oncomplete="handleDialogSubmit(xhr, status, args, 'create_submission_dialog')"/>
					</div>
				</h:form>
			</p:dialog>

			<h:outputText id="no_submissions" rendered="#{empty submissionBean.pastSubmissions and empty submissionBean.currentSubmissions and empty submissionBean.futureSubmissions}" value="#{msg['Submission.no_submissions_message']}"/>

			<p:tabView id="submissions" styleClass="ui-tabs-transparent" pt:data-canSelectResources="true">
				<p:tab title="#{msg['Submission.current_submissions']} (#{submissionBean.currentSubmissions.size()})" rendered="#{not empty submissionBean.currentSubmissions}">
					<ui:decorate  template="/WEB-INF/templates/blocks/submission/submission_card.xhtml">
						<ui:param name="submissions" value="#{submissionBean.currentSubmissions}"/>
					</ui:decorate>
				</p:tab>

				<p:tab title="#{msg['Submission.future_submissions']} (#{submissionBean.futureSubmissions.size()})" rendered="#{not empty submissionBean.futureSubmissions}">
					<ui:decorate  template="/WEB-INF/templates/blocks/submission/submission_card.xhtml">
						<ui:param name="submissions" value="#{submissionBean.futureSubmissions}"/>
					</ui:decorate>
				</p:tab>

				<p:tab title="#{msg['Submission.past_submissions']} (#{submissionBean.pastSubmissions.size()})" rendered="#{not empty submissionBean.pastSubmissions}">
					<ui:decorate  template="/WEB-INF/templates/blocks/submission/submission_card.xhtml">
						<ui:param name="submissions" value="#{submissionBean.pastSubmissions}"/>
					</ui:decorate>
				</p:tab>
			</p:tabView>
		</h:panelGroup>

		<script type="text/javascript">
			function addSubmissionHeaderClickHandler(){
				$('.submission_header').on('click', function(){
					$(this).toggleClass('active');
					$(this).siblings().slideToggle();
					$(this).find(".fa-caret-right").toggleClass('open');
				});
			}

			function clickCurrentSubmissions(){
				$('#current_submissions > .submission_header').trigger("click");
			}

			var scrollPos;
			function saveScrollPos(event){
				scrollPos = $(event.currentTarget).get(0).offsetTop;
			}

			function setScrollPos(){
				$('.nano').nanoScroller({scrollTop: scrollPos});
			}

			function toggleSurveySelectField(show, surveySelectType)
			{
				var selectFieldIdPrefix = surveySelectType === "edit" ? "#edit_dialog_survey" : "#create_dialog_survey";
				if(show)
				{
					$(selectFieldIdPrefix + '_text').show();
					$(selectFieldIdPrefix + '_menu').show();
				}
				else
				{
					$(selectFieldIdPrefix + '_text').hide();
					$(selectFieldIdPrefix + '_menu').hide();
					$(selectFieldIdPrefix + '_menu_message').hide();
				}
			}

			function handleDialogSubmit(xhr, status, args, dialogWidgetVar) {
				if (args.validationFailed) {
					PF(dialogWidgetVar).show();
					var surveySelectType = dialogWidgetVar === 'create_submission_dialog' ? 'create' : 'edit';
					toggleSurveySelectField(PF('surveyCheckBox').input.is(':checked'), surveySelectType);
				} else {
					PF(dialogWidgetVar).hide();
					addSubmissionHeaderClickHandler();
				}
			}

			function courseChange(data)
			{
				var status = data.status;
				if(status === "success")
				{
					toggleSurveySelectField(PF('surveyCheckBox').input.is(':checked'), 'create');
					toggleSurveySelectField(PF('editSurveyCheckBox').input.is(':checked'), 'edit');
				}
			}

			function confirmSubmissionDelete(submissionTitle)
			{
				var status = confirm('Are you sure you want to delete this submission "' + submissionTitle +'" ?');
				if(status)
					PF('submission_edit_dialog').hide();

				return status;
			}

			function onResourcesUpdated() {
				createSelectable('submissions');
			}

			$(document).ready(function(){
				addSubmissionHeaderClickHandler();
				toggleSurveySelectField(PF('surveyCheckBox').input.is(':checked'), 'create');
				toggleSurveySelectField(PF('editSurveyCheckBox').input.is(':checked'), 'edit');
				$('#current_submissions .submission_header').click();

			});

			$(function () {
				$(document).on('dblclick', '.res-item', openItems);
				onResourcesUpdated();
			});
		</script>
	</ui:define>

	<ui:define name="right_layout">
		<ui:decorate template="/WEB-INF/templates/blocks/right-pane/right_pane.xhtml"/>
	</ui:define>
</ui:composition>
