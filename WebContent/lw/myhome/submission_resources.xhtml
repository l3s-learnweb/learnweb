<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pt="http://xmlns.jcp.org/jsf/passthrough" xmlns:lw="http://l3s.de/learnweb">

<ui:param name="pageTitle" value="#{msg['Submission.title']}"/>
<ui:param name="loginRequired" value="true"/>

<ui:define name="metadata">
    <f:metadata>
        <f:viewParam name="submission_id" value="#{submissionBean.submissionId}"/>
        <f:viewParam name="user_id" value="#{submissionBean.userId}"/>
        <f:viewParam name="resource_id" value="#{rightPaneBean.resourceId}"/>
        <f:viewAction action="#{rightPaneBean.onLoad}"/>
        <f:viewAction action="#{submissionBean.onLoad}"/>
    </f:metadata>
</ui:define>

<ui:define name="breadcrumb">
    <lw:breadcrumb-item link="myhome/resources.jsf" title="#{msg.myResourcesTitle}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_first.xhtml"/>
    </lw:breadcrumb-item>

    <lw:breadcrumb-item link="myhome/submission_overview.jsf" title="#{msg['Submission.overview_title']}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_my_resources.xhtml"/>
    </lw:breadcrumb-item>

    <lw:breadcrumb-item title="#{msg['Submission.title']}"/>
</ui:define>

<ui:define name="center_layout">
    <h:outputStylesheet library="vendor" name="fancybox-v3.5.7/jquery.fancybox.min.css"/>
    <h:outputScript library="vendor" name="fancybox-v3.5.7/jquery.fancybox.min.js" target="body"/>
    <h:outputScript library="learnweb-layout" name="js/right-pane.js" target="body"/>
    <h:outputScript library="learnweb-layout" name="js/group-resources.js" target="body"/>

    <h:form styleClass="d-none">
        <p:remoteCommand name="commandSelectResource" actionListener="#{submissionBean.actionSelectGroupItem}" update=":right_pane :growl"
                         global="false" onstart="PF('rightPaneOverlay').show();PF('learnweb').showRightPane();" oncomplete="PF('rightPaneOverlay').hide()"/>
        <p:remoteCommand name="updateSelectedItemsCommand" actionListener="#{submissionBean.actionUpdateSelectedItems}"
                         update=":submittedResourcesGrid" global="false" oncomplete="onResourcesUpdated()"/>
    </h:form>

    <!-- only for eumade4all -->
    <p:panel rendered="#{not submissionBean.submitted and not submissionBean.submissionOverviewReadOnly}">
        <h3 class="text-danger mb-0">Remove your name and the university name from inside the uploaded files. Only the study number can be displayed inside the files.</h3>
    </p:panel>

    <p:panel styleClass="mt-3" id="resourcesWrapper">
        <p:blockUI block="resourcesWrapper" widgetVar="resourcesOverlay">
            <h:outputText value="#{msg.please_wait}"/>
        </p:blockUI>

        <ui:fragment rendered="#{not submissionBean.submitted and not submissionBean.submissionOverviewReadOnly}">
            <h3>#{msg['Submission.select_resources_header']}</h3>
        </ui:fragment>

        <ui:fragment rendered="#{submissionBean.submitted}">
            <h3>The submitted resources</h3>
        </ui:fragment>

        <h:panelGroup layout="block" id="submissions" styleClass="mt-3">
            <h:panelGroup id="submittedResourcesGrid" layout="block" styleClass="res-grid border-top res-container pt-3"
                          pt:data-canSelectResources="true">
                <p:repeat var="res" value="#{submissionBean.selectedResources}">
                    <h:outputLink styleClass="d-block res-item text-decoration-none" value="resource.jsf"
                                  pt:data-itemType="resource"
                                  pt:data-itemId="#{res.id}">
                        <f:param name="resource_id" value="#{res.id}"/>

                        <ui:decorate template="/WEB-INF/templates/blocks/resources/single_res_block.xhtml">
                            <ui:param name="res" value="#{res}"/>
                            <ui:param name="showSelectIcon" value="true"/>
                        </ui:decorate>
                    </h:outputLink>
                </p:repeat>

                <h:outputText value="No resources were submitted" rendered="#{empty submissionBean.selectedResources and submissionBean.submitted}"
                              class="res-empty-text"/>

                <h:panelGroup id="add_resource_sign" styleClass="my-auto mx-3" layout="block"
                              rendered="#{not submissionBean.submitted and not submissionBean.submissionOverviewReadOnly}">
                    <a href="#" class="cancel" onclick="return false;">
                        <i class="fa fa-fw fa-3x fa-plus" aria-hidden="true"></i>
                        <span class="sr-only">Select a resource</span>
                    </a>
                </h:panelGroup>

                <div class="clear"></div>
            </h:panelGroup>

            <h:form id="submit_resources_form" prependId="false">
                <p:commandButton id="submit_resources_button" value="#{msg.submit}" style="display:none;" action="#{submissionBean.actionSubmitItems}"
                                 update=":submittedResourcesGrid :growl" onclick="return confirmSubmitMessage();"
                                 rendered="#{not submissionBean.submitted}"/>
            </h:form>
        </h:panelGroup>
    </p:panel>

    <h:panelGroup styleClass="collapse p-0" layout="block" id="select_resources_modal">
        <p:panel styleClass="ui-panel-scroll-content mb-0">
            <f:facet name="header">
                <h:outputFormat value="#{msg['Submission.lightbox_header']}">
                    <f:param value="#{submissionBean.selectedSubmission.noOfResources}"/>
                </h:outputFormat>
            </f:facet>
            <f:facet name="actions">
                <a href="#" data-fancybox-close="true" class="text-white"><i class="fa fa-fw fa-times" aria-hidden="true"></i></a>
            </f:facet>
            <f:facet name="footer">
                <h:form>
                    <p:commandButton value="#{msg.add}" onclick="confirmResourcesSelect();"/>
                </h:form>
            </f:facet>

            <h:panelGroup layout="block" rendered="#{empty submissionBean.resources}">
                <h:outputText value="#{msg.no_resources_found}" class="res-empty-text"/>
                First, add resources to <h:outputLink value="myhome/resources.jsf">#{msg.myResourcesTitle}.</h:outputLink>
            </h:panelGroup>

            <h:panelGroup id="submitResourcesGrid" styleClass="res-container res-grid" layout="block" rendered="#{!empty submissionBean.resources}"
                          pt:data-canSelectResources="true">
                <p:repeat var="res" value="#{submissionBean.resources}">
                    <h:outputLink styleClass="d-block res-item text-decoration-none" value="resource.jsf"
                                  pt:data-itemType="resource"
                                  pt:data-itemId="#{res.id}">
                        <f:param name="resource_id" value="#{res.id}"/>

                        <ui:decorate template="/WEB-INF/templates/blocks/resources/single_res_block.xhtml">
                            <ui:param name="res" value="#{res}"/>
                            <ui:param name="showSelectIcon" value="true"/>
                        </ui:decorate>
                    </h:outputLink>
                </p:repeat>
            </h:panelGroup>
        </p:panel>
    </h:panelGroup>

    <script type="application/javascript">
      /* global updateSelectedItemsCommand */

      const maxResourcesToSubmit = parseInt('#{submissionBean.selectedSubmission.noOfResources}');

      function confirmSubmitMessage() {
        const neededMoreResources = maxResourcesToSubmit - selected.size();
        let confirmMessage = 'Are you sure you want to submit? You will no longer be able to submit any more resources.';
        if (neededMoreResources > 0) {
          confirmMessage = `You should select ${neededMoreResources} more resource${neededMoreResources > 1 ? 's' : ''} for your submission. ${confirmMessage}`;
        }
        return confirm(confirmMessage);
      }

      function confirmResourcesSelect() {
        if (selected.size() > maxResourcesToSubmit) {
          alert(`Maximum allowed items limit exceeded. You can't choose more than ${maxResourcesToSubmit} items.`);
        } else {
          updateSelectedItemsCommand([
            { name: 'action', value: 'update' },
            { name: 'items', value: JSON.stringify(selected) }
          ]);
          $.fancybox.close();
        }
      }

      function updateMaxResources() {
        // When user delete an item the button has to be returned back
        if (maxResourcesToSubmit > selected.size()) {
          $('#add_resource_sign').show();
        } else {
          $('#add_resource_sign').hide();
        }

        if (selected.size() > 0) {
          $('#submit_resources_button').show();
        }
      }

      function onResourcesUpdated() {
        updateMaxResources();
        // createSelectableArea('submittedResourcesGrid'); Why do we need the ability to select these resources?
      }

      $(function () {
        $(document).on('click', '#add_resource_sign', function () {
          $.fancybox.open({
            src: '#select_resources_modal',
            type: 'inline',
          }, {
            // modal: true,
            touch: false,
            smallBtn: false,
            buttons: false,
          });
        });

        $(document).on('dblclick', '.res-item', openItems);
        onResourcesUpdated();
        createSelectable('submitResourcesGrid');
      });
    </script>
</ui:define>

<ui:define name="right_layout">
    <ui:decorate template="/WEB-INF/templates/blocks/right-pane/right_pane.xhtml"/>
</ui:define>
</ui:composition>
