<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:lw="http://l3s.de/learnweb">

<ui:param name="pageTitle" value="#{msg['Submission.title']}"/>

<ui:define name="metadata">
    <f:metadata>
        <f:viewParam name="course_id" value="#{submissionBean.courseId}" converter="idConverter"/>
        <f:viewParam name="submission_id" value="#{submissionBean.submissionId}" converter="idConverter"/>
        <f:viewParam name="user_id" value="#{submissionBean.userId}" converter="idConverter"/>
        <f:viewAction action="#{submissionBean.onLoad}"/>
    </f:metadata>
</ui:define>

<ui:define name="breadcrumb">
    <lw:breadcrumb-item link="myhome/resources.jsf" title="#{msg.myResourcesTitle}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_first.xhtml"/>
    </lw:breadcrumb-item>

    <lw:breadcrumb-item link="myhome/submission_overview.jsf" title="#{msg['Submission.overview']}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_my_resources.xhtml"/>
    </lw:breadcrumb-item>

    <lw:breadcrumb-item title="#{msg['Submission.title']}"/>
</ui:define>

<ui:define name="center_layout">
    <h:outputStylesheet library="vendor" name="fancybox-v3.5.7/jquery.fancybox.min.css"/>
    <h:outputScript library="vendor" name="fancybox-v3.5.7/jquery.fancybox.min.js" target="body"/>
    <h:outputScript library="layout" name="js/group-resources.js" target="body"/>

    <h:form styleClass="d-none">
        <p:remoteCommand name="updateSelectedItemsCommand" actionListener="#{submissionBean.actionUpdateSelectedItems}"
                         update=":submissionsWrapper" oncomplete="PF('selectDlg').hide();"/>
    </h:form>

    <p:dialog widgetVar="selectDlg" header="#{msg['Submission.select_resources_header']}" styleClass="ui-dialog-sticky-footer"
              modal="true" resizable="false" draggable="false" responsive="true" closeOnEscape="true">

        <h:panelGroup id="submitResourcesGrid" styleClass="res-container dynamic-content" layout="block" rendered="#{!empty submissionBean.resources}"
                      pt:data-canSelectResources="true">
            <div class="res-grid">
                <ui:repeat var="res" value="#{submissionBean.resources}">
                    <h:outputLink styleClass="d-block res-item text-decoration-none" value="resource.jsf"
                                  pt:data-itemType="resource"
                                  pt:data-itemId="#{res.id}">
                        <f:param name="resource_id" value="#{res.id}"/>

                        <ui:decorate template="/WEB-INF/templates/blocks/resources/single_res_block.xhtml">
                            <ui:param name="res" value="#{res}"/>
                            <ui:param name="showSelectIcon" value="true"/>
                        </ui:decorate>
                    </h:outputLink>
                </ui:repeat>
            </div>
        </h:panelGroup>

        <div class="d-flex justify-content-end sticky-footer">
            <p:button value="#{msg.select}" onclick="confirmResourcesSelect();return false;"/>
        </div>
    </p:dialog>

    <p:panel id="submissionsWrapper" header="#{submissionBean.submitted ? msg['submission.submitted_resources'] : msg['submission.your_selected_resources_displayed_here']}">
        <div class="res-grid res-container mx-n3 mt-n3">
            <ui:repeat var="res" value="#{submissionBean.selectedResources}">
                <h:outputLink styleClass="d-block res-item text-decoration-none" value="resource.jsf"
                              pt:data-resview="grid"
                              pt:data-itemType="resource"
                              pt:data-itemId="#{res.id}">
                    <f:param name="resource_id" value="#{res.id}"/>

                    <ui:decorate template="/WEB-INF/templates/blocks/resources/single_res_block.xhtml">
                        <ui:param name="res" value="#{res}"/>
                        <ui:param name="showSelectIcon" value="false"/>
                    </ui:decorate>
                </h:outputLink>
            </ui:repeat>
        </div>

        <p:outputPanel layout="block" styleClass="d-flex justify-content-center" rendered="#{empty submissionBean.selectedResources and submissionBean.submitted}">
            <h3>#{msg['submission.no_resources_were_submitted']}</h3>
        </p:outputPanel>

        <h:form prependId="false" styleClass="d-flex #{submissionBean.selectedResources.size() > 0 ? 'justify-content-between' : 'justify-content-center'}">
            <p:commandButton value="#{msg.select}" rendered="#{not submissionBean.submitted and not submissionBean.submissionOverviewReadOnly}" update="@form" onclick="PF('selectDlg').show();" />

            <p:commandButton value="#{msg.submit}" action="#{submissionBean.actionSubmitItems}"
                             update="@form" rendered="#{not submissionBean.submitted and not empty submissionBean.selectedResources}">
                    <p:confirm message="#{msg['submission.are_you_sure_you_want_to_submit']}" icon="pi pi-exclamation-triangle"/>
            </p:commandButton>
        </h:form>
    </p:panel>

    <script type="application/javascript">
      /* global updateSelectedItemsCommand */

      function confirmResourcesSelect() {
        updateSelectedItemsCommand([
          { name: 'action', value: 'update' },
          { name: 'items', value: JSON.stringify(selected) }
        ]);
      }

      $(function () {
        $(document).on('click', '.res-item', (e) => e.preventDefault());
        $(document).on('dblclick', '.res-item', openItems);
        createSelectable('submitResourcesGrid');
        createSelectableArea('submitResourcesGrid');
      });
    </script>
</ui:define>
</ui:composition>
