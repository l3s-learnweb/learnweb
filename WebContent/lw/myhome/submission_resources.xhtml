<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
				xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
				xmlns:h="http://xmlns.jcp.org/jsf/html"
				xmlns:f="http://xmlns.jcp.org/jsf/core"
				xmlns:p="http://primefaces.org/ui"
				xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="submission_id" value="#{submissionBean.submissionId}"/>
			<f:viewParam name="user_id" value="#{submissionBean.userId}" />
			<f:viewParam name="resource_id" value="#{rightPaneBean.resourceId}" />
			<f:viewAction action="#{rightPaneBean.onLoad}"/>
			<f:viewAction action="#{submissionBean.onLoad}"/>
		</f:metadata>
	</ui:define>

	<ui:param name="pageTitle" value="#{msg['Submission.title']}" />
	<ui:param name="loginRequired" value="true" />

	<ui:define name="center_layout">

		<h:form>
			<p:remoteCommand name="resourceAddedHook" update=":resourcesView" />
			<p:remoteCommand name="resourceUpdatedHook" update=":resourcesView" />
		</h:form>

		<script>
			var max_resources = #{submissionBean.selectedSubmission.noOfResources};
			var resources_to_select = max_resources;
		</script>
		<h:form>
			<p:remoteCommand name="selectGroupItemCommand" actionListener="#{submissionBean.actionSelectGroupItem}" update=":growl" oncomplete="selectResourceDND(); load_editor(); "/>
			<p:remoteCommand name="updateSelectedItemsCommand" actionListener="#{submissionBean.actionUpdateSelectedItems}" update=" :resourceGrid2" oncomplete="selectResourceDND(); updateMaxResources();"/>
		</h:form>

		<!-- only for eumade4all -->
		<p:panel rendered="#{not submissionBean.submitted and not submissionBean.submissionOverviewReadOnly}"><h1 class="red">Remove your name and the university name from inside the uploaded files. Only the study number can be displayed inside the files.</h1></p:panel>

		<ui:fragment rendered="#{not submissionBean.submitted and not submissionBean.submissionOverviewReadOnly}"><h3 class="title-header">#{msg['Submission.select_resources_header']}</h3></ui:fragment>
		<ui:fragment rendered="#{submissionBean.submitted}"><h3 class="title-header">The submitted resources</h3></ui:fragment>
		<hr class="title-divider"/>

		<h:outputStylesheet library="lightbox" name="lightbox.css" />
		<h:outputScript library="resources" name="resource-pane.js" />

		<h:panelGroup id="resourcesView" layout="block">
			<!-- dummy for right pane -->
		</h:panelGroup>

		<h:panelGroup styleClass="section-resource-submission" layout="block">
			<h:panelGroup layout="block" id="datagrid" styleClass="datagrid" pt:data-isEnabledMoving="false">
				<h:panelGroup id="resourceGrid2" styleClass="resource-grid" layout="block">
					<p:repeat var="res" value="#{submissionBean.selectedResources}" >

						<h:panelGroup styleClass="resource-item group-resources-item" pt:data-itemType="resource" pt:data-itemId="#{res.id}" layout="block">
							<h:panelGroup layout="block" id="context-menu" class="context-menu resource-context-menu" role="menu" rendered="#{not submissionBean.submitted}">
								<ui:fragment>
									<div class="context-menu-item action-remove" role="menuitem" data-action="remove" data-per="canDeleteResource">
										<div class="context-menu-item-wrapper">
											<span class="context-menu-item-icon" />
											<!--						<span class="context-menu-item-content">Remove</span>-->
										</div>
									</div>
								</ui:fragment>
							</h:panelGroup>
							<div class="resource-block">

								<div class="resource-preview">
									<div class="resource-preview-wrapper">
										<img class="resource-preview-image" src="#{res.thumbnail1.url}" alt="#{res.title}" />
									</div>
									<h:form class="resource-controls" rendered="#{not submissionBean.submitted}">
										<h:outputLink value="#" title="#{msg.delete}" styleClass="action-remove">
											<h:graphicImage alt="Delete" value="../resources/icon/Remove.png"/>
										</h:outputLink>
									</h:form>
								</div>

								<div class="resource-title">
									<div class="resource-title-wrapper">
										<!--<div class="resource-title-icon">
                                                <div class="resource-title-icon-wrapper">
                                                    <img src="img.png" alt="Title" />
                                                </div>
                                            </div>-->
										<div class="resource-title-text">
											<h:outputText value="#{res.title}" escape="false" styleClass="resource-title-name" title="#{res.title}" />
											<span class="resource-title-summary"><span>#{utilBean.getLocaleMessage(res.type)}</span> #{msg.added_by} <span>#{res.getOwnerUser().username}</span></span>
										</div>
									</div>
								</div>

							</div>
						</h:panelGroup>
					</p:repeat>

					<h:outputText value="No resources were submitted" rendered="#{empty submissionBean.selectedResources and submissionBean.submitted}" class="nothing_found"/>
					<h:panelGroup id="add_resource_sign" layout="block" rendered="#{not submissionBean.submitted and not submissionBean.submissionOverviewReadOnly}">

						<div class="resource-block" style="box-shadow:none;">
							<div class="resource-preview-wrapper">
								<div class="resource-preview-wrapper2">
									<h:graphicImage value="/resources/image/add_sign.png" styleClass=" add-resource-image" alt="select a resource" />
								</div>
							</div>
						</div>
					</h:panelGroup>
					<div class="clear"></div>

				</h:panelGroup>
				<h:form id="submit_resources_form" prependId="false">
					<p:commandButton id="submit_resources_button" value="#{msg.submit}" class="greenbutton" style="display:none;" action="#{submissionBean.actionSubmitItems}" update=" :resourceGrid2 :growl" onclick="return confirmSubmitMessage();" rendered="#{not submissionBean.submitted}"/>
				</h:form>
			</h:panelGroup>

			<div id="lightbox" class="submit-resources">
				<div id="lightbox_background" onclick="select_res_lightbox.close();"></div>

				<div id="lightbox_container">
					<div id="lightbox_title">
						<h:outputFormat value="#{msg['Submission.lightbox_header']}">
							<f:param value="#{submissionBean.selectedSubmission.noOfResources}"/>
						</h:outputFormat>
						<a href="#" onclick="select_res_lightbox.close(); return false;" id="lightbox_close" title="close"></a>
					</div>
					<div id="lightbox_content" style="overflow-y:auto;overflow-x:hidden;background: white;">
						<h:panelGroup id="resourceGrid" styleClass="resource-grid" layout="block" style="padding-left:5px;padding-top:5px;background-color:white;">
							<p:repeat var="res" value="#{submissionBean.resources}" >

								<h:panelGroup styleClass="resource-item2 group-resources-item2" pt:data-itemType="resource" pt:data-itemId="#{res.id}" layout="block">
									<div class="resource-block">

										<div class="resource-preview">
											<div class="resource-preview-wrapper">
												<img class="resource-preview-image" src="#{res.thumbnail1.url}" alt="#{res.title}" />
											</div>
										</div>

										<div class="resource-title">
											<div class="resource-title-wrapper">
												<div class="resource-title-text">
													<h:outputText value="#{res.title}" escape="false" styleClass="resource-title-name" title="#{res.title}" />
													<span class="resource-title-summary"><span>#{utilBean.getLocaleMessage(res.type)}</span> #{msg.added_by} <span>#{res.getOwnerUser().username}</span></span>
												</div>
											</div>
										</div>

									</div>

								</h:panelGroup>
							</p:repeat>
							<h:panelGroup style="background-color:white;height:100%;" rendered="#{empty submissionBean.resources}" layout="block">
								<h:outputText value="#{msg.no_resources_found}" class="nothing_found" style="color:black;"/>
								<span style="color:black;" class="nothing_found">
						First add resources to
						<h:outputLink value="myhome/resources.jsf" style="text-decoration:underline;color:black;">
						#{msg.myResourcesTitle}.
						</h:outputLink>
					</span>
							</h:panelGroup>
						</h:panelGroup>

					</div>
					<div id="lightbox_footer">
					<span class="archive_timestamp_overlay_text">
						<button class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" style="padding:8px 14px; font-size:16px !important;" onclick="selectResources();">#{msg.add}</button>
					</span>
					</div>
				</div>
			</div>
		</h:panelGroup>

		<script type="text/javascript">
			var select_res_lightbox = new lightbox_utils();

			function confirmSubmitMessage()
			{
				var confirmMessage = "Are you sure you want to submit? You will no longer be able to submit any more resources."
				//var no_selected_resources = $('.group-resources-item').length;
				if(resources_to_select > 0)
					confirmMessage = "You should select " + resources_to_select + " more resource" + (resources_to_select > 1 ? "s" : "") +" for your submission. " + confirmMessage;
				return confirm(confirmMessage);
			}

			function hideAddSign(){
				$('#add_resource_sign').hide();
			}

			function selectResources(){
				updateSelectedItemsCommand([
					{name: 'action', value: 'add'},
					{name: 'items', value: selectedResources.getItemsAsJson()}
				]);
				selectedResources.clear();
				select_res_lightbox.close();
			}

			function updateMaxResources(){
				var no_selected_resources = $('.group-resources-item').length;
				resources_to_select = max_resources - no_selected_resources;
				if(resources_to_select == 0)
					$('#add_resource_sign').hide();
				if(no_selected_resources > 0)
					$('#submit_resources_button').show();

				$('#add_resource_sign').on('click', function(){
					select_res_lightbox.open();
				});
			}

			function selectResourceDND() {
				var $dataGrid = $('#resourceGrid');

				// disable drag and drop for the activity log
				if($dataGrid.hasClass("not-selectable"))
					return;

				$dataGrid.selectable({
					filter: 'div.group-resources-item2',

					selecting: function(event, ui) {
						if ($(".ui-selected, .ui-selecting").length > resources_to_select) {
							$('.ui-selecting').removeClass("ui-selecting");
						}
					},
					unselecting: function(event, ui) {
						var elementToRemove = ui.unselecting;
						selectedResources.removeElement(elementToRemove);
					},
					start: function (e) {
						if (!(e.ctrlKey||e.metaKey)) {
							selectedResources.clear();
						}
					},
					stop: function () {
						selectedResources.add($(".ui-selected"));
					},
					cancel: 'a'
				});
			}

			$(document).ready(function(){
				selectResourceDND();
				select_res_lightbox.load();
				$(window).resize(select_res_lightbox.resize_container);
				$('#add_resource_sign').on('click', function(){
					select_res_lightbox.open();
				});

				// register esc key
				$(document).keydown(function (e) {
					if (e.which == 27)
						select_res_lightbox.close();
				});

				$(document).on('click', '.resource-controls2 a', function (e) {
					var action = (this.className.match(/action-[^\s]+/) || []).pop().replace('action-', '');
					var element = $(this).parents('.group-resources-item')[0];
					e.preventDefault();
					e.stopPropagation();


					selected.clearAndAdd(element);
					if(action === "delete")
						doAction("remove");
				});

				updateMaxResources();
			});

			function newSelectedItems() {
				this.removeElement = function (element) {
					if (element && element.nodeType === 1) {
						var elementType = element.getAttribute("data-itemType");
						var elementId = element.getAttribute("data-itemId");

						if (elementType && elementId) {
							var index = this.inSelected(elementType, elementId);
							if (index !== -1) {
								this.items.splice(index, 1);
							}
						}
					}
				};
			}

			newSelectedItems.prototype = new SelectedItems();
			newSelectedItems.prototype.selectItem = function (type, id) {};
			newSelectedItems.prototype.clear = function () {
				$(".group-resources-item2.ui-selected").removeClass("ui-selected");
				this.items = [];
			};

			var selectedResources = new newSelectedItems();

			function lightbox_utils()
			{
				this.box;

				this.load = function() {
					this.box = $('.submit-resources');
				}

				this.close = function() {
					this.box.hide();
					this.box.detach();
				}

				this.open = function() {
					this.box.appendTo(document.body);
					this.resize_container();
					this.box.show();
				};

				this.resize_container = function() {
					var height = $(window).height() - 167;
					$('#lightbox_container').height(height < 200 ? 200 : height);
				}

			}
		</script>
	</ui:define>
<!--	:right_pane_wrapper-->
	<ui:define name="right_layout">
		<ui:decorate  template="/templates/resources/right_pane.xhtml">
			<ui:param name="bean" value="#{submissionBean}" />
		</ui:decorate>
	</ui:define>
</ui:composition>