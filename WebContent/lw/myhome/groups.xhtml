<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui">

    <ui:param name="loginRequired" value="true"/>
    <ui:param name="pageTitle" value="#{msg.groupsTitle}"/>
    <ui:param name="helpText" value="#{msg.myhomeGroupsHelp}"/>
    <ui:param name="rightPane" value="true"/>

    <ui:define name="breadcrumb_ext">
        <p:menuitem value="#{msg.groupsTitle}" url="myhome/groups.jsf#"/>
    </ui:define>

    <ui:define name="breadcrumb_right">
        <h:form>
            <p:commandButton value="#{msg.createGroup}" onclick="PF('createGroupDialog').show();" global="false"/>
        </h:form>
    </ui:define>

    <ui:define name="center_layout">
        <h:outputStylesheet name="vendor/tooltipster-v3.3.0/tooltipster.min.css"/>
        <h:outputScript name="vendor/tooltipster-v3.3.0/jquery.tooltipster.min.js" target="head"/>

        <script type="text/javascript">
            function applyTooltip()
            {
                $('.tooltip').tooltipster({

                    contentAsHTML:true,
                    //maxWidth: 400,
                    position:'top',
                    //hideOnClick: true;,
                    interactive:true,
                    interactiveTolerance:150 // increase to debug
                });
            }
            $(document).ready(function() {
                applyTooltip();

            });
        </script>

        <h:form id="my_groups">
            <p:dataTable var="group" styleClass="mb-3" tableStyleClass="table-responsive" value="#{groupsBean.myGroups}" emptyMessage="#{msg.no_groups_found}" dynamic="false">
                <f:facet name="header">
                    #{msg.myGroups}
                </f:facet>
                <p:ajax event="sort" oncomplete="applyTooltip()"/>

                <p:column headerText="#{msg.title}" sortBy="#{group.title}">
                    <h:outputLink value="group/resources.jsf" styleClass="tooltip" title="#{group.tooltip}">
                        <f:param name="group_id" value="#{group.id}"/>
                        <h:outputText value="#{group.longTitle}"/>
                    </h:outputLink>

                    <h:outputText value=" (#{msg.new_word})" styleClass="bold_red" rendered="${userBean.newGroups.contains(group)}"/>
                </p:column>

                <p:column headerText="#{msg.description}" sortBy="#{group.description}">
                    <h:outputText value="#{group.description}" escape="false" />
                </p:column>

                <p:column headerText="#{msg.leader}" sortBy="#{group.leader.username}">
                    <h:outputText value="#{group.leader.username}"/>
                </p:column>

                <p:column headerText="#{msg.course}" sortBy="#{group.course.title}">
                    <h:outputText value="#{group.course.title}"/>
                </p:column>

                <p:column headerText="#{msg.members}" sortBy="#{group.memberCount}">
                    <h:outputText value=" #{group.memberCount} #{msg.of} #{group.maxMemberCount}" rendered="#{group.memberCountLimited}"/>
                    <h:outputText value=" #{group.memberCount}" rendered="#{not group.memberCountLimited}"/>
                </p:column>

                <p:column headerText="#{msg.options}" styleClass="td-text-right">
                    <h:outputLink value="group/options.jsf" rendered="#{groupsBean.canDeleteGroup(group)}">
                        <f:param name="group_id" value="#{group.id}"/>
                        <i class="fa fa-fw fa-pencil text-warning" aria-hidden="true"></i>
                    </h:outputLink>

                    <p:commandLink action="#{groupsBean.leaveGroup}" process="@this"
                                   update=":other_groups :growl :my_groups" title="#{msg.leave}" oncomplete="applyTooltip()">
                        <f:setPropertyActionListener target="#{groupsBean.selectedGroup}" value="#{group}"/>
                        <i class="fa fa-fw fa-sign-out text-danger" aria-hidden="true"></i>
                        <p:confirm message="#{utilBean.getLocaleMessage('leave_group_question', group.title)}"/>
                    </p:commandLink>
                </p:column>
            </p:dataTable>
        </h:form>

        <h:form id="other_groups">
            <ui:fragment rendered="#{not empty groupsBean.otherGroups}">
                <p:dataTable tableStyleClass="table-responsive" rows="10" paginator="true" lazy="false" paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}" paginatorPosition="bottom" var="group"
                             value="#{groupsBean.otherGroups}" emptyMessage="#{msg.no_groups_found}">
                    <f:facet name="header">
                        #{msg.otherGroups}
                    </f:facet>

                    <p:ajax event="filter" oncomplete="applyTooltip()"/>
                    <p:ajax event="sort" oncomplete="applyTooltip()"/>

                    <p:column headerText="#{msg.title}" sortBy="#{group.title}" filterBy="#{group.longTitle}"
                              filterMatchMode="contains">
                        <h:outputLink value="group/resources.jsf" styleClass="tooltip" title="#{group.tooltip}">
                            <f:param name="group_id" value="#{group.id}"/>
                            <h:outputText value="#{group.longTitle}"/>
                        </h:outputLink>

                        <h:outputText value=" (#{msg.new_word})" rendered="${userBean.newGroups.contains(group)}"/>
                    </p:column>

                    <p:column headerText="#{msg.description}" filterBy="#{group.description}" filterMatchMode="contains">
                        <h:outputText value="#{group.description}" escape="false"/>
                    </p:column>

                    <p:column headerText="#{msg.language}" rendered="false">
                        <h:outputText value="#{group.language}"/>
                    </p:column>

                    <p:column headerText="#{msg.course}" filterBy="#{group.course.title}" filterMatchMode="contains">
                        <h:outputText value="#{group.course.title}"/>
                    </p:column>

                    <p:column headerText="#{msg.members}" sortBy="#{group.memberCount}">
                        <h:outputText value=" #{group.memberCount} #{msg.of} #{group.maxMemberCount}" rendered="#{group.memberCountLimited}"/>
                        <h:outputText value=" #{group.memberCount}" rendered="#{not group.memberCountLimited}"/>
                    </p:column>

                    <p:column headerText="#{msg.options}" styleClass="td-text-right">
                        <h:outputLink value="group/options.jsf" rendered="#{userBean.moderator}">
                            <f:param name="group_id" value="#{group.id}"/>
                            <i class="fa fa-fw fa-pencil text-warning" aria-hidden="true"></i>
                        </h:outputLink>

                        <p:commandLink action="#{groupsBean.joinGroup}" update=":other_groups :growl :my_groups"
                                       process="@this" title="#{msg.join}" oncomplete="applyTooltip()">
                            <f:setPropertyActionListener target="#{groupsBean.selectedGroup}" value="#{group}"/>
                            <i class="fa fa-fw fa-sign-in text-success" aria-hidden="true"></i>
                        </p:commandLink>
                    </p:column>
                </p:dataTable>
            </ui:fragment>
        </h:form>

        <p:dialog header="#{msg.createGroup}" widgetVar="createGroupDialog"
                  modal="true" resizable="false" responsive="true" closeOnEscape="true" draggable="false">
            <h:form id="create_group_form">
                <div class="form-group">
                    <p:outputLabel for="@next" value="#{msg.title}:"/>
                    <h:inputText id="new_title" value="#{groupsBean.newGroup.title}" validator="#{groupsBean.validateGroupTitle}" required="true"/>
                    <p:message for="@previous"/>
                </div>

                <div class="form-group">
                    <p:outputLabel for="@next" value="#{msg.course}:"/>
                    <p:selectOneMenu id="course_id" value="#{groupsBean.newGroup.courseId}" required="true">
                        <f:selectItems var="c" value="#{userBean.user.courses}" itemLabel="#{c.title}" itemValue="#{c.id}"/>
                    </p:selectOneMenu>
                    <p:message for="@previous"/>
                </div>

                <div class="form-group">
                    <p:outputLabel for="@next" value="#{msg.description}:"/>
                    <p:textEditor id="new_description" widgetVar="editorWidget" value="#{groupsBean.newGroup.description}" height="200">
                        <f:facet name="toolbar">
                            <span class="ql-formats">
                                <button class="ql-bold"></button>
                                <button class="ql-italic"></button>
                                <button class="ql-underline"></button>
                                <button class="ql-strike"></button>
                            </span>
                        </f:facet>
                    </p:textEditor>
                    <p:message for="@previous"/>
                </div>

                <div class="form-group">
                    <p:outputLabel for="@next" value="#{msg.language}:"/>
                    <p:inputText id="new_language" value="#{groupsBean.newGroup.language}"/>
                    <p:message for="@previous"/>
                </div>

                <div class="row">
                    <div class="col">
                        <h:outputText value="* #{msg.mandatory_field}"/>
                    </div>
                    <div class="col text-right">
                        <p:commandButton ajax="true" value="#{msg.createGroup}" action="#{groupsBean.onCreateGroup}"
                                         oncomplete="if (!args.validationFailed) PF('createGroupDialog').hide();applyTooltip()"
                                         process="@form" update="@form :my_groups :growl"/>
                    </div>
                </div>
            </h:form>
        </p:dialog>
    </ui:define>
</ui:composition>
