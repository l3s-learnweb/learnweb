<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
				xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
				xmlns:h="http://xmlns.jcp.org/jsf/html"
				xmlns:f="http://xmlns.jcp.org/jsf/core"
				xmlns:p="http://primefaces.org/ui"
				xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
				xmlns:lw="http://l3s.de/learnweb">

<ui:param name="pageTitle" value="#{msg.search_history}"/>

<ui:define name="metadata">
	<f:metadata>
		<f:viewParam name="user_id" value="#{searchHistoryBean.selectedUserId}"/>
		<f:viewParam name="group_id" value="#{searchHistoryBean.selectedGroupId}"/>
		<f:viewAction action="#{searchHistoryBean.onLoad}"/>
	</f:metadata>
</ui:define>

<ui:define name="breadcrumb">
	<lw:breadcrumb-item link="myhome/search_history.jsf" title="#{msg.search_history}">
		<ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_first.xhtml"/>
	</lw:breadcrumb-item>
</ui:define>

<ui:define name="center_layout">
	<p:panel>
		<div class="row">
			<div class="col-12 col-xl-4 border-right" id="col_sessions">
				<div class="d-flex flex-column-reverse flex-sm-row justify-content-between align-items-center">
					<div class="row">
						<div class="col-6 pr-2">
							<h:form id="search_mode_select">
								<p:commandButton id="selected_group_id_button" value="Groups' History"
												 actionListener="#{searchHistoryBean.actionSetShowGroupHistory}" update=":sessionsList @form"
												 rendered="#{not searchHistoryBean.showGroupHistory}"/>

								<p:commandButton id="group_unselected_button" value="My History"
												 actionListener="#{searchHistoryBean.actionSetShowUserHistory}" update=":sessionsList @form" oncomplete="bindClickToSessionBlock();"
												 rendered="#{searchHistoryBean.showGroupHistory}"/>
							</h:form>
						</div>
						<div class="col-6 pr-2 mb-3">
							<h:form id="search_in_history">
								<div class="ui-inputgroup">
									<p:inputText placeholder="Search query" id="sh-query" value="#{searchHistoryBean.searchQuery}"/>
									<p:commandButton icon="fa fa-search" id="sh-search" ajax="true" update=":sessionsList" actionListener="#{searchHistoryBean.search}"/>
								</div>
							</h:form>
						</div>
					</div>

					<div class="row">
						<h:panelGroup id="sh_nav_desc" layout="block">
							<div class="" id="select-groups">
								<h:form rendered="#{searchHistoryBean.showGroupHistory}" id="select_grouo_form">
									<h:outputText value="Show history for Group: "/>
									<p:selectOneMenu id="select-group-menu" value="#{searchHistoryBean.selectedGroupId}">
										<f:selectItem itemLabel="---------------" itemValue="-1"/>
										<f:selectItems var="group" value="#{searchHistoryBean.currentUser.groups}" itemLabel="#{group.title}" itemValue="#{group.id}"/>
										<p:ajax listener="#{searchHistoryBean.onChangeGroup}" update=":sessionsList @form"/>
									</p:selectOneMenu>
								</h:form>
							</div>
						</h:panelGroup>
					</div>
				</div>

				<h3>Sessions</h3>

				<h:panelGroup id="sessionsList" layout="block">
					<h:outputText value="No Sessions have been recorded yet." rendered="#{empty searchHistoryBean.sessions}"/>

					<h:form>
						<ul class="sh-sessions-list #{searchHistoryBean.showGroupHistory == false ? '' : 'sh-session-group'} overflow-auto vh-100">
							<ui:repeat var="ss" value="#{searchHistoryBean.sessions}">
								<li>
										<p:commandLink update=":queriesList" process="@this" styleClass="white-space-normal">
										<f:setPropertyActionListener target="#{searchHistoryBean.selectedSession}" value="#{ss}"/>
										<span></span>

										<h:panelGroup layout="block" class="cursor-pointer" pt:data-sessionId="#{ss.sessionId}" pt:data-userId="#{ss.userId}">
											<div class="info">
												<p:repeat var="query" value="#{ss.queries}">
													<span class="text-break search-source-icon source-#{query.service}">#{query.query}</span>
												</p:repeat>
											</div>

											<div class="time">
												<h:outputFormat value="#{msg.format_date_and_time_between}" escape="false">
													<f:param value="#{ss.startTimestamp}"/>
													<f:param value="#{ss.endTimestamp}"/>
												</h:outputFormat>
											</div>
											<span><b>#{searchHistoryBean.showGroupHistory == false ? '' : 'From: '.concat(ss.userName)}</b></span>
										</h:panelGroup>
									</p:commandLink>
								</li>
							</ui:repeat>
						</ul>
					</h:form>
				</h:panelGroup>
			</div>

			<div class="col-12 col-xl-4 mt-5 mt-xl-0">
				<h3>Queries</h3>

				<h:panelGroup id="queriesList" layout="block">
					<h:outputText value="Choose any session." rendered="#{empty searchHistoryBean.queries}"/>

					<h:form>
						<h:outputText value="#{searchHistoryBean.selectedSession.startTimestamp}">
							<f:convertDateTime type="date" dateStyle="full" />
						</h:outputText>
						<ul class="sh-queries-list overflow-auto vh-100">
							<ui:repeat var="sq" value="#{searchHistoryBean.queries}">
								<li class="py-2 queries-background">
									<p:commandLink update=":snippetsList" process="@this" styleClass="white-space-normal px-2">
										<f:setPropertyActionListener target="#{searchHistoryBean.selectedQuery}" value="#{sq}"/>

										<h:outputText value="#{sq.timestamp}" styleClass="query-time">
											<f:convertDateTime type="time" dateStyle="full" />
										</h:outputText>

										<span class="snippet-list-dot"></span>

										<h:outputText value="#{sq.query}" styleClass="d-block query-desc text-break ml-4"/>
									</p:commandLink>
								</li>
							</ui:repeat>
						</ul>
					</h:form>
				</h:panelGroup>
			</div>

			<h:panelGroup id="snippetsList" styleClass="col-12 col-xl-4 mt-5 mt-xl-0" layout="block">
				<h:panelGroup styleClass="sh-snippets-list overflow-auto vh-100" rendered="#{searchHistoryBean.selectedQuery ne null}" layout="block">
					<h3>Snippets for query: #{searchHistoryBean.selectedQuery.query}</h3>

					<ui:repeat var="sr" value="#{searchHistoryBean.searchResults}">
						<h:panelGroup layout="block" pt:data-searchId="#{sr.searchId}" pt:data-rank="#{sr.rank}" styleClass="snippet my-3">
							<span><a href="#{sr.url}" target="_blank"><h:outputText value="#{sr.title}" escape="false"/></a></span><br/>
							<span class="reference_url">#{sr.url}</span><br/>
							<span>#{sr.description}</span><br/>
							<span class="float-right">rank: &#35;#{sr.rank}</span>
						</h:panelGroup>
					</ui:repeat>
				</h:panelGroup>
			</h:panelGroup>
		</div>
	</p:panel>
</ui:define>

</ui:composition>
