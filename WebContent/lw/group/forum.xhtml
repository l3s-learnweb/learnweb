<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
				xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
				xmlns:h="http://xmlns.jcp.org/jsf/html"
				xmlns:f="http://xmlns.jcp.org/jsf/core"
				xmlns:p="http://primefaces.org/ui"
				xmlns:of="http://omnifaces.org/functions"
				xmlns:lw="http://l3s.de/learnweb">

<ui:param name="pageTitle" value="#{msg.forum}"/>

<ui:define name="metadata">
	<f:metadata>
		<f:viewParam name="group_id" value="#{forumBean.groupId}" converter="idConverter" required="true"/>
		<f:viewAction action="#{forumBean.onLoad}"/>
	</f:metadata>
</ui:define>

<ui:define name="breadcrumb">
	<lw:breadcrumb-item link="myhome/groups.jsf" title="#{msg.myGroups}">
		<ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_first.xhtml"/>
	</lw:breadcrumb-item>

	<lw:breadcrumb-item link="group/resources.jsf?group_id=#{forumBean.groupId}" title="#{forumBean.group.title}" >
		<ui:repeat var="groups" value="#{userBean.user.groups}">
			<li><a href="#{request.contextPath}/lw/group/resources.jsf?group_id=#{groups.id}">#{groups.title}</a></li>
		</ui:repeat>
	</lw:breadcrumb-item>

	<lw:breadcrumb-item link="group/forum.jsf?group_id=#{forumBean.groupId}" title="#{msg.forum}">
		<ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_my_groups.xhtml">
			<ui:param name="groupId" value="#{forumBean.groupId}"/>
		</ui:decorate>
	</lw:breadcrumb-item>
</ui:define>

<ui:define name="center_layout">
	<h:form>
		<p:blockUI block="forum_table" widgetVar="topicsOverlay">
			<h:outputText value="#{msg.please_wait}"/>
		</p:blockUI>

		<p:dataTable var="topic" value="#{forumBean.topics}" rows="20" paginator="true" id="forum_table"
					 paginatorPosition="bottom" paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
					 emptyMessage="#{msg['ForumIndex.no_forum_topics']}">
			<f:facet name="header">
				<div class="d-flex">
					<div class="me-auto">#{msg.forum}</div>
					<div>
						<p:commandButton value="#{msg['ForumIndex.new_topic']}" onclick="PF('newTopicDialog').show();"
										 styleClass="alt-btn ms-2" rendered="${forumBean.group.isMember(userBean.user)}"/>
					</div>
				</div>
			</f:facet>

			<p:column headerText="#{msg['ForumIndex.topic']}" sortBy="#{topic.title}">
				<h:link outcome="/lw/group/forum_topic.jsf?topic_id=#{topic.id}">
					<ui:fragment rendered="#{userBean.user.lastLoginDate lt topic.lastPostDate}">
						<i class="fas fa-fw fa-envelope" aria-hidden="true"></i>
					</ui:fragment>
					<h:outputText value="#{topic.title}"/>
				</h:link>
			</p:column>

			<p:column headerText="#{msg['ForumIndex.replies']}" styleClass="text-center" sortBy="#{topic.replies}">
				<h:outputText value="#{topic.replies}"/>
			</p:column>

			<p:column headerText="#{msg['ForumIndex.views']}" styleClass="text-center" sortBy="#{topic.views}">
				<h:outputText value="#{topic.views}"/>
			</p:column>

			<p:column headerText="#{msg['ForumIndex.author']}" styleClass="text-center" sortBy="#{topic.user.username}">
				<h:link value="#{topic.user.username}" outcome="/lw/user/detail.jsf?user_id=#{topic.userId}"/>
			</p:column>

			<p:column headerText="#{msg['ForumIndex.lastMessage']}" styleClass="text-center" sortBy="#{topic.lastPostDate}">
				<h:outputText value="#{topic.lastPostDate}" styleClass="d-block">
					<f:convertDateTime type="localDateTime" timeStyle="short" dateStyle="medium" timeZone="#{userBean.timeZone}"/>
				</h:outputText>
				<div>#{msg.by} <h:link value="#{topic.lastPostUser.username}" outcome="/lw/user/detail.jsf?user_id=#{topic.userId}"/></div>
			</p:column>

			<p:column headerText="#{msg.options}" styleClass="td-text-end" rendered="#{userBean.moderator}" >
				<p:commandButton value="#{msg.delete}" actionListener="#{forumBean.onDeleteTopic(topic)}" styleClass="moderator-btn"
								 process="@this" update="@form" onstart="PF('topicsOverlay').show()" oncomplete="PF('topicsOverlay').hide()">
					<p:confirm message="#{of:format1(msg.delete_entry_confirm_message, topic.title)}"/>
				</p:commandButton>
			</p:column>
		</p:dataTable>
	</h:form>

	<p:dialog header="#{msg['ForumIndex.new_topic']}" widgetVar="newTopicDialog" rendered="${forumBean.group.isMember(userBean.user)}"
			  modal="true" resizable="false" draggable="false" responsive="true" closeOnEscape="true">
		<h:form id="new_topic_form">
			<div class="form-group">
				<p:outputLabel for="@next" value="#{msg['ForumIndex.topic']}:"/>
				<p:inputText id="post_topic" value="#{forumBean.newTopicTitle}"/>
				<p:message for="@previous"/>
			</div>

			<ui:fragment rendered="#{forumBean.group.restrictionForumCategoryEnabled}">
				<div class="form-group">
					<p:outputLabel for="@next" value="#{msg.category}:"/>
					<p:selectOneMenu id="post_category" value="#{forumBean.newTopicCategory}" editable="true"
									 required="#{forumBean.group.restrictionForumCategoryRequired}">
						<f:selectItems value="#{forumBean.categories}"/>
					</p:selectOneMenu>
					<p:message for="@previous"/>
				</div>
			</ui:fragment>

			<div class="form-group">
				<p:outputLabel for="@next" value="#{msg['PostShow.postContent']}:"/>
				<p:textEditor id="post_message" widgetVar="editorWidget" value="#{forumBean.newTopicText}" height="200">
					<f:facet name="toolbar">
						<span class="ql-formats">
                            <select class="ql-font"/>
                            <select class="ql-size"/>
                        </span>
						<span class="ql-formats">
                            <button class="ql-bold"/>
                            <button class="ql-italic"/>
                            <button class="ql-underline"/>
                            <button class="ql-strike"/>
                        </span>
						<span class="ql-formats">
                            <select class="ql-color"/>
                            <select class="ql-background"/>
                        </span>
						<span class="ql-formats">
                            <button class="ql-script" value="sub"/>
                            <button class="ql-script" value="super"/>
                        </span>
						<span class="ql-formats">
                            <!--<button class="ql-header" value="1"/>
                            <button class="ql-header" value="2"/>-->
							<button class="ql-blockquote"/>
                            <button class="ql-code-block"/>
                        </span>
						<span class="ql-formats">
                            <button class="ql-list" value="ordered"/>
                            <button class="ql-list" value="bullet"/>
                            <button class="ql-indent" value="-1"/>
                            <button class="ql-indent" value="+1"/>
                        </span>
						<!--<span class="ql-formats">
                            <button class="ql-direction" value="rtl"/>
                            <select class="ql-align"/>
                        </span>-->
						<!--<span class="ql-formats">
                            <button class="ql-link"/>
                            <button class="ql-image"/>
                            <button class="ql-video"/>
                            <button class="ql-formula"/>
                        </span>-->
						<span class="ql-formats">
                            <button class="ql-clean"/>
                        </span>
					</f:facet>
				</p:textEditor>
				<p:message for="@previous"/>
			</div>

			<p:commandButton value="#{msg.save}" action="#{forumBean.onSavePost}" process="@form" update="@form"
							 oncomplete="if (!args.validationFailed) PF('newTopicDialog').hide();"/>
		</h:form>
	</p:dialog>
</ui:define>
</ui:composition>
