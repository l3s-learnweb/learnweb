<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:of="http://omnifaces.org/functions"
                xmlns:lw="http://l3s.de/learnweb">

<ui:param name="pageTitle" value="#{groupOverviewBean.group.title}"/>
<ui:param name="helpText" value="#{msg.groupOverviewHelp}"/>

<ui:define name="metadata">
    <f:metadata>
        <f:viewParam name="group_id" value="#{groupOverviewBean.groupId}"/>
        <f:viewAction action="#{groupOverviewBean.onLoad}"/>
    </f:metadata>
</ui:define>

<ui:define name="breadcrumb">
    <lw:breadcrumb-item link="myhome/groups.jsf" title="#{msg.myGroups}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_first.xhtml"/>
    </lw:breadcrumb-item>

    <lw:breadcrumb-item link="group/resources.jsf?group_id=#{groupOverviewBean.groupId}" title="#{groupOverviewBean.group.title}" >
        <p:repeat var="groups" value="#{userBean.user.groups}">
            <li><a href="group/resources.jsf?group_id=#{groups.id}">#{groups.title}</a></li>
        </p:repeat>
    </lw:breadcrumb-item>

    <lw:breadcrumb-item link="group/overview.jsf?group_id=#{groupOverviewBean.groupId}" title="#{msg.overview}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_my_groups.xhtml">
            <ui:param name="groupId" value="#{groupOverviewBean.groupId}"/>
        </ui:decorate>
    </lw:breadcrumb-item>
</ui:define>

<ui:define name="center_layout">
    <h:outputStylesheet library="vendor" name="fancybox-v3.5.7/jquery.fancybox.min.css"/>
    <h:outputScript library="vendor" name="fancybox-v3.5.7/jquery.fancybox.min.js" target="body"/>
    <h:outputScript library="layout" name="js/lib/og-grid.js" target="body"/>

    <div class="row">
        <div class="col-md-6">
            <p:panel header="#{msg.group_details}" styleClass="text-break">
                <f:facet name="actions">
                    <h:form>
                        <p:commandButton action="#{groupsBean.joinGroup}" disabled="#{not groupOverviewBean.group.canJoinGroup(userBean.user)}" styleClass="alt-btn" value="#{msg.join_group}" immediate="true"
                                         oncomplete="window.location.replace(window.location.href);" rendered="${not groupOverviewBean.group.isMember(userBean.user)}">
                            <f:setPropertyActionListener target="#{groupsBean.selectedGroup}" value="#{groupOverviewBean.group}"/>
                            <f:setPropertyActionListener target="#{userBean.sidebarMenuModel}" value="#{null}"/>
                        </p:commandButton>

                        <p:commandButton action="#{groupsBean.leaveGroup}" styleClass="secondary-btn" value="#{msg.leave_group}" immediate="true"
                                         oncomplete="window.location.replace(window.location.href);" rendered="${groupOverviewBean.group.isMember(userBean.user)}">
                            <f:setPropertyActionListener target="#{groupsBean.selectedGroup}" value="#{groupOverviewBean.group}"/>
                            <f:setPropertyActionListener target="#{userBean.sidebarMenuModel}" value="#{null}"/>
                            <p:confirm message="#{of:format1(msg.leave_group_question, groupOverviewBean.group.title)}"/>
                        </p:commandButton>
                    </h:form>
                </f:facet>

                <h5>#{groupOverviewBean.group.title}</h5>
                <p><h:outputText value="#{groupOverviewBean.group.description}" escape="false"/></p>
                <p class="mb-1">
                    <h:outputText value="#{msg.resources}: " styleClass="font-weight-bold"/>
                    <h:outputText value="#{groupOverviewBean.group.resourcesCount}"/>
                </p>
                <p class="mb-1">
                    <h:outputText value="#{msg.members}: " styleClass="font-weight-bold"/>
                    <h:outputText value="#{groupOverviewBean.group.memberCount}"/>
                </p>
                <p class="mb-1">
                    <h:outputText value="#{msg.created_by}: " styleClass="font-weight-bold"/>
                    <h:outputText value="#{groupOverviewBean.group.leader.username}"/>
                </p>
            </p:panel>

            <p:panel header="#{msg.members}" id="members">
                <h:form>
                    <ul class="gridder clearfix member-grid">
                        <ui:repeat var="user" value="#{groupOverviewBean.members}">
                            <li class="gridder-list member-item" data-griddercontent="#user${user.id}">
                                <p:commandLink onclick="return false;" styleClass="member-block">
                                    <div class="member-picture">
                                        <img src="#{user.image}" alt="#{user.fullName}"/>
                                    </div>

                                    <ui:fragment rendered="#{not empty user.credits}">
                                        <div class="member-star"></div>
                                    </ui:fragment>

                                    <div class="member-username text-center text-truncate p-1">#{user.username}</div>
                                </p:commandLink>
                            </li>

                            <div id="user${user.id}" class="gridder-content">
                                <ui:fragment rendered="#{groupOverviewBean.userDetailsHidden}">
                                    <h:outputText value="This information is hidden due to the privacy settings of your organization." styleClass="m-2 d-block"/>
                                </ui:fragment>

                                <ui:fragment rendered="#{not groupOverviewBean.userDetailsHidden}">
                                    <ui:decorate template="/WEB-INF/templates/blocks/user/member-details.xhtml">
                                        <ui:param name="user" value="#{user}"/>
                                    </ui:decorate>
                                </ui:fragment>
                            </div>
                        </ui:repeat>
                    </ul>

                    <h:panelGroup class="text-center mt-3" rendered="#{not groupOverviewBean.showAllMembers}" layout="block">
                        <p:commandButton id="loadAllMembers" value="#{msg.all_members}" styleClass="secondary-btn" onstart="PF('membersOverlay').show()" oncomplete="initGridder();PF('membersOverlay').hide()"
                                         update="@form" actionListener="#{groupOverviewBean.fetchAllMembers()}" global="false"/>
                    </h:panelGroup>

                    <p:blockUI block="members" widgetVar="membersOverlay"/>
                </h:form>
            </p:panel>
        </div>

        <div class="col-md-6">
            <ui:decorate template="/WEB-INF/templates/blocks/group/summary_overview.xhtml">
                <ui:param name="summary" value="#{groupOverviewBean.getSummaryOverview()}"/>
                <ui:param name="summaryTitle" value="#{groupOverviewBean.summaryTitle}"/>
            </ui:decorate>

            <p:panel header="#{msg.all_activities}" id="resourcesView">
                <h:form id="group_activity">
                    <ui:repeat value="#{groupOverviewBean.logMessages}" var="logEntry" varStatus="status">
                        <ui:decorate template="/WEB-INF/templates/blocks/user/log-entry.xhtml">
                            <ui:param name="showPreview" value="true"/>
                            <ui:param name="status" value="#{status}"/>
                            <ui:param name="logEntry" value="#{logEntry}"/>
                        </ui:decorate>
                    </ui:repeat>

                    <h:panelGroup class="text-center mt-3" rendered="#{not groupOverviewBean.showAllLogs}" layout="block">
                        <p:commandButton value="#{msg.full_history}" styleClass="secondary-btn"
                                         update="@form" actionListener="#{groupOverviewBean.fetchAllLogs()}"/>
                    </h:panelGroup>
                </h:form>
            </p:panel>
        </div>
    </div>

    <script>
        function initGridder() {
            $('.gridder').gridderExpander({
                scroll: false,
                showNav: false,
                animationSpeed: 400,
                animationEasing: 'easeInOutExpo'
            });
        }

        $(function() {
            initGridder();
        });
    </script>
</ui:define>
</ui:composition>
