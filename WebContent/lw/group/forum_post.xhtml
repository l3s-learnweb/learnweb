<ui:composition template="/WEB-INF/templates/blocks/group/template.xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui">

<ui:param name="loginRequired" value="true"/>
<ui:param name="disableGrowl" value="true"/>
<ui:param name="pageTitle" value="#{forumPostBean.topic.title}"/>
<ui:param name="group" value="#{forumPostBean.group}"/>

<ui:define name="metadata">
    <f:metadata>
        <f:viewParam name="topic_id" value="#{forumPostBean.topicId}"/>
        <f:viewAction action="#{forumPostBean.preRenderView}"/>
    </f:metadata>
</ui:define>

<ui:define name="breadcrumb_ext">
    <p:menuitem value="#{forumPostBean.group.title}" url="group/overview.jsf?group_id=#{forumPostBean.group.id}"/>
    <p:menuitem value="#{msg.forum}" url="group/forum.jsf?group_id=#{forumPostBean.group.id}"/>
    <p:menuitem value="#{forumPostBean.topic.title}" url="group/forum_post.jsf?topic_id=#{forumPostBean.topicId}"/>
</ui:define>

<ui:define name="group_layout">
    <p:panel styleClass="mb-3 ui-widget-content-p-0">
        <f:facet name="header">
            <span class="text-light">#{msg['ForumIndex.messages']} #{msg.of}</span> "#{forumPostBean.topic.title}"
        </f:facet>
        <f:facet name="actions">
            <h:form id="center_header_form">
                <p:commandButton value="#{msg['ForumIndex.post_reply']}" rendered="#{forumPostBean.member}"
                                 href="#{request.contextPath}/lw/group/forum_post.jsf?topic_id=#{forumPostBean.topic.id}#reply"
                                 styleClass="alt-btn"
                                 onclick="$('html, body').animate({scrollTop:$(document).height()}, 'slow');">
                </p:commandButton>

                <p:commandLink rendered="#{not forumPostBean.member}" action="#{groupsBean.joinGroup}" styleClass="secondary-btn"
                               update=":growl @form" partialSubmit="true" process="@this" value="#{msg.join_group}">
                    <f:setPropertyActionListener target="#{groupsBean.selectedGroup}" value="#{forumPostBean.group}"/>
                </p:commandLink>
            </h:form>
        </f:facet>

        <h:form prependId="false">
            <p:dataTable var="post" value="#{forumPostBean.posts}" rows="10" paginator="true" lazy="false" paginatorPosition="bottom"
                         id="forum_post_table" style="margin-top: 0 !important;"
                         paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">

                <p:column headerText="#{msg.author}" styleClass="col text-center" width="120">
                    <div>
                        <h:link value="#{post.user.username}" styleClass="mx-auto"  outcome="/lw/user/detail.jsf?user_id=#{post.userId}"/>
                    </div>

                    <img class="img-fluid" src="${learnwebBean.getProfileImage(post.user)}" id="profile_image" alt="profile image"/>

                    <div>
                        <h:outputText value="#{msg.registered_since}: "/>
                        <h:outputText value="#{post.user.registrationDate}">
                            <f:convertDateTime dateStyle="default" type="date" timeZone="#{userBean.timeZone}"/>
                        </h:outputText>
                        <br/>
                        <h:outputText value="#{msg['ForumIndex.messages']}: #{post.user.forumPostCount}"/>
                    </div>

                </p:column>

                <p:column headerText="#{msg['ForumIndex.messages']}" styleClass="col align-top">
                    <div class="p-1 border-bottom pb-4">
                        <div class="float-right">
                            #{msg['ForumIndex.postedOn']}
                            <h:outputText value="#{post.date}">
                                <f:convertDateTime type="both" timeStyle="short" dateStyle="long" timeZone="#{userBean.timeZone}"/>
                            </h:outputText>
                        </div>
                        <ui:fragment rendered="#{not empty post.category}">
                            #{msg.category}: #{post.category}
                        </ui:fragment>
                    </div>

                    <div class="">
                        <h:outputText value="#{post.text}" escape="false"/>
                        <!--float-right w-100 p-2 border-top position-absolute-->
                        <div class="border-top w-100 position-absolute" style="bottom:0px;">
                            <ui:fragment rendered="#{post.editCount gt 0}">
                                <div class="float-left py-2">
                                    <h:outputFormat value="#{msg['PostShow.editCountSingle_Many']}">
                                        <f:param value="#{post.editCount}"/>
                                        <f:param value="#{post.lastEditDate}"/>
                                        <f:param value="#{post.editUser.username}"/>
                                    </h:outputFormat>
                                </div>
                            </ui:fragment>

                            <p:commandLink value="#{msg.delete}" rendered="#{forumPostBean.canDeletePost(post)}" ajax="true"
                                           actionListener="#{forumPostBean.deletePost(post)}" styleClass="float-right mr-2 p-2" update=":forum_post_table"/>
                            <h:outputLink value="group/forum_post_edit.jsf" rendered="#{forumPostBean.canEditPost(post)}" styleClass="float-right mr-2 p-2">
                                <f:param name="post_id" value="#{post.id}"/>
                                #{msg.edit}
                            </h:outputLink>
                            <p:commandLink value="#{msg['ForumIndex.quote']}" actionListener="#{forumPostBean.quotePost(post)}"
                                           update=":post_form:post_message" ajax="true" styleClass="float-right mr-2 p-2"/>
                        </div>
                    </div>
                </p:column>
            </p:dataTable>
        </h:form>
    </p:panel>

    <ui:fragment rendered="#{forumPostBean.member}">
        <p:panel header="#{msg['ForumIndex.reply']}" styleClass="mb-3">
            <h:form id="post_form">
                <table id="answer_table">
                    <ui:fragment rendered="#{forumPostBean.group.restrictionForumCategoryEnabled}">
                        <tr class="mb-2">
                            <td>
                                <h:outputText value="#{msg.category}: " />
                            </td>
                            <td><p:selectOneMenu id="post_category" styleClass="w-100" required="#{forumPostBean.group.restrictionForumCategoryRequired}"
                                                 value="#{forumPostBean.newPost.category}" editable="true" label="#{msg.category}">
                                <f:selectItems value="#{forumPostBean.categories}" />
                            </p:selectOneMenu></td>
                            <td>
                                <p:message for="post_category" />
                            </td>
                        </tr>
                    </ui:fragment>
                    <tr>
                        <td colspan="2">
                            <p:textEditor id="post_message" widgetVar="editorWidget" value="#{forumPostBean.newPost.text}">
                                <f:facet name="toolbar">
                                 <span class="ql-formats">
                                    <button class="ql-bold"></button>
                                    <button class="ql-italic"></button>
                                    <button class="ql-underline"></button>
                                    <button class="ql-strike"></button>
                                </span>
                                    <span class="ql-formats">
                                    <select class="ql-font"></select>
                                    <select class="ql-size"></select>
                                </span>
                                </f:facet>
                            </p:textEditor>
                        </td>
                        <td>
                            <p:message for="post_message" />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3">
                            <p:commandButton ajax="true" value="#{msg.save}" styleClass="mt-2"
                                             action="#{forumPostBean.onSavePost}" validateClient="true" update="@form :forum_post_table" />
                        </td>
                    </tr>
                </table>
            </h:form>
        </p:panel>
    </ui:fragment>
</ui:define>
</ui:composition>
