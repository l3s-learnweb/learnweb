<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:lw="http://l3s.de/learnweb">


<ui:param name="pageTitle" value="#{forumPostBean.topic.title}"/>

<ui:define name="metadata">
    <f:metadata>
        <f:viewParam name="topic_id" value="#{forumPostBean.topicId}" converter="idConverter" />
        <f:viewAction action="#{forumPostBean.onLoad}"/>
    </f:metadata>
</ui:define>

<ui:define name="breadcrumb">
    <lw:breadcrumb-item link="myhome/groups.jsf" title="#{msg.myGroups}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_first.xhtml"/>
    </lw:breadcrumb-item>

    <lw:breadcrumb-item link="group/resources.jsf?group_id=#{forumPostBean.group.id}" title="#{forumPostBean.group.title}" >
        <p:repeat var="groups" value="#{userBean.user.groups}">
            <li><a href="group/resources.jsf?group_id=#{groups.id}">#{groups.title}</a></li>
        </p:repeat>
    </lw:breadcrumb-item>

    <lw:breadcrumb-item link="group/forum.jsf?group_id=#{forumPostBean.group.id}" title="#{msg.forum}">
        <ui:decorate template="/WEB-INF/templates/blocks/breadcrumb/nav_list_my_groups.xhtml">
            <ui:param name="groupId" value="#{forumPostBean.group.id}"/>
        </ui:decorate>
    </lw:breadcrumb-item>

    <lw:breadcrumb-item link="group/forum_post.jsf?topic_id=#{forumEditBean.topic.id}" title="#{forumPostBean.topic.title}">
        <p:repeat var="topic" value="#{forumPostBean.topics}">
            <li><a href="group/forum_post.jsf?topic_id=#{topic.id}">#{topic.title}</a></li>
        </p:repeat>
    </lw:breadcrumb-item>
</ui:define>

<ui:define name="center_layout">
    <h:form prependId="false">
        <p:panel styleClass="ui-widget-content-p-0 ui-widget-content-border-0">
            <f:facet name="header">
                #{msg['ForumIndex.topic']}: #{forumPostBean.topic.title}
            </f:facet>
            <f:facet name="actions">
                <p:commandButton value="#{msg['ForumIndex.post_reply']}" process="@this" update=":reply_post_dialog"
                                 actionListener="#{forumPostBean.newPost}" styleClass="alt-btn ml-2"
                                 oncomplete="PF('reply_post_dialog').show();" rendered="#{forumPostBean.group.isMember(userBean.user)}">
                </p:commandButton>
            </f:facet>

            <p:dataTable id="forum_post_table" var="post" value="#{forumPostBean.posts}" rows="10" paginator="true" lazy="false"
                         tableStyleClass="h-100" styleClass="text-break" paginatorPosition="bottom"
                         paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">

                    <p:column headerText="#{msg.author}" styleClass="py-2 text-center align-baseline w-15">
                        <h:link styleClass="d-block mb-1 font-weight-bold" value="#{post.user.username}" outcome="/lw/user/detail.jsf?user_id=#{post.userId}"/>
                        <h:link outcome="/lw/user/detail.jsf?user_id=#{post.userId}">
                            <img class="img-fluid mx-auto profile-picture square fluent" src="${learnwebBean.getProfileImage(post.user)}" alt="#{post.user.fullName}"/>
                        </h:link>

                        <div class="text-muted small">
                            <p class="mb-0">
                                <h:outputText value="#{msg.registered_since}: " styleClass="d-block"/>
                                <h:outputText value="#{post.user.registrationDate}">
                                    <f:convertDateTime dateStyle="default" type="date" timeZone="#{userBean.timeZone}"/>
                                </h:outputText>
                            </p>
                            <p class="mb-0">
                                <h:outputText value="#{msg['ForumIndex.messages']}: #{post.user.forumPostCount}"/>
                            </p>
                        </div>
                    </p:column>

                    <p:column headerText="#{msg['ForumIndex.messages']}" styleClass="h-100">
                        <div class="d-flex flex-column h-100">
                            <div class="row border-bottom pb-1">
                                <ui:fragment rendered="#{not empty post.category}">
                                    <div class="col font-italic">
                                        #{msg.category}: #{post.category}
                                    </div>
                                </ui:fragment>
                                <div class="col text-right">
                                    #{msg['ForumIndex.postedOn']}
                                    <h:outputText value="#{post.date}">
                                        <f:convertDateTime type="both" timeStyle="short" dateStyle="long" timeZone="#{userBean.timeZone}"/>
                                    </h:outputText>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col forum-message-container my-2">
                                    <h:outputText value="#{post.text}" escape="false"/>
                                </div>
                            </div>

                            <div class="row border-top pt-1 mt-auto">
                                <ui:fragment rendered="#{post.editCount gt 0}">
                                    <div class="col">
                                        <h:outputFormat value="#{msg['PostShow.editCountSingle_Many']}">
                                            <f:param value="#{post.editCount}"/>
                                            <f:param value="#{post.lastEditDate}"/>
                                            <f:param value="#{post.editUser.username}"/>
                                            <f:convertDateTime type="both" timeStyle="short" dateStyle="long" timeZone="#{userBean.timeZone}"/>
                                        </h:outputFormat>
                                    </div>
                                </ui:fragment>

                                <div class="col text-right">
                                    <p:commandLink value="#{msg.delete}" rendered="#{forumPostBean.canDeletePost(post)}" update=":forum_post_table"
                                                   ajax="true" actionListener="#{forumPostBean.deletePost(post)}" styleClass="mx-2">
                                        <p:confirm message="Are you sure that you want to delete the post?"/>
                                    </p:commandLink>

                                    <h:outputLink value="group/forum_post_edit.jsf" styleClass="mx-2 text-decoration-none" rendered="#{forumPostBean.canEditPost(post)}">
                                        <f:param name="post_id" value="#{post.id}"/>
                                        <h:outputText value="#{msg.edit}"/>
                                    </h:outputLink>

                                    <p:commandLink value="#{msg['ForumIndex.quote']}" oncomplete="PF('reply_post_dialog').show();" rendered="#{forumPostBean.member}" actionListener="#{forumPostBean.quotePost(post)}" styleClass="mx-2"
                                                   update=":post_form:post_message" ajax="true"/>
                                </div>
                            </div>
                        </div>
                    </p:column>
                </p:dataTable>
        </p:panel>
    </h:form>
    <p:dialog header="#{msg['ForumIndex.reply']}" rendered="#{forumPostBean.group.isMember(userBean.user)}" id="reply_post_dialog" styleClass="modal-dialog" responsive="true" draggable="false" resizable="false" modal="true" appendTo="@(body)" widgetVar="reply_post_dialog">
        <h:form id="post_form">
            <ui:fragment rendered="#{forumPostBean.group.restrictionForumCategoryEnabled}">
                <div class="form-group">
                    <p:outputLabel for="@next" value="#{msg.category}:"/>
                    <p:selectOneMenu id="post_category" required="#{forumPostBean.group.restrictionForumCategoryRequired}"
                                     value="#{forumPostBean.newPost.category}" editable="true" label="#{msg.category}">
                        <f:selectItems value="#{forumPostBean.categories}"/>
                    </p:selectOneMenu>
                    <p:message for="@previous"/>
                </div>
            </ui:fragment>

            <div class="form-group">
                <p:outputLabel for="@next" value="#{msg.message}:" styleClass="d-none"/>
                <p:textEditor id="post_message" widgetVar="editorWidget" value="#{forumPostBean.newPost.text}" height="150">
                    <f:facet name="toolbar">
                            <span class="ql-formats">
                                <select class="ql-font"/>
                                <select class="ql-size"/>
                            </span>
                        <span class="ql-formats">
                                <button class="ql-bold"/>
                                <button class="ql-italic"/>
                                <button class="ql-underline"/>
                                <button class="ql-strike"/>
                            </span>
                        <span class="ql-formats">
                                <select class="ql-color"/>
                                <select class="ql-background"/>
                            </span>
                        <span class="ql-formats">
                                <button class="ql-script" value="sub"/>
                                <button class="ql-script" value="super"/>
                            </span>
                        <span class="ql-formats">
                                <!--<button class="ql-header" value="1"/>
                                <button class="ql-header" value="2"/>-->
                            <button class="ql-blockquote"/>
                                <button class="ql-code-block"/>
                            </span>
                        <span class="ql-formats">
                                <button class="ql-list" value="ordered"/>
                                <button class="ql-list" value="bullet"/>
                                <button class="ql-indent" value="-1"/>
                                <button class="ql-indent" value="+1"/>
                            </span>
                        <!--<span class="ql-formats">
                            <button class="ql-direction" value="rtl"/>
                            <select class="ql-align"/>
                        </span>-->
                        <!--<span class="ql-formats">
                            <button class="ql-link"/>
                            <button class="ql-image"/>
                            <button class="ql-video"/>
                            <button class="ql-formula"/>
                        </span>-->
                        <span class="ql-formats">
                                <button class="ql-clean"/>
                            </span>
                    </f:facet>
                </p:textEditor>
                <p:message for="@previous"/>
            </div>

            <p:commandButton value="#{msg.send}" action="#{forumPostBean.onSavePost}" validateClient="true"
                             ajax="true" oncomplete="PF('reply_post_dialog').hide();" update="@form :forum_post_table"/>
        </h:form>
    </p:dialog>
</ui:define>
</ui:composition>
