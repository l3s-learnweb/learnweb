<ui:composition template="/lw/templates/new_main_t.xhtml" 
	xmlns:ui="http://java.sun.com/jsf/facelets" 
	xmlns:h="http://java.sun.com/jsf/html" 
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

	<ui:param name="helpText" value="#{msg.groupResourceHelp}"/>
	
	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="group_id" value="#{groupDetailBean.groupId}" />
			<f:viewParam name="folder_id" value="#{groupDetailBean.selectedFolderId}" />
			<f:viewParam name="resource_id" value="#{resourceDetailBean.resourceId}" />
			<f:event type="javax.faces.event.PreRenderViewEvent" listener="#{groupDetailBean.preRenderView}" />
			<f:event type="javax.faces.event.PreRenderViewEvent" listener="#{resourceDetailBean.preRenderView}" /> 
		</f:metadata>
	</ui:define>	

	<ui:param name="loginRequired" value="true" />
	<ui:param name="pageTitle" value="#{msg.group} - #{msg.resources}" />
	  
		<ui:define name="center_layout">
	
			<div class="center-header" id="group_header">
				<h2>
					#{msg.resources}
				</h2> 
				<span class="header_detail">
					#{msg.of} 
					#{groupDetailBean.group.title}
					(#{groupDetailBean.group.resourcesCount} #{msg.resources})	
				</span>			
				<h:form id="center_header_form">
				
					<p:menuButton value="#{msg.upload_resource}" rendered="#{groupDetailBean.member and !groupDetailBean.group.restrictionOnlyLeaderCanAddResources}" menuStyleClass="test" iconPos="right" styleClass="resource_button greenbutton resourcetoolbutton">
				        <p:menuitem value="#{msg.create_folder}" icon="ui-icon-folder-collapsed" update=":add_resource_panel" oncomplete="update_header()">
				        	<f:setPropertyActionListener target="#{addResourceBean.resourceTargetGroupId}" value="#{groupDetailBean.groupId}"/>
							<f:setPropertyActionListener target="#{addResourceBean.resourceTargetFolderId}" value="#{groupDetailBean.selectedFolderId}"/>
							<f:setPropertyActionListener target="#{groupDetailBean.rightPanelAction}" value="newFolder"/>
				        </p:menuitem>
				        <p:separator />
				        <p:menuitem value="#{msg.upload_file}" icon="ui-icon-disk" update=":add_resource_panel" oncomplete="update_header()" actionListener="#{addResourceBean.clearForm()}">
				        	<f:setPropertyActionListener target="#{addResourceBean.resourceTargetGroupId}" value="#{groupDetailBean.groupId}"/>
							<f:setPropertyActionListener target="#{addResourceBean.resourceTargetFolderId}" value="#{groupDetailBean.selectedFolderId}"/>
							<f:setPropertyActionListener target="#{addResourceBean.resource.storageType}" value="1"/>
							<f:setPropertyActionListener target="#{groupDetailBean.rightPanelAction}" value="newResource"/>
				        </p:menuitem>
				        <p:menuitem value="#{msg.upload_url}" icon="ui-icon-link" update=":add_resource_panel" oncomplete="update_header()" actionListener="#{addResourceBean.clearForm()}">
				        	<f:setPropertyActionListener target="#{addResourceBean.resourceTargetGroupId}" value="#{groupDetailBean.groupId}"/>
							<f:setPropertyActionListener target="#{addResourceBean.resourceTargetFolderId}" value="#{groupDetailBean.selectedFolderId}"/>
							<f:setPropertyActionListener target="#{addResourceBean.resource.storageType}" value="2"/>
							<f:setPropertyActionListener target="#{groupDetailBean.rightPanelAction}" value="newResource"/>
				        </p:menuitem>
				    </p:menuButton>
				
					<p:commandLink rendered="#{not groupDetailBean.member}" action="#{groupsBean.joinGroup}" 
						styleClass="resource_button greenbutton" update=":growl :group_menu @form" partialSubmit="true" 
						process="@this" value="#{msg.join_group}">
						<f:setPropertyActionListener target="#{groupsBean.selectedGroup}" value="#{groupDetailBean.group}" />
					</p:commandLink>
					
					<p:remoteCommand name="selectResource" actionListener="#{groupDetailBean.selectResource}" update=":add_resource_panel" oncomplete="onSelectResourceCompleted(this.data)"/>
					<p:remoteCommand name="selectFolder" actionListener="#{groupDetailBean.selectFolder}" update=":group_menu_tree :folderGrid :resourceGrid :add_resource_panel" oncomplete="onSelectFolderCompleted(this.data)"/>
					<p:remoteCommand name="moveToFolder" actionListener="#{groupDetailBean.moveToFolder}" update=":group_menu_tree :folderGrid :resourceGrid" oncomplete="resourceDND()"/>
				</h:form>
				
				<ul>								
					<li>
						<a href="./group/overview.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.overview}" />
						</a>
					</li>								
					<li>
						<a class="active" href="./group/resources.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.resources}" />
						</a>
					</li>								
					<li>
						<a href="./group/members.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.members}" />
						</a>
					</li>								
					<li>
						<a href="./group/presentations.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.presentations}" />
						</a>
					</li>								
					<li>
						<a href="./group/links.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.links}" />
						</a>
					</li>
					<li>
						<a href="./group/forum.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.forum}" />
						</a>
					</li>
					<ui:fragment rendered="${userBean.admin || userBean.moderator || groupDetailBean.group.isLeader(userBean.user)}">							
					<li>
						<a href="./group/options.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.options}" />
						</a>
					</li>
					</ui:fragment>
					<li>
						<img alt="" src="#{request.contextPath}/resources/main-template/img/search.png" height="16" width="16" 
							id="search_group_resource" style="padding:3px 15px;cursor:pointer"/>
					
						<h:form id="header_query_form" prependId="false">
							<h:inputText value="#{groupDetailBean.query}" id="input_query_form" />

							<p:commandButton actionListener="${groupDetailBean.onQueryChange()}" partialSubmit="true" 
								oncomplete="$('#center_pane .content').scrollTop(0);" process="@form" 
								update=":datagrid :paginator" value="" id="group_resource_searchbutton"/>
						</h:form>
					</li>
				</ul>
				
				<h:form styleClass="resources-filters" id="filters">
					<ul>
						<ui:repeat value="#{groupDetailBean.availableFilters}" var="filter">
							<li class="filter #{filter.disabled ? 'disabled' : (filter.active ? 'active' : null)}">
								<span class="filter-name">
									<span class="trimmed-text">#{filter.name}</span>
									<span class="arrow"></span>
								</span>
								<ul class="filter-sub-bar vCarousel-wrapper filter-vCarousel">
									<h:panelGroup styleClass="vCarousel-container" layout="block">
										<li class="#{!filter.active ? 'active' : null}">
											<p:commandButton value="#{filter.anyText}" action="#{groupDetailBean.changeFilters(filter.anyUrl)}" update=":datagrid :paginator :filters" oncomplete="updateCarousel()"/>
										</li>
										
										<ui:repeat value="#{filter.items}" var="item">
											<li class="#{item.active ? 'active' : null}">
												<p:commandButton value="#{item.name} #{item.counter != null ? '('.concat(item.counter).concat(')') : null}" action="#{groupDetailBean.changeFilters(item.url)}" update=":datagrid :paginator :filters" oncomplete="updateCarousel()"/>
											</li>
										</ui:repeat>

									</h:panelGroup>
									<li class="vCarousel-expand">
										<p:commandButton value="#{msg.filter_carousel_all}"/>
									</li>
								</ul>
							</li>
						</ui:repeat>
						<h:panelGroup rendered="#{groupDetailBean.searchFilters != null}">
							<li class="filter clear-filters">
								<p:commandButton value="#{msg.clear_filters}" action="#{groupDetailBean.changeFilters(null)}" update=":datagrid :paginator :filters" oncomplete="updateCarousel()"/>
							</li>
						</h:panelGroup>
					</ul>
				</h:form>							
			</div>
	
			<script type="text/javascript">
			/* <!-- */
				$("#header_query_form").css("display","none");
				
				$("#search_group_resource").click(function () {
			          $("#header_query_form").animate({ width: "toggle" }, 500, 'swing');
			          $("#input_query_form").focus();
			          $("#search_group_resource").hide();
			    });
				
				updateCarousel();
					
				$("#center_pane").prepend($("#group_header"));
			/* --> */
			</script>
				
			<p:dialog id="confirmDialog" header="#{msg.delete_resource_title}"  widgetVar="confirmation" appendTo="@(body)" >
		        
		        <h:form prependId="false" id="confirm_dialog_form">
			        <p>
			        	<h:outputText value="#{msg.theResource}"/>
			        	<b> 
			        		<h:outputText value="#{groupDetailBean.clickedResource.title}" escape="false" /> 
			        	</b> 
			        	<h:outputText value=" #{msg.part_of}:"/>
			        </p>
			        <ul>
				        <li>
				        		<h:outputText value="#{msg.the_group_genitive} " />
					        	<h:outputLink value="group/overview.jsf?group_id=#{groupDetailBean.clickedResource.group.id}">
					        		<h:outputText value="#{groupDetailBean.clickedResource.group.title}" />
					        	</h:outputLink>
				        	</li>
				        <li> 
				        	<h:outputText value="#{msg.private_resource} "/>
				         	<h:outputText value=" #{groupDetailBean.clickedResource.ownerUser.username}"/>
				         </li>
			        </ul>
			        <p:commandButton value="#{msg.delete_from_group} '#{groupDetailBean.group.title}'" 
			        	update=":resourceGrid :growl :add_resource_panel"  oncomplete="PF('confirmation').hide(); update_header();" 
			        	actionListener="#{groupDetailBean.removeResourceFromGroup}" process=":resourceGrid" 
			        	style="display:block; margin: 10px 0;"/> 
			        		   			
		   			<p:commandButton value="#{msg.delete_resource_completely}" update=":resourceGrid :growl :add_resource_panel" 
		   				oncomplete="PF('confirmation').hide(); update_header();" actionListener="#{groupDetailBean.deleteResource}" 
		   				process=":resourceGrid" style="display:block; margin: 10px 0;"
		   				rendered="${groupDetailBean.canDeleteResourceCompletely(groupDetailBean.clickedResource)}"/>  
		        </h:form>
		    </p:dialog>
		    
		    <p:dialog id="confirmFolderDialog" header="#{msg.delete_folder_title}"  widgetVar="confirmationFolder" appendTo="@(body)" >
		        
		        <h:form prependId="false" id="confirm_folder_dialog_form">
			        <p> 
				        <h:outputFormat value="#{msg.delete_folder_description}" escape="false">
						  <f:param value="#{groupDetailBean.clickedFolder.name}"/>
						  <f:param value="#{groupDetailBean.clickedFolder.countResources}"/>
						  <f:param value="#{groupDetailBean.clickedFolder.countSubfolders}"/>
						</h:outputFormat>
			        </p>
			        <p><h:outputFormat value="#{msg.delete_folder_confirm_message}"/></p>
			        		   		
			       	<h:panelGrid columns="2" styleClass="float-right" style="margin: 10px 0;">
			   			<p:commandButton styleClass="graybutton" value="#{msg.cancel}" onclick="PF('confirmationFolder').hide(); return false;"/>
			   			
			   			<p:commandButton styleClass="greenbutton" value="#{msg.delete}" update=":group_menu_tree :folderGrid :growl :add_resource_panel" 
			   				oncomplete="PF('confirmationFolder').hide(); update_header();" actionListener="#{groupDetailBean.deleteFolder}" 
			   				process=":folderGrid" rendered="${groupDetailBean.canEditFoldersInGroup()}"/>
		   			</h:panelGrid>
		        </h:form>
		    </p:dialog>
			<p:dialog header="#{msg.edit}" id="comment_dialog1" modal="true" minWidth="440" appendTo="@(body)" widgetVar="comment_dialog">
				<h:form id="comment_dialog_form">	
					<p:inputTextarea autoResize="1" maxHeight="20" value="#{resourceDetailBean.clickedComment.text}" id="edit_comment_textbox"/>
					<p:commandButton actionListener="#{resourceDetailBean.onEditComment}" update=":add_resource_panel" title="#{msg.save}" 
						value="#{msg.save}"	onsuccess="PF('comment_dialog').hide();"/>
				</h:form>
			</p:dialog>
			<p:dialog header="#{msg.options}" closable="false" widgetVar="resource_dialog" appendTo="@(body)" modal="true" minWidth="540">
				<h:form id="resource_form">
					<h:panelGrid columns="2">
						<h:outputText value="#{msg.add_to}:" />
						<p:tree id="folders_tree" value="#{userBean.writeAbleGroupsTree}" var="node" animate="true" dynamic="true" selectionMode="single" selection="#{groupDetailBean.selectedTargetNode}" style="max-height:28rem; overflow:auto;">				        						     						        
					        <p:ajax event="select" listener="#{groupDetailBean.onTargetNodeSelect}"/>
					        
					        <p:treeNode type="group">
					        	<h:outputText id="group" value="#{node.title}"/>
					        </p:treeNode>
					        
					        <p:treeNode type="folder" expandedIcon="ui-icon-folder-open" collapsedIcon="ui-icon-folder-collapsed">
						        <h:outputText value="#{node.name}" />
					        </p:treeNode>
					    </p:tree>
	
						<h:outputText value="#{msg.title}:" />
						<p:inputText value="#{groupDetailBean.clickedResource.title}" styleClass="resource_dialog_field" />
	
						<h:outputText value="#{msg.description}:" />
						<p:inputTextarea value="#{groupDetailBean.clickedResource.description}" autoResize="true" 
							styleClass="resource_dialog_field"/>
	
						<h:outputText value="Url:" />
						<p:inputText value="#{groupDetailBean.clickedResource.url}" disabled="true" styleClass="resource_dialog_field" />
	
						<h:outputText value="#{msg.type}:" />
						<p:inputText value="#{groupDetailBean.clickedResource.type}" disabled="true" styleClass="resource_dialog_field" />
	
						<h:outputText value="#{msg.author}:" />
						<p:inputText value="#{groupDetailBean.clickedResource.author}" styleClass="resource_dialog_field" />
						
						<h:outputText value="" />
						<h:panelGroup colspan="2" styleClass="float-right" style="margin: 10px 0;">
							<p:commandButton styleClass="greenbutton" value="#{msg.save}" action="#{groupDetailBean.addSelectedResource}" 
								update=":resourceGrid :growl" process="@form :resourceGrid" oncomplete="PF('resource_dialog').hide()" style="float:right;"/>
							<p:commandButton styleClass="graybutton" value="#{msg.cancel}" onclick="PF('resource_dialog').hide(); return false;" style="float:left;"/>
						</h:panelGroup>
						
					</h:panelGrid>
				</h:form>
			</p:dialog>
			
			<h:panelGroup id="datagrid" styleClass="datagrid" layout="block" pt:data-isEnableMoving="#{groupDetailBean.canMoveResourcesInGroup()}">
				<h:panelGroup id="folderGrid" styleClass="folder-grid" pt:data-selectedFolderId="#{groupDetailBean.selectedFolderId}" layout="block">				
				    <ui:repeat value="#{groupDetailBean.subfolders}" var="folder"> 			     
				  		<h:panelGroup styleClass="folder-item group-resources-item" pt:data-type="folder" pt:data-resourceId="#{folder.folderId}" layout="block">
				    		<div class="folder-block">
				    		
				    			<div class="folder-icon">
				    				<div class="folder-icon-wrapper">
				    					<span class="icon icon-folder"></span>
				    				</div>
				    			</div>
				    			
				    			<div class="folder-title">
			    					<div class="folder-title-wrapper">
 										<h:outputText value="#{folder.name}" escape="false" styleClass="folder-title-name" title="#{folder.name}" />
									</div>
									
									<h:form class="resource-controls">
										<p:commandLink oncomplete="update_header();" title="#{msg.edit}"
											update=":add_resource_panel" styleClass="resource-controls-button"
											rendered="${groupDetailBean.canEditFoldersInGroup()}">
											<h:graphicImage alt="Edit" value="../resources/icon/Edit.png"/>
											
											<f:setPropertyActionListener target="#{groupDetailBean.clickedFolder}" value="#{folder}"/>
											<f:setPropertyActionListener target="#{groupDetailBean.rightPanelAction}" value="editFolder"/>
											<f:param name="group_id" value="#{groupDetailBean.groupId}" />
										</p:commandLink>
										
										<p:commandLink oncomplete="PF('confirmationFolder').show();" title="#{msg.delete}"
											update=":confirm_folder_dialog_form" styleClass="resource-controls-button"
											rendered="${groupDetailBean.canEditFoldersInGroup()}">
											<h:graphicImage alt="Remove" value="../resources/icon/Remove.png"/>
											
											<f:setPropertyActionListener target="#{groupDetailBean.clickedFolder}" value="#{folder}"/>
											<f:param name="group_id" value="#{groupDetailBean.groupId}" />
										</p:commandLink>
				            		</h:form>
				    			</div>
				    			
				    		</div>
	       				</h:panelGroup>
				    </ui:repeat>				    
			    </h:panelGroup>
			    
			    <h:panelGroup id="resourceGrid" styleClass="resource-grid" pt:data-selectedResourceId="#{groupDetailBean.selectedResource.id}" layout="block">				
				    <ui:repeat value="#{groupDetailBean.paginator.currentPage}" var="res">
				    	<h:panelGroup styleClass="resource-item group-resources-item" pt:data-type="resource" pt:data-resourceId="#{res.resource.id}" layout="block">
				    		<div class="resource-block">
				    		
				    			<div class="resource-preview">
				    				<div class="resource-preview-wrapper">
				    					<div class="resource-preview-wrapper2">
				    						<div class="resource-preview-block"></div>
				    						<div class="resource-preview-block2"></div>
				    						<h:graphicImage styleClass="resource-preview-image" value="#{res.thumbnail1.url}" rendered="#{not empty res.thumbnail1}" alt="#{res.title}" />
			    							<h:outputText styleClass="resource-preview-empty" escape="false" value='#{res.resource.embeddedSize1.replaceAll("width=\".*\"","").replaceAll("height=\".*\"","").replaceAll("/>","").replaceAll(">","").concat(" width=\"150\" height=\"150\" />")}' rendered="#{empty res.thumbnail1}"/>
			    						</div>
	    							</div>
	    							
	    							<h:form class="resource-controls">
				            			<p:commandLink oncomplete="PF('resource_dialog').show()" title="#{msg.addToMyResources}" 
				            				update=":resource_form" styleClass="resource-controls-button" process="@this">
											<h:graphicImage alt="Add" value="/resources/icon/Add.png"/>
											<f:setPropertyActionListener value="#{res.resource}" target="#{groupDetailBean.clickedResource}" />
											<f:param name="group_id" value="#{groupDetailBean.groupId}" />
										</p:commandLink>
										
										<p:commandLink title="#{msg.edit}"
											update=":add_resource_panel" styleClass="resource-controls-button"
											rendered="${groupDetailBean.canDeleteResourceFromGroup(res)}">
											<h:graphicImage alt="Edit" value="../resources/icon/Edit.png"/>
												<f:setPropertyActionListener value="#{res.resource}" 
													target="#{groupDetailBean.clickedResource}" />
												<f:setPropertyActionListener target="#{groupDetailBean.rightPanelAction}" value="editResource"/>
											<f:param name="group_id" value="#{groupDetailBean.groupId}" />
										</p:commandLink>
										
										<p:commandLink title="#{msg.move_to}" oncomplete="PF('resource_move_dialog').show();" 
											update=":resource_form" styleClass="resource-controls-button"
											rendered="#{userBean.isModerator() and false}">
											<h:graphicImage value="/resources/icon/silk/delete.png" width="16" height="16" 
												title="#{msg.move_to}" style="padding: 3px;"/> 
											<f:setPropertyActionListener value="#{res.resource}" target="#{searchBean.selectedResource}" />
											<f:param name="group_id" value="#{groupDetailBean2.groupId}" /> 
										</p:commandLink>
										
										<p:commandLink oncomplete="PF('confirmation').show();" title="#{msg.removeFromGroup}" 
				            				update=":confirm_dialog_form" styleClass="resource-controls-button"
				            				rendered="${groupDetailBean.canDeleteResourceFromGroup(res)}">
											<h:graphicImage alt="Remove" value="../resources/icon/Remove.png"/>
											
											<f:setPropertyActionListener value="#{res.resource}" target="#{groupDetailBean.clickedResource}" />
											<f:param name="group_id" value="#{groupDetailBean.groupId}" />
										</p:commandLink>
				            		</h:form>
				    			</div>
				    			
				    			<div class="resource-title">
			    					<div class="resource-title-wrapper">
		    							<div class="resource-title-icon">
		    								<div class="resource-title-icon-wrapper">
		    									<img src="//ssl.gstatic.com/docs/doclist/images/mediatype/icon_1_image_x16.png" alt="Compressed Archive" />
	    									</div>
    									</div>
   										<div class="resource-title-text">
   											<h:outputText value="#{res.title}" escape="false" styleClass="resource-title-name" title="#{res.title}" />
   											<span class="resource-title-summary"><span>${learnwebBean.getLocaleMessage(res.type)}</span> #{msg.added_by} <span>#{res.addedToGroupBy.username}</span></span>
										</div>
									</div>
				    			</div>
				    			
				    		</div>
	       				</h:panelGroup>
				    </ui:repeat>				    
			    </h:panelGroup>
					
				<h:outputText value="${msg.no_resources_found}" class="nothing_found"
					rendered="#{groupDetailBean.paginator.isEmpty() and groupDetailBean.paginator.getClass().getSimpleName() eq 'GroupPaginator'}"/>

				<h:outputText value="#{msg.no_results_found}" class="nothing_found" 
					rendered="#{groupDetailBean.paginator.isEmpty() and groupDetailBean.paginator.getClass().getSimpleName() eq 'SearchPaginator'}"/>
				    
			</h:panelGroup>
		
			<h:panelGroup id="paginator" layout="block">
				<ui:decorate template="/lw/templates/paging.xhtml">
					<ui:param name="paginator" value="${groupDetailBean.paginator}" />
				</ui:decorate>
			</h:panelGroup>
			
				<script type="text/javascript">
			/* <!-- */
				$("#center_pane").append($("#paginator"));
			/* --> */
			</script>
			
		</ui:define>
		<ui:define name="right_layout">
			<ui:decorate  template="/lw/templates/right_pane.xhtml">
				<ui:param name="bean" value="#{groupDetailBean}" />
			</ui:decorate >
		</ui:define>
</ui:composition>