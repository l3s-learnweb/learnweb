<ui:composition template="/lw/templates/new_main_t.xhtml" 
	xmlns:ui="http://java.sun.com/jsf/facelets" 
	xmlns:h="http://java.sun.com/jsf/html" 
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

	<ui:param name="helpText" value="#{msg.groupResourceHelp}"/>
	
	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="group_id" value="#{groupDetailBean.groupId}" />
			<f:viewParam name="folder_id" value="#{groupDetailBean.selectedFolderId}" />
			<f:viewParam name="resource_id" value="#{resourceDetailBean.resourceId}" />
			<f:event type="javax.faces.event.PreRenderViewEvent" listener="#{groupDetailBean.preRenderView}" />
			<f:event type="javax.faces.event.PreRenderViewEvent" listener="#{resourceDetailBean.preRenderView}" /> 
		</f:metadata>
	</ui:define>	

	<ui:param name="loginRequired" value="true" />
	<ui:param name="pageTitle" value="#{msg.group} - #{msg.resources}" />
	  
		<ui:define name="center_layout">
	
			<div class="center-header" id="group_header">
				<span id="green-header">
					#{msg.resources}
				</span> 
				<span id="of_group">
					#{msg.of} 
				</span>
				<span id="group_name">
					#{groupDetailBean.group.title}
				</span>
				(#{groupDetailBean.group.resourcesCount} resources)				
				<h:form id="center_header_form">
					<p:commandButton rendered="#{groupDetailBean.member and !groupDetailBean.group.restrictionOnlyLeaderCanAddResources}" styleClass="resource_button greenbutton resourcetoolbutton" 
						value="#{msg.upload_resource}" update=":add_resource_panel" oncomplete="update_header()">
						<f:setPropertyActionListener target="#{addResourceBean.resourceTargetGroupId}" value="#{groupDetailBean.groupId}"/>
						<f:setPropertyActionListener target="#{addResourceBean.resourceTargetFolderId}" value="#{groupDetailBean.selectedFolderId}"/>
						<f:setPropertyActionListener target="#{groupDetailBean.rightPanelAction}" value="newResource"/>
					</p:commandButton>
				
					<p:commandLink rendered="#{not groupDetailBean.member}" action="#{groupsBean.joinGroup}" 
						styleClass="resource_button greenbutton" update=":growl :group_menu @form" partialSubmit="true" 
						process="@this" value="#{msg.join_group}">
						<f:setPropertyActionListener target="#{groupsBean.selectedGroup}" value="#{groupDetailBean.group}" />
					</p:commandLink>
					
					<p:remoteCommand name="moveToFolder" actionListener="#{groupDetailBean.moveToFolder}" update=":group_menu_tree :folderGrid :resourceGrid" oncomplete="resourceDND()"/>
				</h:form>
				
				<ul>								
					<li>
						<a href="./group/overview.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.overview}" />
						</a>
					</li>								
					<li>
						<a class="active" href="./group/resources.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.resources}" />
						</a>
					</li>								
					<li>
						<a href="./group/members.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.members}" />
						</a>
					</li>								
					<li>
						<a href="./group/presentations.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.presentations}" />
						</a>
					</li>								
					<li>
						<a href="./group/links.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.links}" />
						</a>
					</li>
					<li>
						<a href="./group/forum.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.forum}" />
						</a>
					</li>
					<ui:fragment rendered="${userBean.admin || userBean.moderator || groupDetailBean.group.isLeader(userBean.user)}">							
					<li>
						<a href="./group/options.jsf?group_id=#{groupDetailBean.group.id}">
							<h:outputText value="#{msg.options}" />
						</a>
					</li>
					</ui:fragment>
					<li>
						<img alt="" src="#{request.contextPath}/resources/main-template/img/search.png" height="16" width="16" 
							id="search_group_resource" style="padding:3px 15px;cursor:pointer"/>
					
						<h:form id="header_query_form" prependId="false">
							<h:inputText value="#{groupDetailBean.query}" id="input_query_form" />

							<p:commandButton actionListener="${groupDetailBean.onQueryChange()}" partialSubmit="true" 
								oncomplete="resetCenterPaneHeight(); $('#center_pane .content').scrollTop(0);" process="@form" 
								update=":datagrid :paginator" value="" id="group_resource_searchbutton"/>
						</h:form>
					</li>
				</ul>
				
				<h:form styleClass="resources-filters" id="filters">
					<ul>
						<ui:repeat value="#{groupDetailBean.availableFilters}" var="filter">
							<li class="filter #{filter.disabled ? 'disabled' : (filter.active ? 'active' : null)}">
								<span class="filter-name">
									<span class="trimmed-text">#{filter.name}</span>
									<span class="arrow"></span>
								</span>
								<ul class="filter-sub-bar">
									<li class="#{!filter.active ? 'active' : null}">
										<p:commandButton value="#{filter.anyText}" action="#{groupDetailBean.changeFilters(filter.anyUrl)}" update=":datagrid :paginator :filters"/>
									</li>
									
									<ui:repeat value="#{filter.items}" var="item">
										<li class="#{item.active ? 'active' : null}">
											<p:commandButton value="#{item.name} #{item.counter != null ? '('.concat(item.counter).concat(')') : null}" action="#{groupDetailBean.changeFilters(item.url)}" update=":datagrid :paginator :filters"/>
										</li>
									</ui:repeat>
								</ul>
							</li>
						</ui:repeat>
						<h:panelGroup rendered="#{groupDetailBean.searchFilters != null}">
							<li class="filter clear-filters">
								<p:commandButton value="#{msg.clear_filters}" action="#{groupDetailBean.changeFilters(null)}" update=":datagrid :paginator :filters"/>
							</li>
						</h:panelGroup>
					</ul>
				</h:form>
				
				<script type="text/javascript">
					function resetCenterPaneHeight()
					{/*
						console.log(
						$('#center_pane').height(),
						$('#group_header').outerHeight(true),
						$('#paginator').outerHeight(true),
						$('#center_pane > .ui-layout-unit-content').height());
						var height = $('#center_pane').height() - $('#group_header').outerHeight(true) - $('#paginator').outerHeight(true);
						$('#center_pane > .ui-layout-unit-content').height(height);
						*/
					}
				
					$("#header_query_form").css("display","none");
					
					$("#search_group_resource").click(function () {
				          $("#header_query_form").animate({ width: "toggle" }, 500, 'swing', function() {
				        	 // resetCenterPaneHeight();
					          //console.log('fertig');
					        });
				          $("#input_query_form").focus();
				          $("#search_group_resource").hide();
				    });
				</script>				
			</div>			
			<br />
	
			<script type="text/javascript">
			/* <!-- */
				$("#center_pane").prepend($("#group_header"));
			/* --> */
			</script>
				
			<p:dialog id="confirmDialog" header="#{msg.delete_resource_title}"  widgetVar="confirmation" appendTo="@(body)" >
		        
		        <h:form prependId="false" id="confirm_dialog_form">
			        <p>
			        	<h:outputText value="#{msg.theResource}"/>
			        	<b> 
			        		<h:outputText value="#{groupDetailBean.clickedResource.title}" escape="false" /> 
			        	</b> 
			        	<h:outputText value=" #{msg.part_of}:"/>
			        </p>
			        <ul>
				        <li>
				        		<h:outputText value="#{msg.the_group_genitive} " />
					        	<h:outputLink value="group/overview.jsf?group_id=#{groupDetailBean.clickedResource.group.id}">
					        		<h:outputText value="#{groupDetailBean.clickedResource.group.title}" />
					        	</h:outputLink>
				        	</li>
				        <li> 
				        	<h:outputText value="#{msg.private_resource} "/>
				         	<h:outputText value=" #{groupDetailBean.clickedResource.ownerUser.username}"/>
				         </li>
			        </ul>
			        <p:commandButton value="#{msg.delete_from_group} '#{groupDetailBean.group.title}'" 
			        	update=":resourceGrid :growl :add_resource_panel"  oncomplete="PF('confirmation').hide(); update_header();" 
			        	actionListener="#{groupDetailBean.removeResourceFromGroup}" process=":resourceGrid" 
			        	style="display:block; margin: 10px 0;"/> 
			        		   			
		   			<p:commandButton value="#{msg.delete_resource_completely}" update=":resourceGrid :growl :add_resource_panel" 
		   				oncomplete="PF('confirmation').hide(); update_header();" actionListener="#{groupDetailBean.deleteResource}" 
		   				process=":resourceGrid" style="display:block; margin: 10px 0;"
		   				rendered="${groupDetailBean.canDeleteResourceCompletely(groupDetailBean.clickedResource)}"/>  
		        </h:form>
		    </p:dialog>
		    
		    <p:dialog id="confirmFolderDialog" header="#{msg.delete_folder_title}"  widgetVar="confirmationFolder" appendTo="@(body)" >
		        
		        <h:form prependId="false" id="confirm_folder_dialog_form">
			        <p> 
				        <h:outputFormat value="#{msg.delete_folder_description}" escape="false">
						  <f:param value="#{groupDetailBean.clickedFolder.name}"/>
						  <f:param value="#{groupDetailBean.clickedFolder.countResources}"/>
						  <f:param value="#{groupDetailBean.clickedFolder.countSubfolders}"/>
						</h:outputFormat>
			        </p>
			        <p><h:outputFormat value="#{msg.delete_folder_confirm_message}"/></p>
			        		   		
			       	<h:panelGrid columns="2" styleClass="float-right" style="margin: 10px 0;">
			   			<p:commandButton styleClass="graybutton" value="#{msg.delete_cancel_btn}" onclick="PF('confirmationFolder').hide(); return false;"/>
			   			
			   			<p:commandButton styleClass="greenbutton" value="#{msg.delete_folder_btn}" update=":group_menu_tree :folderGrid :growl :add_resource_panel" 
			   				oncomplete="PF('confirmationFolder').hide(); update_header();" actionListener="#{groupDetailBean.deleteFolder}" 
			   				process=":folderGrid" rendered="${groupDetailBean.canEditFoldersInGroup()}"/>
		   			</h:panelGrid>
		        </h:form>
		    </p:dialog>
			
			<p:dialog header="#{msg.upload_file}" widgetVar="file_dialog" modal="true" appendTo="@(body)" width="600" height="150">
				<h:form>
					<p:fileUpload rendered="true" fileUploadListener="#{addResourceBean.handleFileUpload}" mode="advanced" 
						auto="true" sizeLimit="10000000" widgetVar="fileUpload" oncomplete="PF('file_dialog').hide()" 
						update=":add_resource_form:preview" label="#{msg.choose_file}" cancelLabel="abb"/> 
				</h:form>
			</p:dialog>
			<p:dialog header="#{msg.edit}" id="comment_dialog1" modal="true" minWidth="440" appendTo="@(body)" widgetVar="comment_dialog">
				<h:form id="comment_dialog_form">	
					<p:inputTextarea autoResize="1" maxHeight="20" value="#{resourceDetailBean.clickedComment.text}" id="edit_comment_textbox"/>
					<p:commandButton actionListener="#{resourceDetailBean.onEditComment}" update=":add_resource_panel" title="#{msg.save}" 
						value="#{msg.save}"	onsuccess="PF('comment_dialog').hide();"/>
				</h:form>
			</p:dialog>
			<p:dialog header="#{msg.options}" closable="false" widgetVar="resource_dialog" appendTo="@(body)" modal="true" minWidth="540">
				<h:form id="resource_form">
					<h:panelGrid columns="2">
						<h:outputText value="#{msg.add_to}:" />
						<p:tree id="folders_tree" value="#{userBean.writeAbleGroupsTree}" var="node" animate="true" dynamic="true" selectionMode="single" selection="#{groupDetailBean.selectedTargetNode}" style="max-height:28rem; overflow:auto;">				        						     						        
					        <p:ajax event="select" listener="#{groupDetailBean.onTargetNodeSelect}"/>
					        
					        <p:treeNode type="group">
					        	<h:outputText id="group" value="#{node.title}"/>
					        </p:treeNode>
					        
					        <p:treeNode type="folder" expandedIcon="ui-icon-folder-open" collapsedIcon="ui-icon-folder-collapsed">
						        <h:outputText value="#{node.name}" />
					        </p:treeNode>
					    </p:tree>
	
						<h:outputText value="#{msg.title}:" />
						<p:inputText value="#{groupDetailBean.clickedResource.title}" styleClass="resource_dialog_field" />
	
						<h:outputText value="#{msg.description}:" />
						<p:inputTextarea value="#{groupDetailBean.clickedResource.description}" autoResize="true" 
							styleClass="resource_dialog_field"/>
	
						<h:outputText value="Url:" />
						<p:inputText value="#{groupDetailBean.clickedResource.url}" disabled="true" styleClass="resource_dialog_field" />
	
						<h:outputText value="#{msg.type}:" />
						<p:inputText value="#{groupDetailBean.clickedResource.type}" disabled="true" styleClass="resource_dialog_field" />
	
						<h:outputText value="#{msg.author}:" />
						<p:inputText value="#{groupDetailBean.clickedResource.author}" styleClass="resource_dialog_field" />
						
						<h:outputText value="" />
						<h:panelGroup colspan="2" styleClass="float-right" style="margin: 10px 0;">
							<p:commandButton styleClass="graybutton" value="#{msg.cancel}" onclick="PF('resource_dialog').hide(); return false;" />
							
							<p:commandButton styleClass="greenbutton" value="#{msg.save}" action="#{groupDetailBean.addSelectedResource}" 
								update=":resourceGrid :growl" process="@form :resourceGrid" oncomplete="PF('resource_dialog').hide()" />
						</h:panelGroup>
						
					</h:panelGrid>
				</h:form>
			</p:dialog>
			
			<h:panelGroup id="datagrid" styleClass="datagrid" layout="block" pt:data-isEnableMoving="#{groupDetailBean.canMoveResourcesInGroup()}">
				<h:panelGroup id="folderGrid" layout="block" pt:data-selectedFolderId="#{groupDetailBean.selectedFolderId}">				
				    <ui:repeat var="folder" value="#{groupDetailBean.subfolders}"> 			     
				  		<h:form styleClass="resource_panel resource_folder grey_border" pt:data-folderId="#{folder.folderId}">
					        <p:commandLink styleClass="resource_command_link" update=":group_menu_tree :datagrid :paginator :filters :add_resource_panel" oncomplete="update_header();update_url(0, #{folder.folderId});resourceDND();">
	       						<f:setPropertyActionListener target="#{groupDetailBean.clickedFolder}" value="#{folder}" />
	       	
					        	<h:outputText value="#{folder.name}" escape="false" styleClass="resource_short_title" /> 
					             
					            <div class="resource_panelgrid folder_control">
					            	<span class="groupid">#{folder.folderId}</span>
	
				            		<div class="buttons">
				            			<p:commandLink title="#{msg.edit}" rendered="${groupDetailBean.canEditFoldersInGroup()}" update=":add_resource_panel" oncomplete="update_header();" styleClass="buttons_link">
											<h:graphicImage alt="Edit" value="../resources/icon/Edit.png"/>
											<f:setPropertyActionListener target="#{groupDetailBean.clickedFolder}" value="#{folder}"/>
											<f:setPropertyActionListener target="#{groupDetailBean.rightPanelAction}" value="editFolder"/>
											<f:param name="group_id" value="#{groupDetailBean.groupId}" />
										</p:commandLink>
										
										<p:commandLink oncomplete="PF('confirmationFolder').show();" title="#{msg.delete}" update=":confirm_folder_dialog_form" rendered="${groupDetailBean.canEditFoldersInGroup()}" styleClass="buttons_link">
											<h:graphicImage alt="Remove" value="../resources/icon/Remove.png"/>
											<f:setPropertyActionListener target="#{groupDetailBean.clickedFolder}" value="#{folder}"/>
											<f:param name="group_id" value="#{groupDetailBean.groupId}" />
										</p:commandLink>
				            		</div>
					            </div> 					            
						    </p:commandLink>
					    </h:form>
				    </ui:repeat>
				    
			    </h:panelGroup>
							
				<h:panelGroup id="resourceGrid" layout="block" pt:data-selectedResourceId="#{groupDetailBean.selectedResource.id}">				
				    <ui:repeat var="result" value="#{groupDetailBean.paginator.currentPage}"> 			     
				  		<h:form styleClass="resource_panel grey_border" pt:data-resourceId="#{result.resource.id}">
						    <p:commandLink styleClass="resource_command_link" update=":add_resource_panel" oncomplete="update_header();update_url(#{result.resource.id});resourceDND();">
	
					        	<f:setPropertyActionListener target="#{groupDetailBean.clickedResource}" value="#{result.resource}" />
					        	<f:setPropertyActionListener target="#{resourceDetailBean.clickedResource}" value="#{result.resource}" />
	       	
						        	<h:outputText value="#{result.title}" escape="false" styleClass="resource_short_title" /> 
						             
						            <h:panelGrid styleClass="resource_panelgrid" columns="1">
						            	<p:row>
						            		<span class="groupid">
						            			#{result.id}
						            		</span>
		
											<h:graphicImage styleClass="resource_thumbnail" width="#{result.thumbnail1.width}" 
												height="#{result.thumbnail1.height}" value="#{result.thumbnail1.url}" 
												rendered="#{not empty result.thumbnail1}" alt="#{result.title}" />
								    		<h:outputText styleClass="resource_thumbnail" escape="false" 
								    			 value='#{result.resource.embeddedSize1.replaceAll("width=\".*\"","").replaceAll("height=\".*\"","").replaceAll("/>","").replaceAll(">","").concat(" width=\"150\" height=\"150\" />")}' 
								    			 rendered="#{empty result.thumbnail1}"/>
		
						            		<div class="buttons">
						            			<p:commandLink oncomplete="PF('resource_dialog').show()" title="#{msg.addToMyResources}" 
						            				update=":resource_form" styleClass="buttons_link" process="@this"> <!-- resource_commandlink -->
													<h:graphicImage alt="Add" value="/resources/icon/Add.png"/>
													<f:setPropertyActionListener value="#{result.resource}" target="#{groupDetailBean.clickedResource}" />
													<f:param name="group_id" value="#{groupDetailBean.groupId}" />
												</p:commandLink>
						            			
						            			<p:commandLink oncomplete="PF('confirmation').show();" title="#{msg.removeFromGroup}" 
						            				rendered="${groupDetailBean.canDeleteResourceFromGroup(result)}" 
						            				styleClass="buttons_link" update=":confirm_dialog_form">
													<h:graphicImage alt="Remove" value="../resources/icon/Remove.png"/>
													
													<f:setPropertyActionListener value="#{result.resource}" target="#{groupDetailBean.clickedResource}" />
													<f:param name="group_id" value="#{groupDetailBean.groupId}" />
												</p:commandLink>
												
												<p:commandLink title="#{msg.edit}" 
													rendered="${groupDetailBean.canDeleteResourceFromGroup(result)}" 
													update=":add_resource_panel" 
													styleClass="buttons_link">
													<h:graphicImage alt="Edit" value="../resources/icon/Edit.png"/>
														<f:setPropertyActionListener value="#{result.resource}" 
															target="#{groupDetailBean.clickedResource}" />
														<f:setPropertyActionListener target="#{groupDetailBean.rightPanelAction}" value="editResource"/>
													<f:param name="group_id" value="#{groupDetailBean.groupId}" />
												</p:commandLink>
												
												<p:commandLink update=":resource_form" oncomplete="PF('resource_move_dialog').show();" 
													title="#{msg.move_to}" rendered="#{userBean.isModerator() and false}" >
													<h:graphicImage value="/resources/icon/silk/delete.png" width="16" height="16" 
														title="#{msg.move_to}" style="padding: 3px;"/> 
													<f:setPropertyActionListener value="#{result.resource}" target="#{searchBean.selectedResource}" />
													<f:param name="group_id" value="#{groupDetailBean2.groupId}" /> 
												</p:commandLink>
						            		</div>
						            	</p:row>
						            	
						            	<div class="resource_summary">
											<span>
												${learnwebBean.getLocaleMessage(result.type)}
											</span> 
											#{msg.added_by} 
											<span>
												#{result.addedToGroupBy.username}
											</span>
								        </div>					            
							          
						            </h:panelGrid>  					            
						    </p:commandLink>
					    </h:form>
				    </ui:repeat>
						
					<h:outputText value="${msg.no_resources_found}" class="nothing_found"
						rendered="#{groupDetailBean.paginator.isEmpty() and groupDetailBean.paginator.getClass().getSimpleName() eq 'GroupPaginator'}"/>
	
					<h:outputText value="#{msg.no_results_found}" class="nothing_found" 
						rendered="#{groupDetailBean.paginator.isEmpty() and groupDetailBean.paginator.getClass().getSimpleName() eq 'SearchPaginator'}"/>
				    
			    </h:panelGroup>
			</h:panelGroup>
		
			<h:panelGroup id="paginator" layout="block">
				<ui:decorate template="/lw/templates/paging.xhtml">
					<ui:param name="paginator" value="${groupDetailBean.paginator}" />
				</ui:decorate>
			</h:panelGroup>
			
				<script type="text/javascript">
			/* <!-- */
				$("#center_pane").append($("#paginator"));
			/* --> */
			</script>
			
		</ui:define>
		<ui:define name="right_layout">
			<ui:decorate  template="/lw/templates/right_pane.xhtml">
				<ui:param name="bean" value="#{groupDetailBean}" />
			</ui:decorate >
		</ui:define>
</ui:composition>