<ui:composition template="/WEB-INF/templates/layout/template.xhtml"
				xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
				xmlns:h="http://xmlns.jcp.org/jsf/html"
				xmlns:f="http://xmlns.jcp.org/jsf/core"
				xmlns:p="http://primefaces.org/ui">

	<ui:param name="helpText" value="#{msg.groupLinkHelp}"/>
	<ui:define name="head-meta">
		<meta name="google-signin-client_id" content="948054065586-oh9uobccisi7lkt832q9n2hmk4mk410s.apps.googleusercontent.com" />
		<script src="https://apis.google.com/js/platform.js" async="async" defer="defer"></script>
	</ui:define>
	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam name="group_id" value="#{groupLinksBean.groupId}" />
			<f:viewAction action="#{groupLinksBean.onLoad}"/>
		</f:metadata>
	</ui:define>			

	<ui:param name="loginRequired" value="true" />
	<ui:param name="pageTitle" value="#{groupLinksBean.group.title}" />

	<ui:define name="center_layout">
		<script type="text/javascript">
			var googleSignInEnabled = parseInt('#{groupLinksBean.group.googleDocsSignInEnabled}');
		</script>
		<ui:decorate template="/templates/group/menu.xhtml">
			<ui:param name="group" value="#{groupLinksBean.group}" />
			<ui:param name="active" value="links" />

			<ui:define name="title">
				<h2>
					#{msg.links}
				</h2>
				#{msg.of} #{groupLinksBean.group.title}

				<h:form id="center_header_form">
					<p:commandLink rendered="#{not groupLinksBean.member}"
						action="#{groupsBean.joinGroup}"
						styleClass="resource_button greenbutton"
						update=":growl :group_menu @form" partialSubmit="true"
						process="@this" value="#{msg.join_group}">
						<f:setPropertyActionListener target="#{groupsBean.selectedGroup}"
							value="#{groupLinksBean.group}" />
					</p:commandLink>
				</h:form>
			</ui:define>
		</ui:decorate>
		
		<script type="text/javascript">
		/* <!-- */
			$("#center_pane").prepend($("#group_header"));
		/* --> */
		</script>
		
		<p:dialog appendTo="@(body)" header="#{msg.edit}" widgetVar="link_dialog" modal="true" minWidth="540" styleClass="zindex10000">
			<h:form id="link_edit_form">
				<h:panelGrid columns="2" rendered="#{groupLinksBean.selectedLink != null}">
					<h:outputLabel value="#{msg.title}:" for="link_title_edit"/>
					<p:inputText value="#{groupLinksBean.selectedLink.title}" id="link_title_edit" styleClass="links_input" />
					
					<h:outputText value="" />
					<p:commandButton value="#{msg.save}" ajax="true" actionListener="#{groupLinksBean.onEditLink}"
						process="@form" oncomplete="PF('link_dialog').hide();" update=":message :grouplinks">
						<f:setPropertyActionListener target="#{groupLinksBean.editLink}" value="#{groupLinksBean.selectedLink}" />
						<f:param name="group_id" value="#{groupLinksBean.group.id}"/>
					</p:commandButton>
				</h:panelGrid>
			</h:form>						
		</p:dialog>	

		
		<h:panelGroup id="grouplinks" layout="block" style="padding-right:5px;">		

			<ui:fragment rendered="${empty groupLinksBean.links or empty groupLinksBean.documentLinks}">
			No links have been added.
			</ui:fragment>	
					
			<h:panelGroup rendered="${not empty groupLinksBean.links}">
				<h:form styleClass="links_form">		
					<h4 class="clear">
						<h:outputText value="#{msg.links}:" />
					</h4>
				
					<br class="clear"/>
					<p:dataList var="link" value="${groupLinksBean.links}" styleClass="links_datalist">
						<p:column>
							<h:outputLink value="#{link.url}" target="_blank" styleClass="links_output">
								#{link.title}
							</h:outputLink>	
						
							<p:commandLink update=":link_edit_form" oncomplete="PF('link_dialog').show();" title="#{msg.edit}" 
								process="@this" styleClass="links_commandlink" 
								rendered="${link.id != -1 and (userBean.moderator || groupLinksBean.group.isMember(userBean.user))}">
								<i class="fa fa-pencil text-warning" aria-hidden="true"></i>
								<f:setPropertyActionListener value="#{link}" target="#{groupLinksBean.selectedLink}" />
								<f:param name="group_id" value="#{groupLinksBean.groupId}" />
							</p:commandLink> 
							
							<p:commandLink actionListener="#{groupLinksBean.onDeleteLinkFromGroup(link.id)}" update=":message :grouplinks"
								title="#{msg.delete}" 
								onstart="return confirm('#{utilBean.getLocaleMessage('link_delete_question', link.title)}');"
								rendered="${(userBean.moderator || groupLinksBean.group.isLeader(userBean.user))}">
								<f:param name="group_id" value="#{groupLinksBean.group.id}"/>
								<i class="fa fa-trash text-danger" aria-hidden="true"></i>
							</p:commandLink>
						</p:column>
					</p:dataList>
				</h:form>
			</h:panelGroup>
				
			<h:panelGroup rendered="${not empty groupLinksBean.documentLinks}">
				<h:form styleClass="links_form">				
					<h4 class="clear">
						<h:outputText value="#{msg.documents}" />:
					</h4>
					<p:dataList var="link" value="${groupLinksBean.documentLinks}" styleClass="links_datalist">
						<p:column>
							<h:outputLink value="#{link.url}" target="_blank" styleClass="links_output" onclick="return onLinkClick(this);">
								#{link.title}
							</h:outputLink>	
							
							<p:commandLink update=":link_edit_form" oncomplete="PF('link_dialog').show();" title="#{msg.edit}" 
								process="@this" styleClass="links_commandlink" 
								rendered="${link.id != -1 and (userBean.moderator || groupLinksBean.group.isMember(userBean.user))}">
								<i class="fa fa-pencil text-warning" aria-hidden="true"></i>
								<f:setPropertyActionListener value="#{link}" target="#{groupLinksBean.selectedLink}" />
								<f:param name="group_id" value="#{groupLinksBean.groupId}" />
							</p:commandLink>
									
							<p:commandLink actionListener="#{groupLinksBean.onDeleteLinkFromGroup(link.id)}" update=":message :grouplinks"
								title="#{msg.delete}" 
								onstart="return confirm('#{utilBean.getLocaleMessage('link_delete_question', link.title)}');"
								rendered="${link.id != -1 and (userBean.moderator || groupLinksBean.group.isLeader(userBean.user))}">
								<f:param name="group_id" value="#{groupLinksBean.group.id}"/>
								<i class="fa fa-trash text-danger" aria-hidden="true"></i>
							</p:commandLink>
						</p:column>
					</p:dataList>
				</h:form>			
			</h:panelGroup>
		</h:panelGroup>

		<p:panel toggleable="true" header="#{msg.options}" rendered="${groupLinksBean.group.isMember(userBean.user)}"
			styleClass="clear links_panel" style="margin-top:20px; margin-right:5px;">
			<h:form id="link_form">
				<h:panelGrid columns="3">					
							
					<h:outputLabel value="#{msg.type}:" for="link_type" />
					<h:selectOneMenu value="#{groupLinksBean.newLinkType}" id="link_type">
						<f:selectItem itemValue="document" itemLabel="Google Document (Word)" />
						<f:selectItem itemValue="spreadsheet" itemLabel="Google Spreadsheet (Excel)" />
						<f:selectItem itemValue="presentation" itemLabel="Google Presentation (PowerPoint)" />
						<f:selectItem itemValue="url" itemLabel="#{msg.website}"  />	 
						<p:ajax process="@this" update="urlpanel1 urlpanel2 urlpanel3" />
						<f:param name="group_id" value="#{groupLinksBean.group.id}"/>
					</h:selectOneMenu>
					<h:outputText value="" />					
					
					<h:panelGroup id="urlpanel1">
						<h:outputLabel rendered="#{groupLinksBean.newLinkType == 'url'}" for="link_url" value="URL:" />
					</h:panelGroup>
					<h:panelGroup id="urlpanel2">
						<p:inputText rendered="#{groupLinksBean.newLinkType == 'url'}" styleClass="links_inputtext"
							id="link_url" value="#{groupLinksBean.newLinkUrl}" />
					</h:panelGroup>
					<h:panelGroup id="urlpanel3">
						<p:message rendered="#{groupLinksBean.newLinkType == 'url'}" showSummary="true" showDetail="false"
							styleClass="error" for="link_url" />
					</h:panelGroup>
					
						
					<h:outputLabel for="link_title" value="#{msg.title}:" />
					<p:inputText id="link_title" value="#{groupLinksBean.newLinkTitle}" styleClass="links_inputtext2"/>
					<p:message showSummary="true" showDetail="false" styleClass="error" for="link_title"/>
	
					<h:outputText value="" />
					<p:commandButton action="#{groupLinksBean.onAddLink}" ajax="true" value="#{msg.addLink}"
						process="@form" update=":grouplinks link_form :growl">					
						<f:param name="group_id" value="#{groupLinksBean.group.id}"/>
					</p:commandButton>
					<h:outputText value="" />
				</h:panelGrid>
			</h:form>
		</p:panel>
		
		<h:form style="display:none;">	
			<p:remoteCommand actionListener="${groupLinksBean.saveGmailId()}" name="saveGmailId" process="@this"/>
		</h:form>
<!--
		<script type="text/javascript">
			function onLinkClick(element) {
				if(googleSignInEnabled)
				{
					var googleAuthObj = gapi.auth2.getAuthInstance();
					googleAuthObj.signIn().then(
							function(success)
							{
								window.open(element.href, '_blank');
								onSignIn(googleAuthObj.currentUser.get());
							}
					);
				}
				else
					return true;
				return false;
			}

			function onSignIn(googleUser) {
				var profile = googleUser.getBasicProfile();
				saveGmailId([{name:'gmail_id', value:profile.getEmail()}]);
			}

			$(document).ready(function(){
				if(googleSignInEnabled)
				{
					gapi.load('auth2', function() {

						gapi.auth2.init(
								{
									fetch_basic_profile: true,
									scope:'https://www.googleapis.com/auth/plus.login'
								}).then(
								function (){
									console.log('init google sign in');
								});
					});

				}
			});
		</script>-->
	</ui:define>
</ui:composition>