<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:p="http://primefaces.org/ui"
      lang="#{userBean.localeCode}">

    <!--@elvariable id="pageTitle" type="java.lang.String"-->
    <!--@elvariable id="helpText" type="java.lang.String"-->
    <!--@elvariable id="extraPageClass" type="java.lang.String"-->

    <!--@elvariable id="hideGrowl" type="java.lang.Boolean"-->
    <!--@elvariable id="hideBreadcrumbs" type="java.lang.Boolean"-->
    <!--@elvariable id="hasAccessPermission" type="java.lang.Boolean"-->
    <!--@elvariable id="hideContent" type="java.lang.Boolean"-->

    <f:view locale="#{userBean.locale}" contentType="text/html">
        <ui:insert name="metadata"/>

        <h:head>
            <ui:include src="parts/head.xhtml"/>
            <title><h:outputText value="#{pageTitle} - " escape="false" rendered="#{!empty pageTitle and not hideContent}"/>#{msg['application.name']}</title>

            <base href="#{request.contextPath}/lw/"/>

            <h:outputScript library="primefaces" name="jquery/jquery.js"/>
            <h:outputScript library="layout" name="js/layout.js"/>

            <ui:fragment rendered="#{userBean.trackingEnabled}">
                <script>
                    window.wapsTrackerData = {
                        start: new Date(),
                        apiKey: '#{learnwebBean.trackerApiKey}',
                        externalUserId: '#{userBean.getUser().getId()}'
                    };

                    // JSF is removing async attribute from script tag, therefore we need to use old-style loader
                    (function(d,s,u,e,n){e=d.createElement(s);
                      n=d.getElementsByTagName(s)[0];e.async=true;e.src=u;n.parentNode.insertBefore(e, n)
                    }(document,'script','https://learnweb.l3s.uni-hannover.de/tracker/js/init.js'));
                </script>
            </ui:fragment>
        </h:head>

        <h:body styleClass="layout-body ui-loading">
            <f:facet name="last">
                <h:outputStylesheet name="layout/css/styles.css"/>
            </f:facet>

            <ui:insert name="body_content">
                <div class="layout-wrapper #{userBean.loggedIn and not userBean.hideSidebarMenu ? null : 'layout-wrapper-sidebar-inactive'}">
                    <ui:include src="parts/header.xhtml"/>

                    <ui:fragment rendered="#{userBean.loggedIn}">
                        <ui:include src="parts/sidebar.xhtml"/>
                    </ui:fragment>

                    <div class="layout-main d-flex flex-column" id="main">
                        <main class="layout-main-content #{extraPageClass}">
                            <ui:fragment rendered="#{learnwebBean.maintenanceMode}">
                                <h2 class="text-danger">#{msg.service_unavailable}</h2>
                            </ui:fragment>
                            <ui:fragment rendered="#{not learnwebBean.maintenanceMode}">
                                <p:messages id="message" showDetail="false" showSummary="true" escape="false"/>
                                
                                <c:set var="accessDenied" value="#{not (hasAccessPermission == null ? userBean.loggedIn : hasAccessPermission)}" scope="request" />
                                
                                <h:panelGroup rendered="#{accessDenied and userBean.loggedIn and empty facesContext.messageList}" styleClass="ui-messages">
                                    <div class="ui-messages-fatal ui-corner-all"><span class="ui-messages-fatal-icon"></span><span class="ui-messages-fatal-summary">#{msg.access_denied}</span></div>
                                </h:panelGroup>
                                
                                <ui:fragment rendered="#{accessDenied and not userBean.loggedIn}">
                                    <p:panel header="#{msg.loginTitle}" styleClass="container mw-r30">
                                        <ui:include src="/WEB-INF/templates/blocks/user/login-form.xhtml"/>
                                    </p:panel>
                                </ui:fragment>

                                <ui:fragment rendered="#{not accessDenied and not hideContent}">
                                    <ui:fragment rendered="#{not hideBreadcrumbs}">
                                        <h:outputScript library="layout" name="js/breadcrumb.js" target="body"/>

                                        <div class="breadcrumb mb-3">
                                            <ui:insert name="breadcrumb"/>

                                            <div class="ml-auto">
                                                <ui:insert name="breadcrumb_right"/>
                                            </div>
                                        </div>
                                    </ui:fragment>

                                    <ui:insert name="center_layout"/>
                                </ui:fragment>
                            </ui:fragment>
                        </main>

                        <ui:include src="parts/footer.xhtml"/>
                    </div>
                </div>
            </ui:insert>

            <p:growl id="growl" rendered="#{not hideGrowl}" escape="false" life="4000"
                     showDetail="true" skipDetailIfEqualsSummary="true"/>

            <p:ajaxStatus styleClass="ajax-status-screen" delay="100">
                <f:facet name="start">
                    <div class="ui-blockui bg-center position-fixed" style="z-index: 1050 !important;"></div>
                </f:facet>
            </p:ajaxStatus>

            <h:form styleClass="d-none">
                <p:remoteCommand name="setPreferenceRemote" actionListener="#{userBean.setPreferenceRemote}" global="false" immediate="true"/>
            </h:form>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" header="#{msg.confirmation}" icon="ui-icon-alert">
                <p:commandButton value="#{msg.yes}" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check"/>
                <p:commandButton value="#{msg.no}" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close"/>
            </p:confirmDialog>
        </h:body>
    </f:view>
</html>
